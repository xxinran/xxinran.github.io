<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>cpuåŸºç¡€</title>
    <url>/posts/fe9b70.html</url>
    <content><![CDATA[<p>cpuè¿è¡Œé˜¶æ®µï¼šå–å€¼ï¼Œè§£ç ï¼Œæ‰§è¡Œï¼Œå†™å›ã€‚</p>
<p>cpuä»å†…å­˜æˆ–è€…cacheé‡Œæå–æŒ‡ä»¤ï¼Œæ”¾å…¥æŒ‡ä»¤å¯„å­˜å™¨ï¼Œå¹¶å¯¹æŒ‡ä»¤è¯‘ç ï¼Œæ‰§è¡Œã€‚</p>
<p>ä¸»è¦å‚æ•°ï¼š</p>
<p>ä¸»é¢‘ï¼šæ—¶é’Ÿé¢‘ç‡</p>
<p>å€é¢‘</p>
<p>å¤–é¢‘ï¼šcpuçš„åŸºå‡†é¢‘ç‡ï¼Œcpuå’Œå…¶ä»–éƒ¨ä»¶é€šè®¯çš„é¢‘ç‡ï¼Œå†³å®šç€æ•´å—ä¸»æ¿çš„è¿è¡Œé€Ÿåº¦ã€‚å› ä¸ºcpuçš„é¢‘ç‡å¤ªé«˜ï¼Œå…¶ä»–éƒ¨ä»¶è·Ÿä¸ä¸Šã€‚</p>
<p>è¶…é¢‘ï¼š</p>
]]></content>
  </entry>
  <entry>
    <title>cpu-microarch</title>
    <url>/posts/f1d93d2c.html</url>
    <content><![CDATA[<p><img src="https://en.wikichip.org/w/images/thumb/e/ee/skylake_server_block_diagram.svg/950px-skylake_server_block_diagram.svg.png" alt="skylake server block diagram.svg"></p>
<p>front endï¼šå–å€¼ï¼Œè§£ç </p>
<p>execution engineï¼šè®¡ç®—</p>
<p>memory subsystemï¼š è¯»å†™å†…å­˜</p>
<p>L1ï¼Œ L2 per core</p>
]]></content>
  </entry>
  <entry>
    <title>dapr-intro</title>
    <url>/posts/c02c2ddc.html</url>
    <content><![CDATA[<h2 id="daprç®€ä»‹"><a href="#daprç®€ä»‹" class="headerlink" title="daprç®€ä»‹"></a>daprç®€ä»‹</h2><h2 id="daprå®‰è£…"><a href="#daprå®‰è£…" class="headerlink" title="daprå®‰è£…"></a>daprå®‰è£…</h2><p>dapræ”¯æŒå¤šç§è¿è¡Œç¯å¢ƒï¼š</p>
<ol>
<li>åœ¨æœ¬æœºä¸Šï¼Œç›¸å½“äºä¸€ä¸ªprocess</li>
<li>åœ¨kubernetesä¸­ï¼Œå’Œä¸šåŠ¡å®¹å™¨åœ¨ä¸€ä¸ªpodé‡Œï¼Œä½œä¸ºsidecar</li>
</ol>
<p>æˆ‘ä»¬å…ˆå°è¯•åœ¨ç¬¬ä¸€ç§ç¯å¢ƒé‡Œå®‰è£…daprã€‚</p>
<h4 id="Prerequisites"><a href="#Prerequisites" class="headerlink" title="Prerequisites"></a>Prerequisites</h4><p>Docker installed</p>
<h4 id="å®‰è£…dapr-CLI"><a href="#å®‰è£…dapr-CLI" class="headerlink" title="å®‰è£…dapr CLI"></a>å®‰è£…dapr CLI</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> wget -q https://raw.githubusercontent.com/dapr/cli/master/install/install.sh -O - | /bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> verify</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> dapr --version</span></span><br></pre></td></tr></table></figure>
<h4 id="åˆå§‹åŒ–dapr"><a href="#åˆå§‹åŒ–dapr" class="headerlink" title="åˆå§‹åŒ–dapr"></a>åˆå§‹åŒ–dapr</h4><p>å› ä¸ºdapråœ¨hostä¸Šç›´æ¥è¿è¡Œï¼Œç›¸å½“äºéœ€è¦åœ¨hostä¸Šè¿è¡Œä¸€ä¸ªprocessã€‚æ‰€ä»¥daprçš„åˆå§‹åŒ–åŒ…æ‹¬ä¸‹è½½dapräºŒè¿›åˆ¶åŒ…å¹¶ä¸”å®‰è£…è¿è¡Œã€‚</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> dapr init</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> åœ¨k8sä¸Šè¿è¡Œ dapr init --kubernetes</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> verify</span> </span><br><span class="line"><span class="meta">$</span><span class="bash"> docker ps</span></span><br><span class="line">CONTAINER ID        IMAGE                                 COMMAND                  CREATED             STATUS                 PORTS                                                                                                                                  NAMES</span><br><span class="line">caa1ac7a14c4        openzipkin/zipkin                     &quot;start-zipkin&quot;           2 hours ago         Up 2 hours (healthy)   9410/tcp, 0.0.0.0:9411-&gt;9411/tcp                                                                                                       dapr_zipkin</span><br><span class="line">1fa7739631a3        redis                                 &quot;docker-entrypoint.sâ€¦&quot;   2 hours ago         Up 2 hours             0.0.0.0:6379-&gt;6379/tcp                                                                                                                 dapr_redis</span><br><span class="line">f48ee8e3d872        daprio/dapr                           &quot;./placement&quot;            2 hours ago         Up 2 hours             0.0.0.0:50005-&gt;50005/tcp                                                                                                               dapr_placement</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°æœ‰ä¸‰ä¸ªå®¹å™¨åœ¨è¿è¡Œï¼ŒRediså®¹å™¨æ˜¯åšstate managementå’Œmessagingçš„ï¼ŒZipkinå®¹å™¨æ˜¯ä¸ºäº†æ”¶é›†tracesçš„ã€‚</p>
<p>åœ¨<code>docker init</code>çš„æ—¶å€™ï¼ŒåŒæ—¶è¿˜åˆ›å»ºäº†ä¸€äº›æ–‡ä»¶ã€‚</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ls <span class="variable">$HOME</span>/.dapr</span></span><br><span class="line">bin/  components/  config.yaml</span><br></pre></td></tr></table></figure>


<h3 id="ä½¿ç”¨dapr-APIï¼Œrun-sample"><a href="#ä½¿ç”¨dapr-APIï¼Œrun-sample" class="headerlink" title="ä½¿ç”¨dapr APIï¼Œrun sample"></a>ä½¿ç”¨dapr APIï¼Œrun sample</h3><p>ä¸šåŠ¡ä»£ç é€šè¿‡è°ƒç”¨dapr APIæ¥å®Œæˆä¸€äº›ä¸šåŠ¡ä¹‹å¤–çš„åˆ†å¸ƒå¼æœåŠ¡çš„åŠŸèƒ½ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡ç›´æ¥è°ƒç”¨dapr APIæ¥çœ‹çœ‹dapr APIæ˜¯æ€ä¹ˆè¢«ä½¿ç”¨çš„ã€‚</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> dapr run --<span class="built_in">help</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Run a Python application that listens to port 3000:</span></span><br><span class="line">  dapr run --app-id myapp --app-port 3000 -- python myapp.py</span><br><span class="line"><span class="meta">#</span><span class="bash"> Run sidecar only:</span></span><br><span class="line">  dapr run --app-id myapp</span><br><span class="line"></span><br><span class="line">Flags:</span><br><span class="line"><span class="meta"> #</span><span class="bash"> éœ€è¦ç ”ç©¶è¿™ä¸ªapp-idæœ‰å•¥ç”¨ï¼Ÿï¼Ÿï¼Ÿ</span></span><br><span class="line">  -a, --app-id string                   The id for your application, used for service discovery</span><br><span class="line">      --app-max-concurrency int         The concurrency level of the application, otherwise is unlimited (default -1)</span><br><span class="line"><span class="meta"> #</span><span class="bash"> ä¸šåŠ¡ç¨‹åºç›‘å¬çš„ç«¯å£</span></span><br><span class="line">  -p, --app-port int                    The port your application is listening on (default -1)</span><br><span class="line"><span class="meta"> #</span><span class="bash"> daprå’Œappä¹‹é—´çš„protocol</span></span><br><span class="line">  -P, --app-protocol string             The protocol (gRPC or HTTP) Dapr uses to talk to the application (default &quot;http&quot;)</span><br><span class="line">      --app-ssl                         Enable https when Dapr invokes the application</span><br><span class="line">  -d, --components-path string          The path for components directory (default &quot;/home/ubuntu/.dapr/components&quot;)</span><br><span class="line"> -c, --config string                   Dapr configuration file (default &quot;/home/ubuntu/.dapr/config.yaml&quot;)</span><br><span class="line"><span class="meta"> #</span><span class="bash"> daprç¨‹åºç›‘å¬çš„ç«¯å£s</span></span><br><span class="line">  -G, --dapr-grpc-port int              The gRPC port for Dapr to listen on (default -1)</span><br><span class="line">  -H, --dapr-http-port int              The HTTP port for Dapr to listen on (default -1)</span><br><span class="line">      --enable-profiling                Enable pprof profiling via an HTTP endpoint</span><br><span class="line">  -h, --help                            Print this help message</span><br><span class="line">      --log-level string                The log verbosity. Valid values are: debug, info, warn, error, fatal, or panic (default &quot;info&quot;)</span><br><span class="line">  -M, --metrics-port int                The port of metrics on dapr (default -1)</span><br><span class="line">      --placement-host-address string   The host on which the placement service resides (default &quot;localhost&quot;)</span><br><span class="line">      --profile-port int                The port for the profile server to listen on (default -1)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> launch a Dapr sidecar that will listen on port 3500 <span class="keyword">for</span> a blank application named myapp</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> å› ä¸ºæ²¡æœ‰--configå’Œ-dï¼Œæ‰€ä»¥ç”¨çš„å°±æ˜¯defaultçš„`<span class="variable">$HOME</span>/.dapr`ä¸‹çš„é…ç½®æ–‡ä»¶ã€‚</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> dapr run --app-id myapp --dapr-http-port 3500</span></span><br></pre></td></tr></table></figure>
<p><strong>è°ƒç”¨dapr APIå»å†™stateï¼Œç„¶åè¯»ï¼š</strong></p>
<p>è¿™é‡Œæ˜¯å†™stateï¼Œæ‰€ä»¥urlæ˜¯/v1.0/state/statestoreï¼Œè¿™ä¸ªstatestoreæ˜¯<code>$HOME/.dapr/components/statestore.yaml</code>é‡Œé¢å®šä¹‰çš„ã€‚</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> curl -X POST -H <span class="string">&quot;Content-Type: application/json&quot;</span> -d <span class="string">&#x27;[&#123; &quot;key&quot;: &quot;name&quot;, &quot;value&quot;: &quot;Bruce Wayne&quot;&#125;]&#x27;</span> http://localhost:3500/v1.0/state/statestore</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> curl http://localhost:3500/v1.0/state/statestore/name</span></span><br><span class="line">&quot;Bruce Wayne&quot;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> è¿›å…¥rediså®¹å™¨æŸ¥çœ‹åœ¨redisä¸­çš„å­˜å‚¨å½¢å¼</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> docker <span class="built_in">exec</span> -it dapr_redis redis-cli</span></span><br><span class="line">127.0.0.1:6379&gt; keys *</span><br><span class="line">1) &quot;myapp||name&quot;   # keyä½¿ç”¨çš„æ˜¯â€œappçš„åå­—||nameâ€</span><br><span class="line">127.0.0.1:6379&gt; hgetall &quot;myapp||name&quot;</span><br><span class="line">1) &quot;data&quot;</span><br><span class="line">2) &quot;\&quot;Bruce Wayne\&quot;&quot;</span><br><span class="line">3) &quot;version&quot;</span><br><span class="line">4) &quot;2&quot;</span><br></pre></td></tr></table></figure>
<h3 id="è‡ªå·±å®šä¹‰component"><a href="#è‡ªå·±å®šä¹‰component" class="headerlink" title="è‡ªå·±å®šä¹‰component"></a>è‡ªå·±å®šä¹‰component</h3><p>ä¸Šè¿°æˆ‘ä»¬ç”¨çš„éƒ½æ˜¯dapr initæ—¶ç”Ÿæˆçš„ç®€å•çš„configä¾‹å­ã€‚ç°åœ¨æˆ‘ä»¬æƒ³è‡ªå·±å®šä¹‰æ–°çš„componentå¹¶ä½¿ç”¨dapr APIå»è°ƒç”¨å®ƒï¼ˆä»¬ï¼‰ï¼Ÿ</p>
<p>æˆ‘ä»¬å°†ï¼š</p>
<ol>
<li>åˆ›å»ºä¸€ä¸ªæœ¬åœ°çš„jsonçš„secret store</li>
<li>æŠŠè¿™ä¸ªsecret storeå†™åœ¨componentçš„å®šä¹‰é‡Œï¼Œå‘dapræ³¨å†Œã€‚</li>
<li>é€šè¿‡dapr APIè·å¾—è¿™ä¸ªsecret storeé‡Œçš„å†…å®¹ã€‚</li>
</ol>
<h4 id="åˆ›å»ºæœ¬åœ°secret-store"><a href="#åˆ›å»ºæœ¬åœ°secret-store" class="headerlink" title="åˆ›å»ºæœ¬åœ°secret store"></a>åˆ›å»ºæœ¬åœ°secret store</h4><p>åˆ›å»ºjsonæ–‡ä»¶</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat mysecrets.json</span></span><br><span class="line">&#123;</span><br><span class="line">     &quot;my-secret&quot; : &quot;I&#x27;m Batman&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">~/.dapr/my-components$ cat localSecretStore.yaml</span><br><span class="line">apiVersion: dapr.io/v1alpha1</span><br><span class="line">kind: Component</span><br><span class="line">metadata:</span><br><span class="line">  name: my-secret-store  # secret storeçš„åå­—ï¼Œåœ¨apiè°ƒç”¨æ—¶è¦ç”¨åˆ°</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  type: secretstores.local.file  # æŒ‡å®šç±»å‹æ—¶secretstoreï¼Œè€Œä¸”æ˜¯æœ¬åœ°æ–‡ä»¶å­˜å‚¨</span><br><span class="line">  version: v1</span><br><span class="line">  metadata:</span><br><span class="line">  - name: secretsFile</span><br><span class="line">    value: /home/ubuntu/.dapr/my-components/mysecrets.json</span><br><span class="line">  - name: nestedSeparator</span><br><span class="line">    value: &quot;:&quot;</span><br></pre></td></tr></table></figure>
<h4 id="è¿è¡Œä¸€ä¸ªdaprçš„process"><a href="#è¿è¡Œä¸€ä¸ªdaprçš„process" class="headerlink" title="è¿è¡Œä¸€ä¸ªdaprçš„process"></a>è¿è¡Œä¸€ä¸ªdaprçš„process</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> dapr run --app-id myapp --dapr-http-port 3500 --components-path ./my-components</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> verify</span> </span><br><span class="line"><span class="meta">$</span><span class="bash"> curl localhost:3500/v1.0/secrets/my-secret-store/my-secret</span></span><br><span class="line">&#123;&quot;my-secret&quot;:&quot;I&#x27;m Batman&quot;&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>é—®é¢˜ï¼šæ€ä¹ˆçŸ¥é“ä¸€ä¸ªcomponentæ—¶secretè¿˜æ˜¯stateè¿˜æ˜¯åˆ«çš„ï¼Ÿ</p>
<p>ç­”ï¼šé€šè¿‡yamlæ–‡ä»¶å®šä¹‰componentæ˜¯æŒ‡å®šçš„typeï¼Œè¿™æ ·åœ¨call APIæ—¶å°±çŸ¥é“URLæ€ä¹ˆå†™äº†ã€‚ï¼ˆæ˜¯/v1.0/secretsè¿˜æ˜¯v1.0/stateç­‰ç­‰ï¼‰</p>
</blockquote>
<h2 id="åœ¨kubernetesé›†ç¾¤ä¸Šå®‰è£…dapr"><a href="#åœ¨kubernetesé›†ç¾¤ä¸Šå®‰è£…dapr" class="headerlink" title="åœ¨kubernetesé›†ç¾¤ä¸Šå®‰è£…dapr"></a>åœ¨kubernetesé›†ç¾¤ä¸Šå®‰è£…dapr</h2><p>minikube</p>
<p><img src="/posts/c02c2ddc/Architecture_Diagram.png" alt="Architecture Diagram"></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> dapr init -k</span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> dapr status -k</span></span><br><span class="line">  NAME                   NAMESPACE    HEALTHY  STATUS   REPLICAS  VERSION  AGE  CREATED</span><br><span class="line">  dapr-placement-server  dapr-system  True     Running  1         1.0.1    2m   2021-03-09 15:02.06</span><br><span class="line">  dapr-dashboard         dapr-system  True     Running  1         0.6.0    2m   2021-03-09 15:02.05</span><br><span class="line">  dapr-sentry            dapr-system  True     Running  1         1.0.1    2m   2021-03-09 15:02.05</span><br><span class="line">  dapr-sidecar-injector  dapr-system  True     Running  1         1.0.1    2m   2021-03-09 15:02.05</span><br><span class="line">  dapr-operator          dapr-system  True     Running  1         1.0.1    2m   2021-03-09 15:02.05</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 5ä¸ªdaprçš„ç»„ä»¶</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> k get pods -ndapr-system</span></span><br><span class="line">NAME                                    READY   STATUS    RESTARTS   AGE</span><br><span class="line">dapr-dashboard-6bb75f9645-8f28z         1/1     Running   0          6m24s</span><br><span class="line">dapr-operator-5f84d9fd4-7smdf           1/1     Running   0          6m24s</span><br><span class="line">dapr-placement-server-0                 1/1     Running   0          6m23s</span><br><span class="line">dapr-sentry-5d67bfbfdc-fzsb6            1/1     Running   0          6m24s</span><br><span class="line">dapr-sidecar-injector-7b556f95d-kpxnc   1/1     Running   0          6m24s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> æ³¨æ„ï¼š placment æ²¡æœ‰deploymentï¼Œåªæœ‰podå’Œserviceã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> k get deploy -ndapr-system</span></span><br><span class="line">NAME                    READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">dapr-dashboard          1/1     1            1           12d</span><br><span class="line">dapr-operator           1/1     1            1           12d</span><br><span class="line">dapr-sentry             1/1     1            1           12d</span><br><span class="line">dapr-sidecar-injector   1/1     1            1           12d</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="è¿è¡Œhelloworld-sample"><a href="#è¿è¡Œhelloworld-sample" class="headerlink" title="è¿è¡Œhelloworld sample"></a>è¿è¡Œhelloworld sample</h3><h4 id="å®‰è£…redisä½œä¸ºstate-store"><a href="#å®‰è£…redisä½œä¸ºstate-store" class="headerlink" title="å®‰è£…redisä½œä¸ºstate store"></a>å®‰è£…redisä½œä¸ºstate store</h4><h5 id="å®‰è£…helm"><a href="#å®‰è£…helm" class="headerlink" title="å®‰è£…helm"></a>å®‰è£…helm</h5><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">curl https://baltocdn.com/helm/signing.asc | sudo apt-key add -</span><br><span class="line">sudo apt-get install apt-transport-https --yes</span><br><span class="line">echo &quot;deb https://baltocdn.com/helm/stable/debian/ all main&quot; | sudo tee /etc/apt/sources.list.d/helm-stable-debian.list</span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install helm</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h5 id="å®‰è£…redis"><a href="#å®‰è£…redis" class="headerlink" title="å®‰è£…redis"></a>å®‰è£…redis</h5><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">helm repo add bitnami https://charts.bitnami.com/bitnami</span><br><span class="line">helm repo update</span><br><span class="line">helm install redis bitnami/redis</span><br><span class="line"></span><br><span class="line">To get your password run:</span><br><span class="line"></span><br><span class="line">    export REDIS_PASSWORD=$(kubectl get secret --namespace default redis -o jsonpath=&quot;&#123;.data.redis-password&#125;&quot; | base64 --decode)</span><br><span class="line"></span><br><span class="line">To connect to your Redis(TM) server:</span><br><span class="line"></span><br><span class="line">1. Run a Redis(TM) pod that you can use as a client:</span><br><span class="line">   kubectl run --namespace default redis-client --rm --tty -i --restart=&#x27;Never&#x27; \</span><br><span class="line">    --env REDIS_PASSWORD=$REDIS_PASSWORD \</span><br><span class="line">   --image docker.io/bitnami/redis:6.0.12-debian-10-r3 -- bash</span><br><span class="line"></span><br><span class="line">2. Connect using the Redis(TM) CLI:</span><br><span class="line">   redis-cli -h redis-master -a $REDIS_PASSWORD</span><br><span class="line">   redis-cli -h redis-slave -a $REDIS_PASSWORD</span><br><span class="line"></span><br><span class="line">To connect to your database from outside the cluster execute the following commands:</span><br><span class="line"></span><br><span class="line">    kubectl port-forward --namespace default svc/redis-master 6379:6379 &amp;</span><br><span class="line">    redis-cli -h 127.0.0.1 -p 6379 -a $REDIS_PASSWORD</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> k get pods</span> </span><br><span class="line">default       redis-headless          ClusterIP   None             &lt;none&gt;        6379/TCP                 96s</span><br><span class="line">default       redis-master            ClusterIP   10.107.253.143   &lt;none&gt;        6379/TCP                 96s</span><br><span class="line">default       redis-slave             ClusterIP   10.102.228.172   &lt;none&gt;        6379/TCP                 96s</span><br><span class="line"><span class="meta">$</span><span class="bash"> k get secrets</span></span><br><span class="line">NAME                          TYPE                                  DATA   AGE</span><br><span class="line">default-token-hnmgm           kubernetes.io/service-account-token   3      155m</span><br><span class="line">redis                         Opaque                                1      3m4s</span><br><span class="line">sh.helm.release.v1.redis.v1   helm.sh/release.v1                    1      3m4s</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> k get svc -owide</span></span><br><span class="line">NAME             TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE     SELECTOR</span><br><span class="line">kubernetes       ClusterIP   10.96.0.1        &lt;none&gt;        443/TCP    5d13h   &lt;none&gt;</span><br><span class="line">redis-headless   ClusterIP   None             &lt;none&gt;        6379/TCP   5d10h   app=redis,release=redis</span><br><span class="line">redis-master     ClusterIP   10.107.253.143   &lt;none&gt;        6379/TCP   5d10h   app=redis,release=redis,role=master</span><br><span class="line">redis-slave      ClusterIP   10.102.228.172   &lt;none&gt;        6379/TCP   5d10h   app=redis,release=redis,role=slave</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash">  k get ep</span></span><br><span class="line">NAME             ENDPOINTS                                          AGE</span><br><span class="line">kubernetes       192.168.49.2:8443                                  5d13h</span><br><span class="line">redis-headless   172.17.0.10:6379,172.17.0.8:6379,172.17.0.9:6379   5d10h</span><br><span class="line">redis-master     172.17.0.9:6379                                    5d10h</span><br><span class="line">redis-slave      172.17.0.10:6379,172.17.0.8:6379                   5d10h</span><br></pre></td></tr></table></figure>




<p><img src="/posts/c02c2ddc/image-20210309233804291.png" alt="image-20210309233804291"></p>
<p>minikube user</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> minikube service nodeapp</span></span><br><span class="line">|-----------|---------|-------------|---------------------------|</span><br><span class="line">| NAMESPACE |  NAME   | TARGET PORT |            URL            |</span><br><span class="line">|-----------|---------|-------------|---------------------------|</span><br><span class="line">| default   | nodeapp |          80 | http://192.168.49.2:32108 |</span><br><span class="line">|-----------|---------|-------------|---------------------------|</span><br><span class="line">* Opening service default/nodeapp in default browser...</span><br><span class="line">  - http://192.168.49.2:32108</span><br><span class="line">  </span><br><span class="line"><span class="meta">#</span><span class="bash"> curl localhost:32108ä¸é€šï¼Œå› ä¸ºç”¨çš„æ˜¯minikube</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> curl http://192.168.49.2:32108/ports</span></span><br><span class="line">&#123;&quot;DAPR_HTTP_PORT&quot;:&quot;3500&quot;,&quot;DAPR_GRPC_PORT&quot;:&quot;50001&quot;&#125;</span><br><span class="line"></span><br><span class="line">export NODE_APP=192.168.49.2:32108</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>Next submit an order to the app</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line">curl <span class="operator">--</span>request <span class="type">POST</span> <span class="operator">--</span>data <span class="string">&quot;&#123;<span class="subst">\&quot;</span>data<span class="subst">\&quot;</span>: &#123; <span class="subst">\&quot;</span>orderId<span class="subst">\&quot;</span>: <span class="subst">\&quot;</span>42<span class="subst">\&quot;</span> &#125; &#125;&quot;</span> <span class="operator">--</span>header <span class="string">&quot;Content-Type:application/json&quot;</span> http:<span class="comment">//$NODE_APP/neworder</span></span><br></pre></td></tr></table></figure>
<p>Expected output: Empty reply from server</p>
<p>Confirm the order was persisted by requesting it from the app</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">curl http:<span class="regexp">//</span><span class="variable">$NODE_APP</span>/order</span><br></pre></td></tr></table></figure>
<p>Expected output:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;&quot;orderId&quot;:&quot;42&quot;&#125;</span><br></pre></td></tr></table></figure>








<p>dapr cli</p>
<p>dapr host</p>
<p>dapr API</p>
<p>dapr runtime</p>
<p>dapr operator </p>
<p>dapr sidecar injector</p>
<p>dapr placement service</p>
<p>dapr sentry</p>
<p>building blocks</p>
]]></content>
      <categories>
        <category>cloud native</category>
      </categories>
  </entry>
  <entry>
    <title>å¦‚ä½•æ„å»ºdocker image</title>
    <url>/posts/85a08636.html</url>
    <content><![CDATA[<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker image inspect ubuntu</span></span><br><span class="line">        &quot;RootFS&quot;: &#123;</span><br><span class="line">            &quot;Type&quot;: &quot;layers&quot;,</span><br><span class="line">            &quot;Layers&quot;: [</span><br><span class="line">                &quot;sha256:bacd3af13903e13a43fe87b6944acd1ff21024132aad6e74b4452d984fb1a99a&quot;,</span><br><span class="line">                &quot;sha256:9069f84dbbe96d4c50a656a05bbe6b6892722b0d1116a8f7fd9d274f4e991bf6&quot;,</span><br><span class="line">                &quot;sha256:f6253634dc78da2f2e3bee9c8063593f880dc35d701307f30f65553e0f50c18c&quot;</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br></pre></td></tr></table></figure>


<p>rootfs</p>
<p>bootfs</p>
<p>chroot</p>
<p>aufs</p>
<p>xfs</p>
<p>Overlay2</p>
<p>copy on write </p>
<p>Writeout </p>
<p>init-layer - non commit</p>
<img src="/posts/85a08636/image-20210203234917452.png" alt="image-20210203234917452" style="zoom:70%;">



<h2 id="å¦‚ä½•æ„å»ºdocker-image"><a href="#å¦‚ä½•æ„å»ºdocker-image" class="headerlink" title="å¦‚ä½•æ„å»ºdocker image"></a>å¦‚ä½•æ„å»ºdocker image</h2><p>æ­¥éª¤ï¼š</p>
<ol>
<li>ç¼–å†™ä¸€ä¸ªdockerfile</li>
<li>docker buildæ„å»ºé•œåƒ</li>
<li>docker runè¿è¡Œé•œåƒ</li>
<li>docker pushå‘å¸ƒé•œåƒ</li>
</ol>
<h3 id="DockerFileæ„å»ºè¿‡ç¨‹"><a href="#DockerFileæ„å»ºè¿‡ç¨‹" class="headerlink" title="DockerFileæ„å»ºè¿‡ç¨‹"></a>DockerFileæ„å»ºè¿‡ç¨‹</h3><h4 id="åŸºç¡€çŸ¥è¯†ï¼š"><a href="#åŸºç¡€çŸ¥è¯†ï¼š" class="headerlink" title="åŸºç¡€çŸ¥è¯†ï¼š"></a><strong>åŸºç¡€çŸ¥è¯†ï¼š</strong></h4><ol>
<li>æ¯ä¸ªä¿ç•™å…³é”®å­—éƒ½æ˜¯å¤§å†™</li>
<li>é¡ºåºæ‰§è¡Œ</li>
<li>#è¡¨ç¤ºæ³¨é‡Š</li>
<li>æ¯ä¸€ä¸ªæŒ‡ä»¤éƒ½ä¼šåˆ›å»ºæäº¤ä¸€ä¸ªæ–°çš„é•œåƒå±‚ã€‚</li>
</ol>
<h4 id="DockerFileæŒ‡ä»¤"><a href="#DockerFileæŒ‡ä»¤" class="headerlink" title="DockerFileæŒ‡ä»¤"></a>DockerFileæŒ‡ä»¤</h4><p><img src="/posts/85a08636/image-20210128174810881-1611828531908.png" alt="image-20210128174810881"></p>
<h4 id="CMD-å’Œ-ENTRYPOINTçš„åŒºåˆ«"><a href="#CMD-å’Œ-ENTRYPOINTçš„åŒºåˆ«" class="headerlink" title="CMD  å’Œ ENTRYPOINTçš„åŒºåˆ«"></a>CMD  å’Œ ENTRYPOINTçš„åŒºåˆ«</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> docker run image-id</span> </span><br><span class="line">CMD [&quot;ls&quot;,&quot;-a&quot;]  # æŒ‡å®šå®¹å™¨å¯åŠ¨æ—¶è¦è¿è¡Œçš„å‘½ä»¤ï¼Œæœ€åä¸€ä¸ªæœ‰æ•ˆï¼Œå¯è¢«æ›¿ä»£ã€‚åœ¨docker runæ—¶ä¸èƒ½è¢«è¿½åŠ å‚æ•°</span><br><span class="line">ENTRYPOINT [&quot;ls&quot;, [&quot;-a&quot;]] # æŒ‡å®šå®¹å™¨å¯åŠ¨æ—¶è¦è¿è¡Œçš„å‘½ä»¤ï¼Œå¯ä»¥åœ¨docker runçš„æ—¶å€™è¿½åŠ å‚æ•°</span><br><span class="line"> 													# æ¯”å¦‚ docker run xxx &quot;-l&quot;</span><br></pre></td></tr></table></figure>
<h5 id="æµ‹è¯•CMD"><a href="#æµ‹è¯•CMD" class="headerlink" title="æµ‹è¯•CMD"></a>æµ‹è¯•CMD</h5><p>å†™äº†ä¸¤ä¸ªCMDï¼Œåœ¨docker runçš„æ—¶å€™ï¼Œå‘ç°åªæ‰§è¡Œäº†æœ€åä¸€ä¸ªï¼Œå¹¶æ²¡æœ‰echoå‡ºâ€Helloâ€ï¼Œä¹Ÿä¸èƒ½è¿½åŠ å‚æ•°ï¼Œä¼šæŠ¥é”™ã€‚</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[vagrant@localhost dockerfile]$ cat docker-cmd-test</span><br><span class="line">FROM centos</span><br><span class="line">CMD [&quot;echo&quot;, &quot;Hello&quot;]</span><br><span class="line">CMD [&quot;ls&quot;, &quot;-a&quot;]</span><br><span class="line"></span><br><span class="line">[vagrant@localhost dockerfile]$ docker run cmdtest</span><br><span class="line">.</span><br><span class="line">..</span><br><span class="line">.dockerenv</span><br><span class="line">bin</span><br><span class="line">dev</span><br><span class="line">etc</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> å°è¯•è¿½åŠ ä¸€ä¸ªå‚æ•°ï¼Œæƒ³è¾¾åˆ°ls -alçš„æ•ˆæœï¼Œå¤±è´¥ã€‚</span></span><br><span class="line">[vagrant@localhost dockerfile]$ docker run cmdtest -l</span><br><span class="line">docker: Error response from daemon: OCI runtime create failed: container_linux.go:370: starting container process caused: exec: &quot;-l&quot;: executable file not found in $PATH: unknown.</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> ä½†æ˜¯å¯ä»¥åœ¨docker runçš„åé¢ç›´æ¥åŠ å‘½ä»¤ã€‚</span></span><br><span class="line">[vagrant@localhost dockerfile]$ docker run cmdtest ls -al</span><br><span class="line">total 0</span><br><span class="line">drwxr-xr-x.   1 root root   6 Jan 30 11:26 .</span><br><span class="line">drwxr-xr-x.   1 root root   6 Jan 30 11:26 ..</span><br><span class="line">-rwxr-xr-x.   1 root root   0 Jan 30 11:26 .dockerenv</span><br><span class="line">lrwxrwxrwx.   1 root root   7 Nov  3 15:22 bin -&gt; usr/bin</span><br><span class="line">drwxr-xr-x.   5 root root 340 Jan 30 11:26 dev</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<h5 id="æµ‹è¯•ENTRYPOINT"><a href="#æµ‹è¯•ENTRYPOINT" class="headerlink" title="æµ‹è¯•ENTRYPOINT"></a>æµ‹è¯•ENTRYPOINT</h5><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[vagrant@localhost dockerfile]$ cat  docker-cmd-entrypoint</span><br><span class="line">FROM centos</span><br><span class="line">ENTRYPOINT [&quot;echo&quot;,&quot;Hello&quot;]</span><br><span class="line">ENTRYPOINT [&quot;ls&quot;,&quot;-a&quot;]</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> å‘ç°ENTRYPOINTä¹Ÿæ˜¯åªæ‰§è¡Œæœ€åä¸€ä¸ª</span></span><br><span class="line">[vagrant@localhost dockerfile]$ docker run entrypoint</span><br><span class="line">.</span><br><span class="line">..</span><br><span class="line">.dockerenv</span><br><span class="line">bin</span><br><span class="line">dev</span><br><span class="line">etc</span><br><span class="line">home</span><br><span class="line">lib</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> ä½†æ˜¯ENTRYPOINTå¯ä»¥è¿½åŠ å‚æ•°</span></span><br><span class="line">[vagrant@localhost dockerfile]$ docker run entrypoint -l</span><br><span class="line">total 0</span><br><span class="line">drwxr-xr-x.   1 root root   6 Jan 30 11:31 .</span><br><span class="line">drwxr-xr-x.   1 root root   6 Jan 30 11:31 ..</span><br><span class="line">-rwxr-xr-x.   1 root root   0 Jan 30 11:31 .dockerenv</span><br><span class="line">lrwxrwxrwx.   1 root root   7 Nov  3 15:22 bin -&gt; usr/bin</span><br><span class="line">drwxr-xr-x.   5 root root 340 Jan 30 11:31 dev</span><br><span class="line">drwxr-xr-x.   1 root root  66 Jan 30 11:31 etc</span><br></pre></td></tr></table></figure>


<h4 id="COPYå’ŒADDçš„åŒºåˆ«"><a href="#COPYå’ŒADDçš„åŒºåˆ«" class="headerlink" title="COPYå’ŒADDçš„åŒºåˆ«"></a>COPYå’ŒADDçš„åŒºåˆ«</h4><p>addä¼šè‡ªåŠ¨è§£å‹</p>
<h5 id="COPYæµ‹è¯•"><a href="#COPYæµ‹è¯•" class="headerlink" title="COPYæµ‹è¯•"></a>COPYæµ‹è¯•</h5><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[vagrant@localhost dockerfile]$ tree .</span><br><span class="line">.</span><br><span class="line">|-- copy01</span><br><span class="line">|-- copy02</span><br><span class="line">|-- test-dir/</span><br><span class="line">    |-- sub-dir/</span><br><span class="line">    |   |-- test3</span><br><span class="line">    |-- test1</span><br><span class="line">    |-- test2</span><br><span clœ¨è·Ÿç›®å½•ä¸‹é¢</span></span><br><span class="line">[root@e4a55c64ff8f /]# ls</span><br><span class="line">bin  copy01  dev  etc  home  lib  lib64  lost+found  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> COPYå¯ä»¥æŒ‡å®šç›®çš„è·¯å¾„</span></span><br><span class="line">[root@e4a55c64ff8f home]# ls</span><br><span class="line">copy02</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> ä¸ä¼šæ‹·è´ç›®å½•ï¼Œåªæ‹·è´ç›®å½•ä¸‹çš„æ–‡ä»¶å’Œç›®å½•</span></span><br><span class="line">[root@e8be2eb3f129 /]# ls</span><br><span class="line">bin  copy01  dev  etc  home  lib  lib64  lost+found  media  mnt  opt  proc  root  run  sbin  srv  sub-dir  sys  test1  test2  tmp  usr  var</span><br><span class="line">[root@e8be2eb3f129 /]# cd sub-dir/</span><br><span class="line">[root@e8be2eb3f129 sub-dir]# ls</span><br><span class="line">test3</span><br></pre></td></tr></table></figure>
<p>æ­¤å¤–ï¼ŒCOPYè¿˜å¯ä»¥ç”¨æ¥å®ç°<a href="https://www.cnblogs.com/sparkdev/p/8508435.html">multi-stage(å¤šé˜¶æ®µæ„å»º)</a>ï¼Œå°±æ˜¯ä¸€ä¸ªdockerfileé‡Œæœ‰å¤šä¸ªFROMï¼Œæ¯ä¸ª FROM æŒ‡ä»¤ä»£è¡¨ä¸€ä¸ª stage çš„å¼€å§‹éƒ¨åˆ†ã€‚æˆ‘ä»¬å¯ä»¥æŠŠä¸€ä¸ª stage çš„äº§ç‰©æ‹·è´åˆ°å¦ä¸€ä¸ª stage ä¸­ã€‚</p>
<h5 id="ADDæµ‹è¯•"><a href="#ADDæµ‹è¯•" class="headerlink" title="ADDæµ‹è¯•"></a>ADDæµ‹è¯•</h5><p>é™¤äº†ä¸èƒ½ç”¨åœ¨ multistage çš„åœºæ™¯ä¸‹ï¼ŒADD å‘½ä»¤å¯ä»¥å®Œæˆ COPY å‘½ä»¤çš„æ‰€æœ‰åŠŸèƒ½ï¼Œå¹¶ä¸”è¿˜å¯ä»¥å®Œæˆä¸¤ç±»è¶…é…·çš„åŠŸèƒ½ï¼š</p>
<ul>
<li>è§£å‹å‹ç¼©æ–‡ä»¶å¹¶æŠŠå®ƒä»¬æ·»åŠ åˆ°é•œåƒä¸­</li>
<li>ä» url æ‹·è´æ–‡ä»¶åˆ°é•œåƒä¸­</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">WORKDIR /app</span><br><span class="line">ADD nickdir.tar.gz .  </span><br><span class="line"><span class="meta">#</span><span class="bash"> å¯ä»¥æŠŠå‹ç¼©åŒ…è‡ªåŠ¨è§£å‹åˆ°/appç›®å½•ä¸‹</span></span><br><span class="line">ADD http://example.com/big.tar.xz /usr/src/things/ </span><br><span class="line"><span class="meta">#</span><span class="bash"> ä¼šç›´æ¥æŠŠtaråŒ…åŠ å…¥é•œåƒä¸­ï¼Œä¸ä¼šè‡ªåŠ¨è§£å‹ï¼Œå®åˆ™å¢åŠ äº†é•œåƒçš„å¤§å°ï¼Œä¸å»ºè®®è¿™ä¹ˆåšï¼</span></span><br></pre></td></tr></table></figure>
<h5 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h5><p>COPY å‘½ä»¤æ˜¯ä¸ºæœ€åŸºæœ¬çš„ç”¨æ³•è®¾è®¡çš„ï¼Œæ¦‚å¿µæ¸…æ™°ï¼Œæ“ä½œç®€å•ã€‚è€Œ ADD å‘½ä»¤åŸºæœ¬ä¸Šæ˜¯ COPY å‘½ä»¤çš„è¶…é›†(é™¤äº† multistage åœºæ™¯)ï¼Œå¯ä»¥å®ç°ä¸€äº›æ–¹ä¾¿ã€é…·ç‚«çš„æ‹·è´æ“ä½œã€‚ADD å‘½ä»¤åœ¨å¢åŠ äº†åŠŸèƒ½çš„åŒæ—¶ä¹Ÿå¢åŠ äº†ä½¿ç”¨å®ƒçš„å¤æ‚åº¦ï¼Œæ¯”å¦‚ä» url æ‹·è´å‹ç¼©æ–‡ä»¶æ—¶å¼Šå¤§äºåˆ©ã€‚</p>
]]></content>
      <categories>
        <category>docker</category>
      </categories>
      <tags>
        <tag>docker</tag>
      </tags>
  </entry>
  <entry>
    <title>æµ…ædockerç½‘ç»œ</title>
    <url>/posts/3e6a7048.html</url>
    <content><![CDATA[<h3 id="docker0"><a href="#docker0" class="headerlink" title="docker0"></a>docker0</h3><p>å…ˆæ¥æŸ¥çœ‹ä¸€ä¸‹hostçš„ç½‘ç»œï¼š</p>
<img src="/posts/3e6a7048/image-20210201164717688.png" alt="image-20210201164717688" style="zoom:50%;">



<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> å¯åŠ¨ä¸€ä¸ªtomcatå®¹å™¨</span></span><br><span class="line">[vagrant@localhost ~]$ docker run -d -P --name tomcat01 tomcat</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> æŸ¥çœ‹å®¹å™¨é‡Œçš„ç½‘ç»œï¼Œå‘ç°æœ‰ä¸€ä¸ª eth0@if37ï¼ˆ172.17.0.2ï¼‰å’Œhostä¸Šçš„docker0ï¼ˆ172.17.0.1ï¼‰åœ¨åŒä¸€ä¸ªç½‘æ®µã€‚</span></span><br><span class="line">[vagrant@localhost dockerfile]$ docker exec -it ef59e03b0b34 ip a</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">36: eth0@if37: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default</span><br><span class="line">    link/ether 02:42:ac:11:00:02 brd ff:ff:ff:ff:ff:ff link-netnsid 0</span><br><span class="line">    inet 172.17.0.2/16 brd 172.17.255.255 scope global eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">     </span><br><span class="line"><span class="meta">#</span><span class="bash"> ä»hostä¸Špingå®¹å™¨çš„eth0@if37ï¼Œå¯ä»¥pingé€šã€‚</span></span><br><span class="line">[vagrant@localhost dockerfile]$ ping 172.17.0.2</span><br><span class="line">PING 172.17.0.2 (172.17.0.2) 56(84) bytes of data.</span><br><span class="line">64 bytes from 172.17.0.2: icmp_seq=1 ttl=64 time=0.083 ms</span><br><span class="line">64 bytes from 172.17.0.2: icmp_seq=2 ttl=64 time=0.061 ms</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬æ¯å¯åŠ¨ä¸€ä¸ªdockerå®¹å™¨ï¼Œdockerå°±ä¼šç»™å®¹å™¨åˆ†é…ä¸€ä¸ªipï¼Œæˆ‘ä»¬åªè¦å®‰è£…çš„dockerï¼Œå°±ä¼šæœ‰ä¸€ä¸ªdocker0ç½‘å¡ï¼Œè¿™ä¸ªç½‘å¡æ˜¯æ¡¥æ¥æ¨¡å¼ï¼Œä½¿ç”¨çš„æŠ€æœ¯æ˜¯ve th-pairæŠ€æœ¯ã€‚</p>
<p>å¯åŠ¨å®Œtomcatå®¹å™¨åï¼Œå†åœ¨hostä¸ŠæŸ¥çœ‹ç½‘ç»œæ¥å£ï¼Œä¼šå‘ç°å¤šäº†ä¸€ä¸ªæ¥å£ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[vagrant@localhost ~]$ ip a</span><br><span class="line">...</span><br><span class="line"><span class="meta">#</span><span class="bash"> </span></span><br><span class="line">37: veth9f8a1b7@if36: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master docker0 state UP group default</span><br><span class="line">    link/ether 0a:6f:15:99:d0:b8 brd ff:ff:ff:ff:ff:ff link-netnsid 0</span><br><span class="line">    inet6 fe80::86f:15ff:fe99:d0b8/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure>
<h3 id="veth-pairæŠ€æœ¯"><a href="#veth-pairæŠ€æœ¯" class="headerlink" title="veth-pairæŠ€æœ¯"></a>veth-pairæŠ€æœ¯</h3><p>æ˜¯ä¸€å¯¹è™šæ‹Ÿè®¾å¤‡æ¥å£ï¼Œéƒ½æ˜¯æˆå¯¹å‡ºç°çš„ã€‚</p>
<p>æˆ‘ä»¬å†èµ·ä¸€ä¸ªtomcatï¼Œç°åœ¨æœ‰ä¸¤ä¸ªå®¹å™¨ï¼Œtomcat01å’Œtomcat02ã€‚çœ‹ä¸€ä¸‹ä»–ä»¬çš„ç½‘ç»œæ¥å£å’Œhostçš„ç½‘ç»œã€‚</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker <span class="built_in">exec</span> -it tomcat01 ip a</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">36: eth0@if37: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default</span><br><span class="line">    link/ether 02:42:ac:11:00:02 brd ff:ff:ff:ff:ff:ff link-netnsid 0</span><br><span class="line">    inet 172.17.0.2/16 brd 172.17.255.255 scope global eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">       </span><br><span class="line"><span class="meta">$</span><span class="bash"> docker <span class="built_in">exec</span> -it tomcat02 ip a</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">38: eth0@if39: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default</span><br><span class="line">    link/ether 02:42:ac:11:00:03 brd ff:ff:ff:ff:ff:ff link-netnsid 0</span><br><span class="line">    inet 172.17.0.3/16 brd 172.17.255.255 scope global eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    </span><br><span class="line"><span class="meta">$</span><span class="bash"> ip a</span></span><br><span class="line">...</span><br><span class="line">3: docker0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default</span><br><span class="line">    link/ether 02:42:95:5a:03:dc brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::42:95ff:fe5a:3dc/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">37: veth9f8a1b7@if36: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master docker0 state UP group default</span><br><span class="line">    link/ether 0a:6f:15:99:d0:b8 brd ff:ff:ff:ff:ff:ff link-netnsid 0</span><br><span class="line">    inet6 fe80::86f:15ff:fe99:d0b8/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">39: veth11e4e0f@if38: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master docker0 state UP group default</span><br><span class="line">    link/ether ba:3b:43:24:29:92 brd ff:ff:ff:ff:ff:ff link-netnsid 1</span><br><span class="line">    inet6 fe80::b83b:43ff:fe24:2992/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure>
<p>ç½‘ç»œæ¨¡å‹å¦‚ä¸‹ï¼Œæ¯ä¸ªå®¹å™¨åœ¨åˆ›å»ºçš„æ—¶å€™ä¼šå»ºç«‹ä¸€å¯¹veth pairï¼Œç”¨äºå’Œdocker0é€šä¿¡ï¼Œä¸åŒå®¹å™¨é—´çš„é€šä¿¡ä¹Ÿæ˜¯é€šè¿‡docker0ç½‘æ¡¥ã€‚</p>
<img src="/posts/3e6a7048/image-20210201170031892.png" alt="image-20210201170031892" style="zoom:50%;">

<h3 id="limitation"><a href="#limitation" class="headerlink" title="limitation"></a>limitation</h3><p>æµ‹è¯•ä¸¤ä¸ªå®¹å™¨çš„è¿é€šæ€§</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> pingå®¹å™¨åæ˜¯pingä¸é€šçš„</span></span><br><span class="line">vagrant@localhost ~]$ docker exec -it tomcat01 ping tomcat02</span><br><span class="line">ping: tomcat02: No address associated with hostname</span><br><span class="line"><span class="meta">#</span><span class="bash"> ping ipå¯ä»¥pingé€š</span></span><br><span class="line">[vagrant@localhost ~]$ docker exec -it tomcat01 ping 172.17.0.3</span><br><span class="line">PING 172.17.0.3 (172.17.0.3) 56(84) bytes of data.</span><br><span class="line">64 bytes from 172.17.0.3: icmp_seq=1 ttl=64 time=0.058 ms</span><br><span class="line">64 bytes from 172.17.0.3: icmp_seq=2 ttl=64 time=0.066 ms</span><br></pre></td></tr></table></figure>
<p>è¿™å°±æ˜¯docker0ç½‘æ¡¥çš„å±€é™æ€§ï¼Œ<strong>ä¸æ”¯æŒå®¹å™¨åè®¿é—®</strong>ã€‚è¿™é‡Œæˆ‘ä»¬å¯ä»¥é€šè¿‡<code>--link</code>æ¥å®ç°é€šè¿‡å®¹å™¨åæ¥è¿é€šã€‚</p>
<h4 id="â€“link"><a href="#â€“link" class="headerlink" title="â€“link"></a>â€“link</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> åˆ é™¤tomcat02ï¼Œå¹¶ä¸”é‡æ–°åˆ›å»º</span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> docker run -d -P --name tomcat02 --link tomcat01 tomcat</span></span><br><span class="line">a9a926b40eb97a28d39ec67418efaa05b362b9917f7375620da18e8f13607282</span><br><span class="line"><span class="meta">$</span><span class="bash"> docker <span class="built_in">exec</span> -it tomcat02 ping tomcat01</span></span><br><span class="line">PING tomcat01 (172.17.0.2) 56(84) bytes of data.</span><br><span class="line">64 bytes from tomcat01 (172.17.0.2): icmp_seq=1 ttl=64 time=0.090 ms</span><br><span class="line">64 bytes from tomcat01 (172.17.0.2): icmp_seq=2 ttl=64 time=0.060 ms</span><br><span class="line">^C</span><br><span class="line">--- tomcat01 ping statistics ---</span><br><span class="line">2 packets transmitted, 2 received, 0% packet loss, time 11ms</span><br><span class="line">rtt min/avg/max/mdev = 0.060/0.075/0.090/0.015 ms</span><br></pre></td></tr></table></figure>
<p>å‘ç°å¯ä»¥é€šè¿‡å®¹å™¨åpingé€šäº†ï¼Œä½†æ˜¯åå‘pingè¿˜æ˜¯ä¸é€šã€‚</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker <span class="built_in">exec</span> -it tomcat01 ping tomcat02</span></span><br><span class="line">ping: tomcat02: No address associated with hostname</span><br></pre></td></tr></table></figure>
<p>åŸå› æ˜¯å› ä¸ºæˆ‘ä»¬åªæ˜¯åœ¨docker run tomcat02çš„æ—¶å€™åŠ äº†<code>--link</code>,ç›¸å½“äºåªå¯¹tomcat02è®¾ç½®äº†é’ˆå¯¹tomcat01çš„è¿é€šæ€§ï¼Œåä¹‹åˆ™æ²¡æœ‰ï¼Œæ‰€ä»¥tomcat01å¹¶ä¸çŸ¥é“å¦‚ä½•å¤„ç†tomcat02è¿™ä¸ªåŸŸåã€‚</p>
<p>é‚£ä¹ˆï¼Œ<code>--link</code>  åˆ°åº•åœ¨tomcat02é‡Œé…ç½®äº†ä»€ä¹ˆå‘¢ï¼Ÿ ä¸‹é¢æ˜¯<code>docker inspect tomcat02</code>çš„è¾“å‡ºï¼Œå¯ä»¥çœ‹åˆ°åœ¨HostConfigä¸­æœ‰ä¸€ä¸ªå…³äºtomcat01çš„è®¾ç½®ã€‚</p>
<img src="/posts/3e6a7048/image-20210201171348699.png" alt="image-20210201171348699" style="zoom:50%;">

<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> --linkä¸»è¦å¹²äº†ä¸¤ä»¶äº‹</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 1. è®¾ç½®tomcat01ï¼ˆè¢«linkå®¹å™¨ï¼‰çš„ç¯å¢ƒå˜é‡</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> docker <span class="built_in">exec</span>  -it tomcat02 env | grep -i tomcat01</span></span><br><span class="line">TOMCAT01_PORT=tcp://172.17.0.2:8080</span><br><span class="line">TOMCAT01_PORT_8080_TCP=tcp://172.17.0.2:8080</span><br><span class="line">TOMCAT01_PORT_8080_TCP_ADDR=172.17.0.2</span><br><span class="line">TOMCAT01_PORT_8080_TCP_PORT=8080</span><br><span class="line">TOMCAT01_PORT_8080_TCP_PROTO=tcp</span><br><span class="line">TOMCAT01_NAME=/tomcat02/tomcat01</span><br><span class="line">TOMCAT01_ENV_LANG=C.UTF-8</span><br><span class="line">TOMCAT01_ENV_JAVA_HOME=/usr/local/openjdk-11</span><br><span class="line">TOMCAT01_ENV_JAVA_VERSION=11.0.9.1</span><br><span class="line">TOMCAT01_ENV_CATALINA_HOME=/usr/local/tomcat</span><br><span class="line">TOMCAT01_ENV_TOMCAT_NATIVE_LIBDIR=/usr/local/tomcat/native-jni-lib</span><br><span class="line">TOMCAT01_ENV_LD_LIBRARY_PATH=/usr/local/tomcat/native-jni-lib</span><br><span class="line">TOMCAT01_ENV_GPG_KEYS=05AB33110949707C93A279E3D3EFE6B686867BA6 07E48665A34DCAFAE522E5E6266191C37C037D42 47309207D818FFD8DCD3F83F1931D684307A10A5 541FBE7D8F78B25E055DDEE13C370389288584E7 61B832AC2F1C5A90F0F9B00A1C506407564C17A3 79F7026C690BAA50B92CD8B66A3AD3F4F22C4FED 9BA44C2621385CB966EBA586F72C284D731FABEE A27677289986DB50844682F8ACB77FC2E86E29AC A9C5DF4D22E99998D9875A5110C01C5A2F6059E7 DCFD35E0BF8CA7344752DE8B6FB21E8933C60243 F3A04C595DB5B6A5F1ECA43E3B7BBB100D811BBE F7DA48BB64BCB84ECBA7EE6935CD23C10D498E23</span><br><span class="line">TOMCAT01_ENV_TOMCAT_MAJOR=9</span><br><span class="line">TOMCAT01_ENV_TOMCAT_VERSION=9.0.41</span><br><span class="line">TOMCAT01_ENV_TOMCAT_SHA512=b6450e590a37c5bccf049b1176c441f0964796995e80d4c7c7d9fb74f9ad817107c303b6b83ed3d71c9251b2b8acf334b90a4abdf9deea122e338643cece0766</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 2. è®¾ç½®/etc/hosts</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> docker <span class="built_in">exec</span>  -it tomcat02 cat /etc/hosts</span></span><br><span class="line">127.0.0.1       localhost</span><br><span class="line">::1     localhost ip6-localhost ip6-loopback</span><br><span class="line">fe00::0 ip6-localnet</span><br><span class="line">ff00::0 ip6-mcastprefix</span><br><span class="line">ff02::1 ip6-allnodes</span><br><span class="line">ff02::2 ip6-allrouters</span><br><span class="line">172.17.0.2      tomcat01 ef59e03b0b34  # è¿™é‡Œè®¾ç½®äº†tomcat01çš„IPæ˜ å°„å…³ç³»</span><br><span class="line">172.17.0.3      a9a926b40eb9</span><br></pre></td></tr></table></figure>
<h3 id="è‡ªå®šä¹‰ç½‘ç»œ"><a href="#è‡ªå®šä¹‰ç½‘ç»œ" class="headerlink" title="è‡ªå®šä¹‰ç½‘ç»œ"></a>è‡ªå®šä¹‰ç½‘ç»œ</h3><p>åœ¨docker å®‰è£…çš„æ—¶å€™ï¼Œæœ‰</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker network ls</span></span><br><span class="line">NETWORK ID     NAME      DRIVER    SCOPE</span><br><span class="line">b3d482ea68aa   bridge    bridge    local  # veth pair - &gt; docker0 æ¡¥æ¥æ¨¡å¼ï¼ˆç¼ºçœæ¨¡å¼ï¼‰</span><br><span class="line">70901896d6a3   host      host      local  # å’Œhostå…±äº«ç½‘ç»œ</span><br><span class="line">51ec536b7953   none      null      local  # ä¸é…ç½®ç½‘ç»œï¼Œä¸€èˆ¬ä¸ç”¨</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> è¿˜æœ‰ä¸€ç§containeræ¨¡å¼ï¼Œå®¹å™¨å†…ç½‘ç»œè¿é€šï¼ˆä¸å¸¸ç”¨ï¼‰ã€‚</span></span><br></pre></td></tr></table></figure>
<p>bridgeç½‘ç»œé‡Œé¢é…ç½®äº†gatewayï¼Œ subnetï¼Œå¹¶ä¸”å¯ä»¥çœ‹åˆ°è¿æ¥åœ¨è¿™ä¸ªç½‘ç»œä¸Šçš„å®¹å™¨ã€‚</p>
<p>è¿™é‡Œçš„gatewayå°±è¯´doker0ç½‘æ¡¥ï¼ˆ172.17.0.1ï¼‰</p>
<img src="/posts/3e6a7048/image-20210201164519343.png" alt="image-20210201164519343" style="zoom:50%;">

<h4 id="åˆ›å»ºä¸€ä¸ªæ–°çš„ç½‘ç»œ"><a href="#åˆ›å»ºä¸€ä¸ªæ–°çš„ç½‘ç»œ" class="headerlink" title="åˆ›å»ºä¸€ä¸ªæ–°çš„ç½‘ç»œ"></a>åˆ›å»ºä¸€ä¸ªæ–°çš„ç½‘ç»œ</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> é»˜è®¤driverå°±æ˜¯bridge</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> --driver bridge</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> --subnet 192.168.0.0/16 (192.168.0.1- 192.168.255.255)</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> docker network create -d bridge --gateway 192.168.0.1 --subnet 192.168.0.0/16 mynet</span></span><br><span class="line">49025b4d0eaa1303c112bbec9290a306fac466b9bc56aa81237d823476d86ada</span><br><span class="line"><span class="meta">$</span><span class="bash"> docker network ls</span></span><br><span class="line">NETWORK ID     NAME      DRIVER    SCOPE</span><br><span class="line">b3d482ea68aa   bridge    bridge    local</span><br><span class="line">70901896d6a3   host      host      local</span><br><span class="line">49025b4d0eaa   mynet     bridge    local</span><br><span class="line">51ec536b7953   none      null      local</span><br></pre></td></tr></table></figure>
<h4 id="åœ¨mynetç½‘ç»œé‡Œåˆ›å»ºä¸¤ä¸ªæ–°çš„tomcat"><a href="#åœ¨mynetç½‘ç»œé‡Œåˆ›å»ºä¸¤ä¸ªæ–°çš„tomcat" class="headerlink" title="åœ¨mynetç½‘ç»œé‡Œåˆ›å»ºä¸¤ä¸ªæ–°çš„tomcat"></a>åœ¨mynetç½‘ç»œé‡Œåˆ›å»ºä¸¤ä¸ªæ–°çš„tomcat</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> èµ·ä¸¤ä¸ªåœ¨myneté‡Œçš„tomcat</span></span><br><span class="line">[vagrant@localhost ~]$ docker run -d -P --name tomcat-net-01 --net mynet tomcat</span><br><span class="line">8151712ef76b6315018f969b6c0b8116b297a8391793736f7d7825c88a89cc8c</span><br><span class="line">[vagrant@localhost ~]$ docker run -d -P --name tomcat-net-02 --net mynet tomcat</span><br><span class="line">8dada8500e5c3c7993b649984f64c0bb8266a52d6e38256a73807a8e99d901cd</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> å‘ç°è¿™ä¸¤ä¸ªå®¹å™¨å¯ä»¥é€šè¿‡å®¹å™¨åäº’é€šã€‚</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> è¿™å°±æ˜¯è‡ªå®šä¹‰ç½‘ç»œæ¯”dockeré»˜è®¤çš„bridgeç½‘ç»œï¼ˆdocker0ï¼‰æ›´é«˜çº§çš„åœ°æ–¹ã€‚</span></span><br><span class="line">[vagrant@localhost ~]$ docker exec -it tomcat-net-01 ping tomcat-net-02</span><br><span class="line">PING tomcat-net-02 (192.168.0.3) 56(84) bytes of data.</span><br><span class="line">64 bytes from tomcat-net-02.mynet (192.168.0.3): icmp_seq=1 ttl=64 time=0.082 ms</span><br><span class="line">64 bytes from tomcat-net-02.mynet (192.168.0.3): icmp_seq=2 ttl=64 time=0.078 ms</span><br><span class="line">^C</span><br><span class="line">--- tomcat-net-02 ping statistics ---</span><br><span class="line">2 packets transmitted, 2 received, 0% packet loss, time 2ms</span><br><span class="line">rtt min/avg/max/mdev = 0.078/0.080/0.082/0.002 ms</span><br><span class="line">[vagrant@localhost ~]$ docker exec -it tomcat-net-02 ping tomcat-net-01</span><br><span class="line">PING tomcat-net-01 (192.168.0.2) 56(84) bytes of data.</span><br><span class="line">64 bytes from tomcat-net-01.mynet (192.168.0.2): icmp_seq=1 ttl=64 time=0.059 ms</span><br><span class="line">64 bytes from tomcat-net-01.mynet (192.168.0.2): icmp_seq=2 ttl=64 time=0.068 ms</span><br><span class="line"></span><br><span class="line">64 bytes from tomcat-net-01.mynet (192.168.0.2): icmp_seq=3 ttl=64 time=0.216 ms</span><br><span class="line">^C</span><br><span class="line">--- tomcat-net-01 ping statistics ---</span><br><span class="line">3 packets transmitted, 3 received, 0% packet loss, time 90ms</span><br><span class="line">rtt min/avg/max/mdev = 0.059/0.114/0.216/0.072 ms</span><br></pre></td></tr></table></figure>
<h4 id="ä¸åŒdockerç½‘ç»œé‡Œçš„å®¹å™¨è¿é€šï¼ˆè·¨ç½‘ç»œï¼‰"><a href="#ä¸åŒdockerç½‘ç»œé‡Œçš„å®¹å™¨è¿é€šï¼ˆè·¨ç½‘ç»œï¼‰" class="headerlink" title="ä¸åŒdockerç½‘ç»œé‡Œçš„å®¹å™¨è¿é€šï¼ˆè·¨ç½‘ç»œï¼‰"></a>ä¸åŒdockerç½‘ç»œé‡Œçš„å®¹å™¨è¿é€šï¼ˆè·¨ç½‘ç»œï¼‰</h4><p>è¿™æ—¶åˆæœ‰ä¸€ä¸ªé—®é¢˜ã€‚ç°åœ¨æˆ‘çš„hostä¸Šçš„å®¹å™¨å¦‚å›¾æ‰€ç¤ºã€‚</p>
<img src="/posts/3e6a7048/image-20210201173721626.png" alt="image-20210201173721626" style="zoom:50%;">

<p>tomcat01å’Œtomcat02æ˜¯åœ¨é»˜è®¤çš„docker0çš„ç½‘ç»œé‡Œï¼Œtomcat-net-01å’Œtomcat-net-02åœ¨æˆ‘æ–°åˆ›å»ºçš„myneté‡Œã€‚å¦‚æœæˆ‘éœ€è¦tomcat01å’Œtomcat-net-0è¿é€šï¼Œåº”è¯¥æ€ä¹ˆåšå‘¢ã€‚</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker network connect mynet tomcat01</span> </span><br><span class="line"><span class="meta">#</span><span class="bash"> æŠŠtomcatå®¹å™¨è¿æ¥åˆ°mynetç½‘ç»œä¸­</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ç°åœ¨å°±å¯ä»¥pingé€šäº†</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> docker <span class="built_in">exec</span> -it tomcat01 ping tomcat-net-02</span> </span><br><span class="line">PING tomcat-net-02 (192.168.0.3) 56(84) bytes of data.</span><br><span class="line">64 bytes from tomcat-net-02.mynet (192.168.0.3): icmp_seq=1 ttl=64 time=0.235 ms</span><br><span class="line">64 bytes from tomcat-net-02.mynet (192.168.0.3): icmp_seq=2 ttl=64 time=0.160 ms</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> çœ‹ä¸€ä¸‹tomcat01çš„ç½‘å¡ï¼Œå‘ç°å¤šäº†ä¸€ä¸ªeth1@if48ï¼Œå¯¹åº”IPæ˜¯ 192.168.0.4ï¼Œåœ¨mynetç½‘æ®µä¸­ã€‚</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> docker <span class="built_in">exec</span> -it tomcat01 ip a</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">36: eth0@if37: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default</span><br><span class="line">    link/ether 02:42:ac:11:00:02 brd ff:ff:ff:ff:ff:ff link-netnsid 0</span><br><span class="line">    inet 172.17.0.2/16 brd 172.17.255.255 scope global eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">47: eth1@if48: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default</span><br><span class="line">    link/ether 02:42:c0:a8:00:04 brd ff:ff:ff:ff:ff:ff link-netnsid 0</span><br><span class="line">    inet 192.168.0.4/16 brd 192.168.255.255 scope global eth1</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure>


<h3 id="dockerçš„å‡ ç§ç½‘ç»œæ¨¡å¼"><a href="#dockerçš„å‡ ç§ç½‘ç»œæ¨¡å¼" class="headerlink" title="dockerçš„å‡ ç§ç½‘ç»œæ¨¡å¼"></a>dockerçš„å‡ ç§ç½‘ç»œæ¨¡å¼</h3><h4 id="hostæ¨¡å¼"><a href="#hostæ¨¡å¼" class="headerlink" title="hostæ¨¡å¼"></a>hostæ¨¡å¼</h4><p>å½“æˆ‘ä»¬åœ¨å®¹å™¨ä¸­æ‰§è¡Œä»»ä½•ç±»ä¼¼ifconfigå‘½ä»¤æŸ¥çœ‹ç½‘ç»œç¯å¢ƒæ—¶ï¼Œçœ‹åˆ°çš„éƒ½æ˜¯å®¿ä¸»æœºä¸Šçš„ä¿¡æ¯ã€‚è€Œå¤–ç•Œè®¿é—®å®¹å™¨ä¸­çš„åº”ç”¨ï¼Œåˆ™ç›´æ¥ä½¿ç”¨10.10.101.105:80å³å¯ï¼Œä¸ç”¨ä»»ä½•NATè½¬æ¢ï¼Œå°±å¦‚ç›´æ¥è·‘åœ¨å®¿ä¸»æœºä¸­ä¸€æ ·ã€‚ä½†æ˜¯ï¼Œå®¹å™¨çš„å…¶ä»–æ–¹é¢ï¼Œå¦‚æ–‡ä»¶ç³»ç»Ÿã€è¿›ç¨‹åˆ—è¡¨ç­‰è¿˜æ˜¯å’Œå®¿ä¸»æœºéš”ç¦»çš„ã€‚</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> å’Œhostä¸€æ ·ï¼Œå…±äº«</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> docker <span class="built_in">exec</span> -it bb-host ip ad</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue qlen 1000</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel qlen 1000</span><br><span class="line">    link/ether 52:54:00:27:8b:50 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 10.0.2.15/24 brd 10.0.2.255 scope global dynamic eth0</span><br><span class="line">       valid_lft 44372sec preferred_lft 44372sec</span><br><span class="line">    inet6 fe80::5054:ff:fe27:8b50/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">3: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue</span><br><span class="line">    link/ether 02:42:95:5a:03:dc brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::42:95ff:fe5a:3dc/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">42: br-49025b4d0eaa: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue</span><br><span class="line">    link/ether 02:42:ad:cf:bc:6f brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.0.1/16 brd 192.168.255.255 scope global br-49025b4d0eaa</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::42:adff:fecf:bc6f/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure>
<h4 id="containeræ¨¡å¼"><a href="#containeræ¨¡å¼" class="headerlink" title="containeræ¨¡å¼"></a>containeræ¨¡å¼</h4><p>è¿™ä¸ªæ¨¡å¼æŒ‡å®šæ–°åˆ›å»ºçš„å®¹å™¨å’Œå·²ç»å­˜åœ¨çš„ä¸€ä¸ªå®¹å™¨å…±äº«ä¸€ä¸ªNetwork Namespaceï¼Œè€Œä¸æ˜¯å’Œå®¿ä¸»æœºå…±äº«ã€‚æ–°åˆ›å»ºçš„å®¹å™¨ä¸ä¼šåˆ›å»ºè‡ªå·±çš„ç½‘å¡ï¼Œé…ç½®è‡ªå·±çš„IPï¼Œè€Œæ˜¯å’Œä¸€ä¸ªæŒ‡å®šçš„å®¹å™¨å…±äº«IPã€ç«¯å£èŒƒå›´ç­‰ã€‚åŒæ ·ï¼Œä¸¤ä¸ªå®¹å™¨é™¤äº†ç½‘ç»œæ–¹é¢ï¼Œå…¶ä»–çš„å¦‚æ–‡ä»¶ç³»ç»Ÿã€è¿›ç¨‹åˆ—è¡¨ç­‰è¿˜æ˜¯éš”ç¦»çš„ã€‚ä¸¤ä¸ªå®¹å™¨çš„è¿›ç¨‹å¯ä»¥é€šè¿‡loç½‘å¡è®¾å¤‡é€šä¿¡ã€‚</p>
<h4 id="noneæ¨¡å¼"><a href="#noneæ¨¡å¼" class="headerlink" title="noneæ¨¡å¼"></a>noneæ¨¡å¼</h4><p>è¿™ä¸ªæ¨¡å¼å’Œå‰ä¸¤ä¸ªä¸åŒã€‚åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼ŒDockerå®¹å™¨æ‹¥æœ‰è‡ªå·±çš„Network Namespaceï¼Œä½†æ˜¯ï¼Œå¹¶ä¸ä¸ºDockerå®¹å™¨è¿›è¡Œä»»ä½•ç½‘ç»œé…ç½®ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™ä¸ªDockerå®¹å™¨æ²¡æœ‰ç½‘å¡ã€IPã€è·¯ç”±ç­‰ä¿¡æ¯ã€‚éœ€è¦æˆ‘ä»¬è‡ªå·±ä¸ºDockerå®¹å™¨æ·»åŠ ç½‘å¡ã€é…ç½®IPç­‰ã€‚</p>
<h4 id="bridgeæ¨¡å¼"><a href="#bridgeæ¨¡å¼" class="headerlink" title="bridgeæ¨¡å¼"></a>bridgeæ¨¡å¼</h4><p>bridgeæ¨¡å¼æ˜¯Dockeré»˜è®¤çš„ç½‘ç»œè®¾ç½®ï¼Œå°±æ˜¯docker0çš„æ¨¡å¼ã€‚æ­¤æ¨¡å¼ä¼šä¸ºæ¯ä¸€ä¸ªå®¹å™¨åˆ†é…Network Namespaceã€è®¾ç½®IPç­‰ï¼Œå¹¶å°†ä¸€ä¸ªä¸»æœºä¸Šçš„Dockerå®¹å™¨è¿æ¥åˆ°ä¸€ä¸ªè™šæ‹Ÿç½‘æ¡¥ä¸Šã€‚</p>
<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><ul>
<li><p>Docker0ï¼šé»˜è®¤ç½‘ç»œï¼Œç¼ºç‚¹æ˜¯ä¸èƒ½é€šè¿‡å®¹å™¨åè®¿é—®ã€‚</p>
</li>
<li><p>â€“linkå¯ä»¥è§£å†³ï¼Œä½†æ˜¯å¤ªéº»çƒ¦ï¼Œæ˜¯å•å‘çš„ã€‚</p>
</li>
<li><p>ä¸€èˆ¬éœ€è¦è‡ªå®šä¹‰ç½‘ç»œï¼Œè¿™ä¸ªå¯ä»¥é€šè¿‡å®¹å™¨åè®¿é—®ã€‚</p>
</li>
<li><p>å¦‚æœä¸åŒç½‘ç»œé‡Œçš„å®¹å™¨éœ€è¦äº’è”ï¼Œåˆ™éœ€è¦<code>docker network connect</code>ï¼Œè¿™ä¸ªå‘½ä»¤å¯ä»¥æŠŠnetwork1ä¸­çš„å®¹å™¨è¿æ¥åˆ°network2ä¸­ï¼Œæ­¤æ—¶å®¹å™¨æœ‰ä¸¤ä¸ªIPï¼Œåˆ†åˆ«å¯¹åº”network1å’Œ2ã€‚</p>
</li>
</ul>
]]></content>
      <categories>
        <category>docker</category>
      </categories>
      <tags>
        <tag>docker</tag>
        <tag>network</tag>
      </tags>
  </entry>
  <entry>
    <title>å®¹å™¨volumeåŸºæœ¬ä»‹ç»</title>
    <url>/posts/4b81a639.html</url>
    <content><![CDATA[<h2 id="å®¹å™¨volume"><a href="#å®¹å™¨volume" class="headerlink" title="å®¹å™¨volume"></a>å®¹å™¨volume</h2><h3 id="åŒ¿åæŒ‚è½½ï¼Œå…·åæŒ‚è½½å’ŒæŒ‡å®šè·¯å¾„æŒ‚è½½"><a href="#åŒ¿åæŒ‚è½½ï¼Œå…·åæŒ‚è½½å’ŒæŒ‡å®šè·¯å¾„æŒ‚è½½" class="headerlink" title="åŒ¿åæŒ‚è½½ï¼Œå…·åæŒ‚è½½å’ŒæŒ‡å®šè·¯å¾„æŒ‚è½½"></a>åŒ¿åæŒ‚è½½ï¼Œå…·åæŒ‚è½½å’ŒæŒ‡å®šè·¯å¾„æŒ‚è½½</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> åŒ¿åæŒ‚è½½</span></span><br><span class="line">-v å®¹å™¨å†…è·¯å¾„</span><br><span class="line">docker run -d -P --name nginx01 -v /etc/nginx nginx</span><br><span class="line"><span class="meta">#</span><span class="bash"> æŸ¥çœ‹node ä¸Šçš„volume</span></span><br><span class="line">ubuntu@xinrantest01:~$ docker volume ls</span><br><span class="line">DRIVER              VOLUME NAME</span><br><span class="line">local               cf411242c0f1d323d2d2ab8a81d144caa6d536d992954231f426c35221adf2e3</span><br><span class="line"><span class="meta">#</span><span class="bash"> å¯ä»¥å‘ç°ï¼ŒåŒ¿åæŒ‚è½½åªå†™å®¹å™¨é‡Œçš„è·¯å¾„ï¼Œæ²¡æœ‰å†™hostä¸Šçš„è·¯å¾„</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> å…·åæŒ‚è½½</span></span><br><span class="line">-v hostè·¯å¾„ï¼šå®¹å™¨å†…è·¯å¾„ ï¼ˆä¸-pç›¸ä¼¼ï¼‰</span><br><span class="line">ubuntu@xinrantest01:~$ docker run -d -P --name nginx02 -v juming-nginx:/etc/nginx nginx</span><br><span class="line">5f61a3a6d01cd8db3bd99fa1738d0b6cfc74df366dc8ba8b1f4cbe0c97b2cc72</span><br><span class="line">ubuntu@xinrantest01:~$ docker volume ls</span><br><span class="line">DRIVER              VOLUME NAME</span><br><span class="line">local               cf411242c0f1d323d2d2ab8a81d144caa6d536d992954231f426c35221adf2e3</span><br><span class="line">local               juming-nginx</span><br><span class="line"><span class="meta">#</span><span class="bash">è¿™é‡ŒæŒ‡å®šäº†juming-nginxä¸ºhostä¸Šè¦æŒ‚è½½çš„ç›®å½•ï¼Œè¿™ä¸ªç›®å½•åœ¨docker runæ—¶è¢«åˆ›å»º</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> æŸ¥çœ‹volumeåœ¨hostä¸Šçš„è·¯å¾„</span></span><br></pre></td></tr></table></figure>
<p><img src="/posts/4b81a639/image-20210128164757688.png" alt="image-20210128164757688"></p>
<p><img src="/posts/4b81a639/image-20210128164837865.png" alt="image-20210128164837865"></p>
<p>æ‰€æœ‰docker å®¹å™¨å†…çš„å·ï¼Œæ²¡æœ‰æŒ‡å®šç›®å½•çš„æƒ…å†µä¸‹ï¼Œéƒ½æ˜¯åœ¨<code>/var/lib/docker/volumes/xxxx/_data</code></p>
<p>å¤§å¤šæ•°æƒ…å†µéƒ½æ˜¯ä½¿ç”¨å…·åæŒ‚è½½ï¼Œæ–¹ä¾¿åœ¨hostä¸ŠæŸ¥æ‰¾volumes</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> å¦‚ä½•ç¡®å®šæŒ‚è½½æ–¹å¼</span></span><br><span class="line">-v container-path    # åŒ¿åæŒ‚è½½</span><br><span class="line">-v host-pathï¼šcontainer-path # æŒ‡å®šè·¯å¾„æŒ‚è½½</span><br><span class="line">-v volume-nameï¼ˆä¸´æ—¶èµ·çš„ï¼‰ï¼šcontainer-path #å…·åæŒ‚è½½</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> é™å®šå®¹å™¨çš„æƒé™</span></span><br><span class="line">docker run -d -P --name nginx02 -v juming-nginx:/etc/nginx:ro   nginx</span><br><span class="line">docker run -d -P --name nginx02 -v juming-nginx:/etc/nginx:rw   nginx</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> ro è¿™ä¸ªvolumeåªèƒ½é€šè¿‡hostæ¥æ“ä½œï¼Œcontaineré‡Œåªæœ‰<span class="built_in">read</span> onlyçš„æƒé™</span></span><br></pre></td></tr></table></figure>
<h3 id="ç”¨DockerFileå®ç°volume"><a href="#ç”¨DockerFileå®ç°volume" class="headerlink" title="ç”¨DockerFileå®ç°volume"></a>ç”¨DockerFileå®ç°volume</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> create a dockerfile</span></span><br><span class="line">FROM centos</span><br><span class="line"></span><br><span class="line">VOLUME [&quot;volume01&quot;,&quot;volume02&quot;&quot;]</span><br><span class="line"></span><br><span class="line">CMD echo &quot;===end===&quot;</span><br><span class="line">CMD /bin/bash</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<img src="/posts/4b81a639/image-20210128170911709.png" alt="image-20210128170911709" style="zoom:80%;">

<p>å¯ä»¥é€šè¿‡åœ¨<code>var/lib/docker/volumes/</code>è·¯å¾„ä¸‹æŸ¥çœ‹å¯¹åº”çš„ç›®å½•ï¼š</p>
<p><img src="/posts/4b81a639/image-20210128171143827.png" alt="image-20210128171143827"></p>
<h3 id="æ•°æ®å·å®¹å™¨"><a href="#æ•°æ®å·å®¹å™¨" class="headerlink" title="æ•°æ®å·å®¹å™¨"></a>æ•°æ®å·å®¹å™¨</h3><p>è¦å®¹å™¨ä¸å®¹å™¨ä¹‹é—´åŒæ­¥æ•°æ®ã€‚</p>
<img src="/posts/4b81a639/image-20210128171813726.png" alt="image-20210128171813726" style="zoom:60%;">

<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> å¯åŠ¨æ•°æ®å·å®¹å™¨docker01</span></span><br><span class="line">docker run -it --name docker01 xinran/centos:1.0</span><br><span class="line"><span class="meta">#</span><span class="bash"> å¯åŠ¨å¤šä¸ªâ€œçˆ¶å®¹å™¨â€docker02ï¼Œdocker03ï¼Œç”¨--volumes-fromæŒ‡å®šæ•°æ®å·å®¹å™¨</span></span><br><span class="line">docker run -it --name docker02  --volumes-from docker01 xinran/centos:1.0</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> å¯ä»¥æŒ‡å®šdocker02æˆ–è€…docker01ä¸ºæ•°æ®å·å®¹å™¨ï¼Œè¿™å‡ ä¸ªå®¹å™¨ä¸­volumeséƒ½æ˜¯åŒæ­¥çš„</span></span><br><span class="line">docker run -it --name docker03  --volumes-from docker02 xinran/centos:1.0</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> åˆ é™¤docker01ï¼Œä¹Ÿä¸ä¼šå½±å“docker02ï¼Œdocker03çš„volume</span></span><br></pre></td></tr></table></figure>


<p><img src="/posts/4b81a639/image-20210128172515580.png" alt="image-20210128172515580"></p>
<p>ç»“è®ºï¼šå®¹å™¨ä¹‹é—´é…ç½®ä¿¡æ¯çš„ä¼ é€’ï¼Œæ•°æ®å·å®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸä¸€ç›´æŒç»­åˆ°æ²¡æœ‰å®¹å™¨ä½¿ç”¨ä¸ºæ­¢ã€‚</p>
<p>ä½†æ˜¯ä¸€æ—¦æŒä¹…è¯åˆ°äº†æœ¬åœ°ï¼Œå³ä½¿åˆ é™¤äº†æ‰€æœ‰æœ‰è¿™ä¸ªvolumeçš„å®¹å™¨ï¼Œæœ¬åœ°çš„æ•°æ®æ˜¯ä¸ä¼šåˆ é™¤çš„ã€‚</p>
]]></content>
      <categories>
        <category>docker</category>
      </categories>
      <tags>
        <tag>docker</tag>
      </tags>
  </entry>
  <entry>
    <title>ebpf-intro</title>
    <url>/posts/85f2c2fa.html</url>
    <content><![CDATA[<p>bpf - bakerly profiling filter</p>
<p>æœ€æ—©æ˜¯æŠ“åŒ…ç”¨çš„ï¼Œæœ€ç»å…¸çš„åº”ç”¨ï¼štcpdumpå°±ç”¨bpfã€‚</p>
<p>æ²¡æœ‰bpfä¹‹å‰ï¼ŒæŠ“åŒ…è¦æŠ“nicä¸Šæ‰€æœ‰çš„åŒ…ï¼Œç„¶åå†è¿›è¡Œåˆ†æ</p>
<p>æœ‰äº†bpfä¹‹åï¼Œå¯ä»¥æ’å…¥ä¸€æ®µå°çš„ä»£ç å¯ä»¥æŒ‡å®štcp portï¼Œipç­‰ã€‚</p>
<p>ebpf - extension bpf</p>
<p>ä¸»è¦åšç½‘ç»œï¼Œä½†è¿œä¸æ­¢ç½‘ç»œé¢†åŸŸã€‚å¯ä»¥æŠ“system callï¼Œlinux kernelçš„function call</p>
<p>kprobe -&gt; fetch kernel</p>
<p>uprobe -&gt; fetch user space</p>
<p>perf events</p>
<p>XDP/AF_XDP</p>
<p>bpf vs ebpf vm - &gt; java vm / webassembly</p>
<p>c  -&gt; ç¼–è¯‘æˆebpf backend  -&gt; kernel native??</p>
<p>ç¨‹åºæ–¹é¢ï¼š</p>
<p>bpfåªæœ‰ä¸¤ä¸ª32bitå¯„å­˜å™¨ï¼Œ16ä¸ª32bitå†…å­˜</p>
<p>ebpfæœ‰11ä¸ª64bitå¯„å­˜å™¨ï¼Œ512ä¸ªstackã€‚æ²¡æœ‰å †çš„æ¦‚å¿µï¼Œå› ä¸ºåœ¨ebpfé‡Œé¢ä¸èƒ½newã€‚</p>
<p><img src="/posts/85f2c2fa/image-20210423154407377.png" alt="image-20210423154407377"></p>
<p>mapsï¼šuser space /kernel space shares data through maps (k-v)ã€‚</p>
<p>bpftrace vs bcc vs c program </p>
]]></content>
  </entry>
  <entry>
    <title>hexo+github</title>
    <url>/posts/ebeabd53.html</url>
    <content><![CDATA[<h3 id="å®‰è£…nodejsï¼Œgit"><a href="#å®‰è£…nodejsï¼Œgit" class="headerlink" title="å®‰è£…nodejsï¼Œgit"></a>å®‰è£…nodejsï¼Œgit</h3><figure class="highlight cmake"><table><tr><td class="code"><pre><span class="line">sudo apt <span class="keyword">install</span> npm</span><br><span class="line">sudo apt <span class="keyword">install</span> nodejs</span><br><span class="line">sudo apt <span class="keyword">install</span> git</span><br></pre></td></tr></table></figure>
<h3 id="æ³¨å†Œgithubå¸å·ï¼Œåˆ›å»ºgithub-repoï¼Œå‘½åä¸ºxxinran-github-io"><a href="#æ³¨å†Œgithubå¸å·ï¼Œåˆ›å»ºgithub-repoï¼Œå‘½åä¸ºxxinran-github-io" class="headerlink" title="æ³¨å†Œgithubå¸å·ï¼Œåˆ›å»ºgithub repoï¼Œå‘½åä¸ºxxinran.github.io"></a>æ³¨å†Œgithubå¸å·ï¼Œåˆ›å»ºgithub repoï¼Œå‘½åä¸º<code>xxinran.github.io</code></h3><h3 id="å®‰è£…Hexo"><a href="#å®‰è£…Hexo" class="headerlink" title="å®‰è£…Hexo"></a>å®‰è£…Hexo</h3><figure class="highlight avrasm"><table><tr><td class="code"><pre><span class="line">sudo npm install -g hexo-<span class="keyword">cli</span></span><br></pre></td></tr></table></figure>
<p>æ£€æŸ¥å„é¡¹éƒ½å·²ç»æˆåŠŸå®‰è£…ï¼š</p>
<figure class="highlight crmsh"><table><tr><td class="code"><pre><span class="line"><span class="keyword">node</span> <span class="title">-v</span></span><br><span class="line">hexo -v</span><br></pre></td></tr></table></figure>
<h3 id="åˆ›å»ºæœ¬åœ°åšå®¢çš„repo"><a href="#åˆ›å»ºæœ¬åœ°åšå®¢çš„repo" class="headerlink" title="åˆ›å»ºæœ¬åœ°åšå®¢çš„repo"></a>åˆ›å»ºæœ¬åœ°åšå®¢çš„repo</h3><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">hexo <span class="keyword">init</span> blog</span><br></pre></td></tr></table></figure>
<p>è¿è¡Œååœ¨å½“å‰ç›®å½•ä¸‹ä¼šç”Ÿæˆä¸€ä¸ªblogç›®å½•ã€‚æœªæ¥æ‰€æœ‰çš„åšå®¢ä¸»é¢˜ï¼Œåšæ–‡ï¼Œé…ç½®éƒ½åœ¨è¿™ä¸ªç›®å½•é‡Œã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> blog</span><br></pre></td></tr></table></figure>
<p>ä¼šå‘ç°ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š</p>
<figure class="highlight haxe"><table><tr><td class="code"><pre><span class="line">â”œâ”€â”€ _config.yml  <span class="meta"># hexoçš„é…ç½®æ–‡ä»¶ï¼Œä¸»é¢˜ï¼Œæ ‡é¢˜ï¼Œæ ¼å¼ç­‰éƒ½åœ¨è¿™é‡ŒæŒ‡å®š</span></span><br><span class="line">â”œâ”€â”€ db.json</span><br><span class="line">â”œâ”€â”€ node_modules/</span><br><span class="line">â”œâ”€â”€ <span class="keyword">package</span>.json</span><br><span class="line">â”œâ”€â”€ <span class="keyword">package</span>-lock.json</span><br><span class="line">â”œâ”€â”€ <span class="keyword">public</span>/</span><br><span class="line">â”œâ”€â”€ scaffolds/</span><br><span class="line">â”œâ”€â”€ source/ <span class="meta"># åšå®¢çš„é™æ€é¡µé¢çš„æºæ–‡ä»¶ï¼Œåšæ–‡çš„mdæ–‡ä»¶å°±å­˜æ”¾åœ¨è¿™é‡Œ</span></span><br><span class="line">â””â”€â”€ themes/ <span class="meta"># å­˜æ”¾å„ç§ä¸»é¢˜çš„æºç </span></span><br></pre></td></tr></table></figure>
<p>æ¥ä¸‹æ¥åœ¨<code>blog</code>ç›®å½•ä¸‹è¿è¡Œ<code>npm install</code> æ¥å®‰è£…hexoæ‰€éœ€çš„ä¾èµ–ã€‚</p>
<p>åœ¨<code>blog/source/_posts/hello-world.md</code>é‡Œæœ‰ä¸€ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬å…ˆç”¨è¿™ä¸ªä¾‹å­ï¼Œçœ‹çœ‹æ•ˆæœï¼Œè¿è¡Œï¼š</p>
<figure class="highlight axapta"><table><tr><td class="code"><pre><span class="line">hexo <span class="keyword">server</span> </span><br><span class="line">or</span><br><span class="line">hexo s</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°Hexoè¿è¡Œåœ¨æœ¬åœ°çš„4000ç«¯å£ï¼Œåœ¨æµè§ˆå™¨ä¸­è®¿é—®<code>localhost:4000</code>ï¼Œå°±ä¼šçœ‹åˆ°ä¸Šè¿°hello-worldçš„ç¤ºä¾‹é¡µé¢ã€‚</p>
<p>æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ <code>hexo new first-try</code>å»åˆ›å»ºä¸€ä¸ªæ–°çš„mdæ–‡ä»¶ï¼Œå¯ä»¥åœ¨è¿™ä¸ªmdæ–‡ä»¶é‡Œå†™åšæ–‡ï¼Œè¿™æ—¶åœ¨4000ç«¯å£æˆ‘ä»¬å°±å¯ä»¥çœ‹åˆ°æ–°çš„åšæ–‡ã€‚ï¼ˆåº”è¯¥æ˜¯éœ€è¦é‡æ–°è¿è¡Œ<code>hexo s</code>ï¼Œè¿™é‡Œæ²¡æœ‰éªŒè¯ï¼‰</p>
<h3 id="è¿æ¥gihubå’Œhexo"><a href="#è¿æ¥gihubå’Œhexo" class="headerlink" title="è¿æ¥gihubå’Œhexo"></a>è¿æ¥gihubå’Œhexo</h3><h4 id="ä¸Šä¼ SSHå…¬é’¥"><a href="#ä¸Šä¼ SSHå…¬é’¥" class="headerlink" title="ä¸Šä¼ SSHå…¬é’¥"></a>ä¸Šä¼ SSHå…¬é’¥</h4><figure class="highlight oxygene"><table><tr><td class="code"><pre><span class="line">ssh-keygen</span><br><span class="line"># <span class="keyword">copy</span> ssh <span class="keyword">public</span> <span class="keyword">to</span> Github Account</span><br></pre></td></tr></table></figure>
<p>è¾“å…¥<code>ssh -T git@github.com</code>ï¼Œæµ‹è¯•æ·»åŠ sshæ˜¯å¦æˆåŠŸã€‚å¦‚æœçœ‹åˆ°Hiåé¢æ˜¯ä½ çš„ç”¨æˆ·åï¼Œå°±è¯´æ˜æˆåŠŸäº†.</p>
<h4 id="åœ¨Hexoçš„é…ç½®æ–‡ä»¶ä¸­æŒ‡å®šå‘Github-Pageéƒ¨ç½²"><a href="#åœ¨Hexoçš„é…ç½®æ–‡ä»¶ä¸­æŒ‡å®šå‘Github-Pageéƒ¨ç½²" class="headerlink" title="åœ¨Hexoçš„é…ç½®æ–‡ä»¶ä¸­æŒ‡å®šå‘Github Pageéƒ¨ç½²"></a>åœ¨Hexoçš„é…ç½®æ–‡ä»¶ä¸­æŒ‡å®šå‘Github Pageéƒ¨ç½²</h4><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">vim ï½<span class="regexp">/blog/</span>_config.yml</span><br></pre></td></tr></table></figure>
<p>åœ¨deployé€‰é¡¹ä¸­å¡«å†™Githubä¿¡æ¯ï¼Œ ä¾‹å¦‚ï¼š</p>
<figure class="highlight less"><table><tr><td class="code"><pre><span class="line"><span class="attribute">deploy</span>:</span><br><span class="line"><span class="attribute">type</span>: git</span><br><span class="line"><span class="attribute">repository</span>: git<span class="variable">@github</span>.<span class="attribute">com</span>:xxinran/xxinran.github.io.git</span><br><span class="line"><span class="attribute">branch</span>: main # åŸæ¥æ˜¯master</span><br></pre></td></tr></table></figure>
<h4 id="ç”Ÿæˆé™æ€æ–‡ä»¶ï¼Œå¹¶éƒ¨ç½²åˆ°gihubä¸Šå»ã€‚"><a href="#ç”Ÿæˆé™æ€æ–‡ä»¶ï¼Œå¹¶éƒ¨ç½²åˆ°gihubä¸Šå»ã€‚" class="headerlink" title="ç”Ÿæˆé™æ€æ–‡ä»¶ï¼Œå¹¶éƒ¨ç½²åˆ°gihubä¸Šå»ã€‚"></a>ç”Ÿæˆé™æ€æ–‡ä»¶ï¼Œå¹¶éƒ¨ç½²åˆ°gihubä¸Šå»ã€‚</h4><figure class="highlight verilog"><table><tr><td class="code"><pre><span class="line"># <span class="keyword">generate</span> <span class="keyword">static</span> files</span><br><span class="line">hexo <span class="keyword">generate</span></span><br><span class="line"><span class="keyword">or</span> </span><br><span class="line">hexo g</span><br><span class="line"></span><br><span class="line"># deploy to Github</span><br><span class="line">hexo deploy</span><br><span class="line"><span class="keyword">or</span></span><br><span class="line">hexo d</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸€æ­¥æœ‰å¯èƒ½ä¼šæŠ¥é”™<code>Deployer not found: git</code>ï¼š</p>
<ul>
<li>éœ€è¦å®‰è£…<code>npm install hexo-deployer-git --save</code>ã€‚</li>
<li>éœ€è¦é…ç½®gitconfigã€‚</li>
</ul>
<h4 id="æ‰“å¼€Github-PageéªŒè¯ã€‚"><a href="#æ‰“å¼€Github-PageéªŒè¯ã€‚" class="headerlink" title="æ‰“å¼€Github PageéªŒè¯ã€‚"></a>æ‰“å¼€<a href="https://xxinran.github.io/">Github Page</a>éªŒè¯ã€‚</h4><h3 id="Notes"><a href="#Notes" class="headerlink" title="Notes"></a>Notes</h3><ul>
<li>æ¯æ¬¡ä¿®æ”¹å®Œblogçš„é…ç½®ï¼Œæˆ–è€…æ–°å»ºåˆ é™¤postï¼Œdraftç­‰ï¼Œéƒ½éœ€è¦å…ˆ<code>hexo clean</code>ï¼Œåœ¨é‡æ–°<code>hexo g &amp; hexo d</code>ã€‚</li>
</ul>
<blockquote>
<p> å‚è€ƒæ–‡æ¡£ï¼š <a href="https://hexo.io/zh-cn/docs/configuration.html">https://hexo.io/zh-cn/docs/configuration.html</a><br> <a href="https://zhuanlan.zhihu.com/p/71164003">https://zhuanlan.zhihu.com/p/71164003</a></p>
</blockquote>
<h1 id="ä¸»é¢˜é…ç½®"><a href="#ä¸»é¢˜é…ç½®" class="headerlink" title="ä¸»é¢˜é…ç½®"></a>ä¸»é¢˜é…ç½®</h1><ul>
<li>åœ¨blogç›®å½•ä¸‹æ‹‰å–æƒ³è¦åº”ç”¨çš„ä¸»é¢˜</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">git clone https://github.com/iissnan/hexo-theme-next themes/next</span><br></pre></td></tr></table></figure>
<ul>
<li><p>æ‰“å¼€ç«™ç‚¹é…ç½®æ–‡ä»¶ _config.ymlï¼Œæ‰¾åˆ° theme å­—æ®µï¼Œå¹¶å°†å…¶å€¼æ›´æ”¹ä¸º nextã€‚</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">theme: next</span><br></pre></td></tr></table></figure></li>
<li><p>åˆ‡æ¢Schema</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">scheme: Pisces</span><br></pre></td></tr></table></figure></li>
<li><p>æ›´æ–°githubä¸Šçš„ä¸»é¢˜</p>
<p>æ”¹å®Œé…ç½®ä¹‹åéƒ½è¦è¿è¡Œhexo clean &amp; hexo generate &amp; hexo deployï¼Œä¸ºäº†æ–¹ä¾¿ï¼Œå¯ä»¥åœ¨blogç›®å½•ä¸‹åŠ å…¥ä¸€ä¸ªæ–°çš„è„šæœ¬deploy.shï¼š</p>
<blockquote>
<p>è¿™é‡Œæ¶‰åŠåˆ° â€œpush hexo codeâ€, åœ¨å¤šè®¾å¤‡ç®¡ç†ä¸­ä¼šè®²åˆ° ï¼‰</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">DIR=`dirname $0`</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Generate blog</span></span><br><span class="line">echo &quot;Generate and deploy...&quot;</span><br><span class="line">hexo clean</span><br><span class="line">hexo generate &amp; hexo deploy</span><br><span class="line"><span class="meta">#</span><span class="bash"> hexo d -g</span></span><br><span class="line"></span><br><span class="line">sleep 10</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Push hexo code</span></span><br><span class="line">echo &quot;Push hexo code&quot;</span><br><span class="line">git add .</span><br><span class="line">current_date=`date &quot;+%Y-%m-%d %H:%M:%S&quot;`</span><br><span class="line">git commit -m &quot;Blog updated: $current_date&quot;</span><br><span class="line"></span><br><span class="line">sleep 2</span><br><span class="line">git push origin hexo</span><br><span class="line"></span><br><span class="line">echo &quot;=====&gt;Finish!&lt;=====&quot;</span><br></pre></td></tr></table></figure></li>
<li><p>æ›´æ–°è„šæœ¬æƒé™ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">chmod 755 deploy.sh</span><br></pre></td></tr></table></figure>
<p>ä»¥åæ¯æ¬¡æ¨é€åªè¦è¿è¡Œ./deploy.shå³å¯ã€‚</p>
</li>
</ul>
]]></content>
      <categories>
        <category>hexo</category>
      </categories>
      <tags>
        <tag>hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>éƒ¨ç½²istio+k8s+kiali</title>
    <url>/posts/f5beba55.html</url>
    <content><![CDATA[<h3 id="ç¯å¢ƒï¼š"><a href="#ç¯å¢ƒï¼š" class="headerlink" title="ç¯å¢ƒï¼š"></a>ç¯å¢ƒï¼š</h3><p>ubuntu20.04</p>
<p>kubernete 1.20</p>
<h3 id="Deploy-K8s-all-in-one-using-Kubeadm"><a href="#Deploy-K8s-all-in-one-using-Kubeadm" class="headerlink" title="Deploy K8s(all in one) using Kubeadm"></a>Deploy K8s(all in one) using Kubeadm</h3><h4 id="Install-docker"><a href="#Install-docker" class="headerlink" title="Install docker"></a>Install docker</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo apt-get install docker.io</span><br><span class="line">sudo groupadd docker</span><br><span class="line">sudo usermod -aG docker <span class="variable">$&#123;USER&#125;</span>  <span class="comment"># To resolve permission errors</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># check </span></span><br><span class="line">docker ps -a</span><br><span class="line"></span><br><span class="line"><span class="comment"># docker hub login</span></span><br><span class="line">docker login</span><br><span class="line">username: xinranwang</span><br><span class="line">password: xxxxxxXf</span><br></pre></td></tr></table></figure>
<h4 id="Install-Kubeadm"><a href="#Install-Kubeadm" class="headerlink" title="Install Kubeadm"></a>Install Kubeadm</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo apt-get update &amp;&amp; sudo apt-get install -y apt-transport-https curl</span><br><span class="line">curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key add -</span><br><span class="line">cat &lt;&lt;EOF | sudo tee /etc/apt/sources.list.d/kubernetes.list</span><br><span class="line">deb https://apt.kubernetes.io/ kubernetes-xenial main</span><br><span class="line">EOF</span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install -y kubelet kubeadm kubectl</span><br><span class="line">sudo apt-mark hold kubelet kubeadm kubectl</span><br></pre></td></tr></table></figure>
<h4 id="Run-kubeadm"><a href="#Run-kubeadm" class="headerlink" title="Run kubeadm"></a>Run kubeadm</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo kubeadm init --pod-network-cidr=192.168.0.0/16</span><br><span class="line"></span><br><span class="line">mkdir -p $HOME/.kube</span><br><span class="line">sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><br><span class="line">sudo chown $(id -u):$(id -g) $HOME/.kube/config</span><br></pre></td></tr></table></figure>
<h4 id="Install-Calico"><a href="#Install-Calico" class="headerlink" title="Install Calico"></a>Install Calico</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">kubectl create -f https://docs.projectcalico.org/manifests/tigera-operator.yaml</span><br><span class="line">kubectl create -f https://docs.projectcalico.org/manifests/custom-resources.yaml</span><br><span class="line">watch kubectl get pods -n calico-system</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> untaint master node</span></span><br><span class="line">kubectl taint nodes --all node-role.kubernetes.io/master-</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> check</span></span><br><span class="line">kubectl get nodes -o wide</span><br></pre></td></tr></table></figure>
<h4 id="Install-Istio"><a href="#Install-Istio" class="headerlink" title="Install Istio"></a>Install Istio</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">curl -L https://istio.io/downloadIstio | sh -</span><br><span class="line">export PATH=&quot;$PATH:/home/ubuntu/istio-1.9.0/bin&quot;</span><br><span class="line">cd istio-1.9.0</span><br><span class="line">istioctl install </span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> all pods <span class="keyword">in</span> <span class="string">&quot;default&quot;</span> ns will have the sidecar</span></span><br><span class="line">kubectl label namespace default istio-injection=enabled</span><br></pre></td></tr></table></figure>
<h4 id="Deploy-sample"><a href="#Deploy-sample" class="headerlink" title="Deploy sample"></a>Deploy sample</h4><p><a href="https://istio.io/latest/docs/setup/getting-started/#bookinfo">https://istio.io/latest/docs/setup/getting-started/#bookinfo</a></p>
<p><img src="/posts/f5beba55/image-20210303143623822.png" alt="image-20210303143623822"></p>
<p>æœ¬æœºä¸Šï¼ˆé›†ç¾¤å†…ï¼‰ï¼Œå¯ä»¥é€šè¿‡cluster IPè®¿é—®ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> curl 10.106.23.203:9080</span></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">  &lt;head&gt;</span><br><span class="line">    &lt;title&gt;Simple Bookstore App&lt;/title&gt;</span><br><span class="line">&lt;meta charset=&quot;utf-8&quot;&gt;</span><br><span class="line">&lt;meta http-equiv=&quot;X-UA-Compatible&quot; content=&quot;IE=edge&quot;&gt;</span><br><span class="line">&lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1&quot;&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- Latest compiled and minified CSS --&gt;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>


<h5 id="é›†ç¾¤å¤–è®¿é—®æœåŠ¡"><a href="#é›†ç¾¤å¤–è®¿é—®æœåŠ¡" class="headerlink" title="é›†ç¾¤å¤–è®¿é—®æœåŠ¡"></a>é›†ç¾¤å¤–è®¿é—®æœåŠ¡</h5><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl apply -f samples/bookinfo/networking/bookinfo-gateway.yaml</span></span><br><span class="line">gateway.networking.istio.io/bookinfo-gateway created</span><br><span class="line">virtualservice.networking.istio.io/bookinfo created</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> istioctl analyze</span></span><br><span class="line">âœ” No validation issues found when analyzing namespace: default.</span><br></pre></td></tr></table></figure>
<p><img src="/posts/f5beba55/image-20210303144837821.png" alt="image-20210303144837821"></p>
<p>å› ä¸ºæˆ‘çš„ç³»ç»Ÿä¸æ”¯æŒexternal loadbalancerï¼Œæ‰€ä»¥è¦é€šè¿‡nodeportçš„æ–¹å¼æš´éœ²hostçš„æ¥å£ï¼Œæ‰å¯ä»¥åœ¨æœ¬æœºç”¨<code>localhost:nodeport</code>æ¥è®¿é—®ã€‚</p>
<img src="/posts/f5beba55/image-20210303144916013.png" alt="image-20210303144916013" style="zoom:80%;">

<h4 id="Install-Dashboard"><a href="#Install-Dashboard" class="headerlink" title="Install Dashboard"></a>Install Dashboard</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl apply -f samples/addons $ kubectl rollout status deployment/kiali -n istio-system</span></span><br><span class="line"></span><br><span class="line">Waiting for deployment &quot;kiali&quot; rollout to finish: 0 of 1 updated replicas are available... deployment &quot;kiali&quot; successfully rolled out</span><br></pre></td></tr></table></figure>
 <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> istioctl dashboard kiali</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> å› ä¸ºæ˜¯remote serverï¼Œéœ€è¦å»ºç«‹ä¸€ä¸ªtunnel</span></span><br><span class="line">http://localhost:20001/kiali</span><br><span class="line">Failed to open browser; open http://localhost:20001/kiali in your browser.</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h5 id="å»ºç«‹tunnel"><a href="#å»ºç«‹tunnel" class="headerlink" title="å»ºç«‹tunnel"></a>å»ºç«‹tunnel</h5><p><img src="/posts/f5beba55/image-20210303145356395.png" alt="image-20210303145356395"></p>
<p><img src="/posts/f5beba55/image-20210303145757231.png" alt="image-20210303145757231"></p>
<p>è§£é‡Šä¸Šå›¾ï¼šæŠŠremoteä¸Šçš„æ‰€æœ‰å¼€æ”¾ç«¯å£ï¼Œéƒ½é€šè¿‡è·³æ¿æœºjumperçš„22ç«¯å£è½¬å‘åˆ°æœ¬åœ°æœºå™¨çš„<strong>8888</strong>ç«¯å£ã€‚åœ¨æœ¬åœ°çš„æµè§ˆå™¨é‡Œè®¾ç½®socks proxyï¼Œå°†æœ¬åœ°æœºå™¨çš„è®¿é—®å…¨éƒ¨è½¬å‘åˆ°<strong>8888</strong>ç«¯å£ï¼Œè¿™æ ·å°±å¯ä»¥å®Œæˆé€šè¿‡è·³æ¿æœºçš„ç«¯å£è½¬å‘ã€‚</p>
<h5 id="é—®é¢˜ï¼š"><a href="#é—®é¢˜ï¼š" class="headerlink" title="é—®é¢˜ï¼š"></a>é—®é¢˜ï¼š</h5><p>å³ä½¿æŒ‰ä¸Šè¿°è®¾ç½®äº†ï¼Œè¿˜æ˜¯è®¿é—®ä¸åˆ°kiali dashboardã€‚è¿½æŸ¥åˆ°åŸå› æ˜¯ï¼š</p>
<p><code>~/istio-xxxx/samples/addons/kiali.yaml</code></p>
<p>è¿™ä¸ªæ–‡ä»¶é‡Œå£°æ˜äº†kiali service:</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kiali</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">istio-system</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">helm.sh/chart:</span> <span class="string">kiali-server-1.29.0</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">kiali</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">kiali</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/instance:</span> <span class="string">kiali-server</span></span><br><span class="line">    <span class="attr">version:</span> <span class="string">&quot;v1.29.0&quot;</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/version:</span> <span class="string">&quot;v1.29.0&quot;</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/managed-by:</span> <span class="string">Helm</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/part-of:</span> <span class="string">&quot;kiali&quot;</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">kiali.io/api-spec:</span> <span class="string">https://kiali.io/api</span></span><br><span class="line">    <span class="attr">kiali.io/api-type:</span> <span class="string">rest</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">20001</span></span><br><span class="line">    <span class="attr">nodePort:</span> <span class="number">30007</span>   <span class="comment"># å¢åŠ nodeport</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http-metrics</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">9090</span></span><br><span class="line">    <span class="comment"># nodePort: 30008  # å¢åŠ nodeport</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">kiali</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/instance:</span> <span class="string">kiali-server</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span> <span class="comment"># æŒ‡å®šserviceçš„ç±»å‹æ˜¯nodeportï¼Œè¿™æ ·å¯ä»¥ä»clusterå¤–è®¿é—®ï¼ˆé€šè¿‡hostip/locahostï¼‰</span></span><br></pre></td></tr></table></figure>


<p>å¯ä»¥é€šè¿‡<strong>remote_server_ip:nodeport</strong>è®¿é—®dashboarã€‚</p>
<p><img src="/posts/f5beba55/image-20210303151337851.png" alt="image-20210303151337851"></p>
<h4 id="å¸è½½Uninstall"><a href="#å¸è½½Uninstall" class="headerlink" title="å¸è½½Uninstall"></a>å¸è½½Uninstall</h4><p>Remove sampleâ€˜s resouces: <a href="https://istio.io/latest/docs/examples/bookinfo/#cleanup">https://istio.io/latest/docs/examples/bookinfo/#cleanup</a></p>
<p>Uninstall istio: <a href="https://istio.io/latest/docs/setup/getting-started/#uninstall">https://istio.io/latest/docs/setup/getting-started/#uninstall</a></p>
]]></content>
      <categories>
        <category>deploy</category>
      </categories>
      <tags>
        <tag>service-mesh</tag>
        <tag>deploy</tag>
      </tags>
  </entry>
  <entry>
    <title>istioå¼€å‘ç¯å¢ƒæ­å»º</title>
    <url>/posts/702f5168.html</url>
    <content><![CDATA[<p>ä¹‹å‰æ­å»ºäº†istioçš„ç”Ÿäº§ç¯å¢ƒï¼Œè¿™æ¬¡æ­å»ºå¼€å‘ç¯å¢ƒã€‚</p>
<blockquote>
<p>å‚è€ƒæ–‡æ¡£: <a href="https://github.com/istio/istio/wiki/Preparing-for-Development">https://github.com/istio/istio/wiki/Preparing-for-Development</a></p>
</blockquote>
<h2 id="å»ºç«‹æœ¬åœ°docker-registry"><a href="#å»ºç«‹æœ¬åœ°docker-registry" class="headerlink" title="å»ºç«‹æœ¬åœ°docker registry"></a>å»ºç«‹æœ¬åœ°docker registry</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> æŠŠcontainerçš„5000ç«¯å£ï¼Œæ˜ å°„åˆ°localhost:5000</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> mountyæœ¬åœ°çš„/mnt/docker_imgsåˆ°å®¹å™¨é‡Œçš„/var/lib/registry</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ç”¨å®˜æ–¹çš„registryé•œåƒå³å¯</span></span><br><span class="line">docker run -d   -p 5000:5000   --restart=always   --name registry   -v /mnt/docker_imgs:/var/lib/registry   registry</span><br></pre></td></tr></table></figure>
<h3 id="å®‰è£…Isitoå¼€å‘ç¯å¢ƒ"><a href="#å®‰è£…Isitoå¼€å‘ç¯å¢ƒ" class="headerlink" title="å®‰è£…Isitoå¼€å‘ç¯å¢ƒ"></a>å®‰è£…Isitoå¼€å‘ç¯å¢ƒ</h3><h4 id="è®¾ç½®ä¸€äº›ç¯å¢ƒå˜é‡"><a href="#è®¾ç½®ä¸€äº›ç¯å¢ƒå˜é‡" class="headerlink" title="è®¾ç½®ä¸€äº›ç¯å¢ƒå˜é‡"></a>è®¾ç½®ä¸€äº›ç¯å¢ƒå˜é‡</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> User specific environment and startup programs</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> This defines the docker hub to use when running integration tests and building docker images</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> eg: HUB=<span class="string">&quot;docker.io/istio&quot;</span>, HUB=<span class="string">&quot;gcr.io/istio-testing&quot;</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> è¿™é‡Œçš„docker registryå°±æ˜¯æˆ‘ä»¬ä¸Šä¸€æ­¥è®¾ç½®çš„æœ¬åœ°ä»“åº“</span></span><br><span class="line">export HUB=&quot;localhost:5000/xinranwang&quot;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> This defines the docker tag to use when running integration tests and</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> building docker images to be your user id. You may also <span class="built_in">set</span> this variable</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> this to any other legitimate docker tag.</span></span><br><span class="line">export TAG=devel</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> This defines a shortcut to change directories to <span class="variable">$HOME</span>/istio.io</span></span><br><span class="line">export ISTIO=$HOME/istio.io</span><br><span class="line"></span><br></pre></td></tr></table></figure>




<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> mkdir ~/go/src/istio.io/</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git <span class="built_in">clone</span> https://github.com/istio/istio.git</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> ~/go/src/istio.io/istio</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> make DEBUG=1 build</span></span><br><span class="line">Unable to find image &#x27;gcr.io/istio-testing/build-tools:master-2021-03-01T22-30-49&#x27; locally</span><br><span class="line">master-2021-03-01T22-30-49: Pulling from istio-testing/build-tools</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> build docker imagesï¼Œwith HUB and TAG environment variable.</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> make DEBUG=1 docker</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> push images to registry</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ä¼šè¯»å–ç¯å¢ƒå˜é‡ï¼Œå°±pushåˆ°æœ¬åœ°ä»“åº“äº†</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> make docker.push</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> å¯ä»¥çœ‹åˆ°æœ¬åœ°ä»“åº“é‡Œæœ‰buildå¥½çš„docker image</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ls /mnt/docker_imgs/docker/registry/v2/repositories/xinranwang/</span></span><br><span class="line">app                   app_sidecar_debian_10      app_sidecar_ubuntu_focal   istioctl  proxyv2</span><br><span class="line">app_sidecar_centos_7  app_sidecar_debian_9       app_sidecar_ubuntu_xenial  operator</span><br><span class="line">app_sidecar_centos_8  app_sidecar_ubuntu_bionic  install-cni                pilot</span><br></pre></td></tr></table></figure>
<img src="/posts/702f5168/image-20210308154035936.png" alt="image-20210308154035936" style="zoom:80%;">

<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ubuntu@otcloud-node1:~/istio-1.9.1/manifests/profiles$ istioctl install -f default-local-registry.yaml</span><br><span class="line">This will install the Istio 1.9.1  profile with [&quot;Istio core&quot; &quot;Istiod&quot; &quot;Ingress gateways&quot;] components into the cluster. Proceed? (y/N) y</span><br><span class="line">âœ” Istio core installed</span><br><span class="line">âœ” Istiod installed</span><br><span class="line">âœ” Ingress gateways installed</span><br><span class="line">âœ” Installation complete</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">k get pods -nistio-system</span><br><span class="line">NAME                                    READY   STATUS    RESTARTS   AGE</span><br><span class="line">istio-ingressgateway-58844f985b-mdckr   1/1     Running   0          34s</span><br><span class="line">istiod-6f846c944f-zwqxf                 1/1     Running   0          38s</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">kubectl label namespace default istio-injection=enabled</span><br></pre></td></tr></table></figure>


<img src="/posts/702f5168/image-20210308164345265.png" alt="image-20210308164345265" style="zoom:80%;">





<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">Environment:</span><br><span class="line">------------</span><br><span class="line">ENVOY_PORT=</span><br><span class="line">INBOUND_CAPTURE_PORT=</span><br><span class="line">ISTIO_INBOUND_INTERCEPTION_MODE=</span><br><span class="line">ISTIO_INBOUND_TPROXY_MARK=</span><br><span class="line">ISTIO_INBOUND_TPROXY_ROUTE_TABLE=</span><br><span class="line">ISTIO_INBOUND_PORTS=</span><br><span class="line">ISTIO_OUTBOUND_PORTS=</span><br><span class="line">ISTIO_LOCAL_EXCLUDE_PORTS=</span><br><span class="line">ISTIO_SERVICE_CIDR=</span><br><span class="line">ISTIO_SERVICE_EXCLUDE_CIDR=</span><br><span class="line">ISTIO_META_DNS_CAPTURE=</span><br><span class="line"></span><br><span class="line">Variables:</span><br><span class="line">----------</span><br><span class="line">PROXY_PORT=15001</span><br><span class="line">PROXY_INBOUND_CAPTURE_PORT=15006</span><br><span class="line">PROXY_TUNNEL_PORT=15008</span><br><span class="line">PROXY_UID=1337</span><br><span class="line">PROXY_GID=1337</span><br><span class="line">INBOUND_INTERCEPTION_MODE=REDIRECT</span><br><span class="line">INBOUND_TPROXY_MARK=1337</span><br><span class="line">INBOUND_TPROXY_ROUTE_TABLE=133</span><br><span class="line">INBOUND_PORTS_INCLUDE=*</span><br><span class="line">INBOUND_PORTS_EXCLUDE=15090,15021,15020</span><br><span class="line">OUTBOUND_IP_RANGES_INCLUDE=*</span><br><span class="line">OUTBOUND_IP_RANGES_EXCLUDE=</span><br><span class="line">OUTBOUND_PORTS_INCLUDE=</span><br><span class="line">OUTBOUND_PORTS_EXCLUDE=</span><br><span class="line">KUBEVIRT_INTERFACES=</span><br><span class="line">ENABLE_INBOUND_IPV6=false</span><br><span class="line">DNS_CAPTURE=false</span><br><span class="line">DNS_SERVERS=[],[]</span><br><span class="line"></span><br><span class="line">Writing following contents to rules file:  /tmp/iptables-rules-1615191401124723984.txt833457753</span><br><span class="line">* nat</span><br><span class="line">-N ISTIO_INBOUND</span><br><span class="line">-N ISTIO_REDIRECT</span><br><span class="line">-N ISTIO_IN_REDIRECT</span><br><span class="line">-N ISTIO_OUTPUT</span><br><span class="line">-A ISTIO_INBOUND -p tcp --dport 15008 -j RETURN</span><br><span class="line">-A ISTIO_REDIRECT -p tcp -j REDIRECT --to-ports 15001</span><br><span class="line">-A ISTIO_IN_REDIRECT -p tcp -j REDIRECT --to-ports 15006</span><br><span class="line">-A PREROUTING -p tcp -j ISTIO_INBOUND</span><br><span class="line">-A ISTIO_INBOUND -p tcp --dport 22 -j RETURN</span><br><span class="line">-A ISTIO_INBOUND -p tcp --dport 15090 -j RETURN</span><br><span class="line">-A ISTIO_INBOUND -p tcp --dport 15021 -j RETURN</span><br><span class="line">-A ISTIO_INBOUND -p tcp --dport 15020 -j RETURN</span><br><span class="line">-A ISTIO_INBOUND -p tcp -j ISTIO_IN_REDIRECT</span><br><span class="line">-A OUTPUT -p tcp -j ISTIO_OUTPUT</span><br><span class="line">-A ISTIO_OUTPUT -o lo -s 127.0.0.6/32 -j RETURN</span><br><span class="line">-A ISTIO_OUTPUT -o lo ! -d 127.0.0.1/32 -m owner --uid-owner 1337 -j ISTIO_IN_REDIRECT</span><br><span class="line">-A ISTIO_OUTPUT -o lo -m owner ! --uid-owner 1337 -j RETURN</span><br><span class="line">-A ISTIO_OUTPUT -m owner --uid-owner 1337 -j RETURN</span><br><span class="line">-A ISTIO_OUTPUT -o lo ! -d 127.0.0.1/32 -m owner --gid-owner 1337 -j ISTIO_IN_REDIRECT</span><br><span class="line">-A ISTIO_OUTPUT -o lo -m owner ! --gid-owner 1337 -j RETURN</span><br><span class="line">-A ISTIO_OUTPUT -m owner --gid-owner 1337 -j RETURN</span><br><span class="line">-A ISTIO_OUTPUT -d 127.0.0.1/32 -j RETURN</span><br><span class="line">-A ISTIO_OUTPUT -j ISTIO_REDIRECT</span><br><span class="line">COMMIT</span><br><span class="line"></span><br><span class="line">iptables-restore --noflush /tmp/iptables-rules-1615191401124723984.txt833457753</span><br><span class="line">Writing following contents to rules file:  /tmp/ip6tables-rules-1615191401199424850.txt857904100</span><br><span class="line"></span><br><span class="line">ip6tables-restore --noflush /tmp/ip6tables-rules-1615191401199424850.txt857904100</span><br><span class="line">iptables-save </span><br><span class="line"><span class="meta">#</span><span class="bash"> Generated by iptables-save v1.6.1 on Mon Mar  8 08:16:41 2021</span></span><br><span class="line">*nat</span><br><span class="line">:PREROUTING ACCEPT [0:0]</span><br><span class="line">:INPUT ACCEPT [0:0]</span><br><span class="line">:OUTPUT ACCEPT [0:0]</span><br><span class="line">:POSTROUTING ACCEPT [0:0]</span><br><span class="line">:ISTIO_INBOUND - [0:0]</span><br><span class="line">:ISTIO_IN_REDIRECT - [0:0]</span><br><span class="line">:ISTIO_OUTPUT - [0:0]</span><br><span class="line">:ISTIO_REDIRECT - [0:0]</span><br><span class="line">-A PREROUTING -p tcp -j ISTIO_INBOUND</span><br><span class="line">-A OUTPUT -p tcp -j ISTIO_OUTPUT</span><br><span class="line">-A ISTIO_INBOUND -p tcp -m tcp --dport 15008 -j RETURN</span><br><span class="line">-A ISTIO_INBOUND -p tcp -m tcp --dport 22 -j RETURN</span><br><span class="line">-A ISTIO_INBOUND -p tcp -m tcp --dport 15090 -j RETURN</span><br><span class="line">-A ISTIO_INBOUND -p tcp -m tcp --dport 15021 -j RETURN</span><br><span class="line">-A ISTIO_INBOUND -p tcp -m tcp --dport 15020 -j RETURN</span><br><span class="line">-A ISTIO_INBOUND -p tcp -j ISTIO_IN_REDIRECT</span><br><span class="line">-A ISTIO_IN_REDIRECT -p tcp -j REDIRECT --to-ports 15006</span><br><span class="line">-A ISTIO_OUTPUT -s 127.0.0.6/32 -o lo -j RETURN</span><br><span class="line">-A ISTIO_OUTPUT ! -d 127.0.0.1/32 -o lo -m owner --uid-owner 1337 -j ISTIO_IN_REDIRECT</span><br><span class="line">-A ISTIO_OUTPUT -o lo -m owner ! --uid-owner 1337 -j RETURN</span><br><span class="line">-A ISTIO_OUTPUT -m owner --uid-owner 1337 -j RETURN</span><br><span class="line">-A ISTIO_OUTPUT ! -d 127.0.0.1/32 -o lo -m owner --gid-owner 1337 -j ISTIO_IN_REDIRECT</span><br><span class="line">-A ISTIO_OUTPUT -o lo -m owner ! --gid-owner 1337 -j RETURN</span><br><span class="line">-A ISTIO_OUTPUT -m owner --gid-owner 1337 -j RETURN</span><br><span class="line">-A ISTIO_OUTPUT -d 127.0.0.1/32 -j RETURN</span><br><span class="line">-A ISTIO_OUTPUT -j ISTIO_REDIRECT</span><br><span class="line">-A ISTIO_REDIRECT -p tcp -j REDIRECT --to-ports 15001</span><br><span class="line">COMMIT</span><br><span class="line"><span class="meta">#</span><span class="bash"> Completed on Mon Mar  8 08:16:41 2021</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>deploy</category>
      </categories>
      <tags>
        <tag>deploy</tag>
        <tag>service mesh</tag>
      </tags>
  </entry>
  <entry>
    <title>istio-gateway</title>
    <url>/posts/def4f008.html</url>
    <content><![CDATA[<p><img src="/posts/def4f008/image-20210309150445057.png" alt="image-20210309150445057"></p>
<p>serviceentryï¼šä¹Ÿå¯ä»¥è®¿é—®å¤–éƒ¨æœåŠ¡ã€‚</p>
<h2 id="gatewayç®€ä»‹"><a href="#gatewayç®€ä»‹" class="headerlink" title="gatewayç®€ä»‹"></a>gatewayç®€ä»‹</h2><ol>
<li><p>L4-L6çš„è´Ÿè½½å‡è¡¡</p>
</li>
<li><p>æä¾›å¯¹å¤–çš„mtls</p>
</li>
</ol>
<p>åœ¨istioç½‘æ ¼ä¸­ï¼Œgatewayå¯ä»¥éƒ¨ç½²ä»»æ„å¤šä¸ªï¼Œå¯ä»¥å…±ç”¨ä¸€ä¸ªï¼Œä¹Ÿå¯ä»¥æ¯ä¸ªç§Ÿæˆ·ï¼Œnamespaceå•ç‹¬éš”ç¦»ã€‚</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Gateway</span> <span class="comment"># istioçš„ä¸€ä¸ªCRDå¯¹è±¡</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">bookinfo-gateway</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">istio:</span> <span class="string">ingressgateway</span> <span class="comment"># use istio default controller</span></span><br><span class="line">  <span class="attr">servers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span></span><br><span class="line">      <span class="attr">number:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">HTTP</span></span><br><span class="line">    <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">bookinfo.com</span>       <span class="comment"># å…è®¸é€šè¿‡å¤–éƒ¨è®¿é—®çš„åŸŸå</span></span><br></pre></td></tr></table></figure>
<p><strong>VirtualService</strong>å®šä¹‰gateway L7è·¯ç”±ï¼Œä¸ºè®¿é—®bookinfo.comçš„httpæµé‡ï¼Œæä¾›è·¯ç”±åŒ¹é…è½¬å‘ç­–ç•¥ã€‚</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">bookinfo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">bookinfo.com</span>      <span class="comment"># å’Œä¸Šé¢çš„hostå­—æ®µä¸€æ ·</span></span><br><span class="line">  <span class="attr">gateways:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">bookinfo-gateway</span>  <span class="comment"># ç»‘å®šåˆ°ä¸Šé¢çš„gateway</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">uri:</span></span><br><span class="line">        <span class="attr">exact:</span> <span class="string">/productpage</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">uri:</span></span><br><span class="line">        <span class="attr">prefix:</span> <span class="string">/static</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">uri:</span></span><br><span class="line">        <span class="attr">exact:</span> <span class="string">/login</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">uri:</span></span><br><span class="line">        <span class="attr">exact:</span> <span class="string">/logout</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">uri:</span></span><br><span class="line">        <span class="attr">prefix:</span> <span class="string">/api/v1/products</span></span><br><span class="line">    <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span>   <span class="comment"># å¦‚æœä¸Šè¿°æ¡ä»¶ä¹‹ä¸€æ»¡è¶³ï¼Œåˆ™å»ä¸€ä¸ªå«â€œproductpageâ€çš„destinationrule</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">productpage</span></span><br><span class="line">        <span class="attr">port:</span></span><br><span class="line">          <span class="attr">number:</span> <span class="number">9080</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>kubernetes Ingress</strong> vs <strong>Isito gateway</strong></p>
<p><img src="/posts/def4f008/image-20210309151602156.png" alt="image-20210309151602156"></p>
<h2 id="gatewayåŸç†åŠå®ç°"><a href="#gatewayåŸç†åŠå®ç°" class="headerlink" title="gatewayåŸç†åŠå®ç°"></a>gatewayåŸç†åŠå®ç°</h2><figure class="highlight haml"><table><tr><td class="code"><pre><span class="line">pilot-agent</span><br><span class="line">-<span class="ruby"> <span class="symbol">args:</span></span></span><br><span class="line"><span class="ruby">   - proxy</span></span><br><span class="line"><span class="ruby">   - router</span></span><br><span class="line"><span class="ruby">   - --domain</span></span><br><span class="line"><span class="ruby">   - <span class="variable">$(</span>POD_NAMESPACE).svc.cluster.local</span></span><br><span class="line"><span class="ruby">   - --proxyLogLevel=warning</span></span><br><span class="line"><span class="ruby">   - --proxyComponentLogLevel=<span class="symbol">misc:</span>error</span></span><br><span class="line"><span class="ruby">   - --log_output_level=<span class="symbol">default:</span>info</span></span><br><span class="line"><span class="ruby">   - --serviceCluster</span></span><br><span class="line"><span class="ruby">   - istio-ingressgateway</span></span><br></pre></td></tr></table></figure>]]></content>
  </entry>
  <entry>
    <title>GPUè™šæ‹ŸåŒ–</title>
    <url>/posts/204fd6f0.html</url>
    <content><![CDATA[<p>ç›®å‰æµè¡Œçš„å‡ ç§æ¨¡å¼ï¼špass through, sriov, åŠè™šæ‹ŸåŒ–ï¼ˆmdev passthroughï¼š Intel gvt-g, Nvidia GRID vGPU), å…¨è™šæ‹ŸåŒ–ï¼ˆVMwareï¼š vSGAï¼‰</p>
<p>å­¦ä¹ è·¯å¾„</p>
<p>pci -ã€‹ pci dma -ã€‹ iommu -ã€‹ passthrough</p>
<p>å†…å­˜é¡µè¡¨ - ã€‹ tlb</p>
<p>cache -ã€‹ å†…å­˜</p>
<h1 id="PCI"><a href="#PCI" class="headerlink" title="PCI"></a>PCI</h1><p>Linux PCIè®¾å¤‡é©±åŠ¨å®é™…åŒ…æ‹¬<strong>Linux PCIè®¾å¤‡é©±åŠ¨</strong>å’Œ<strong>è®¾å¤‡æœ¬èº«é©±åŠ¨</strong>ä¸¤éƒ¨åˆ†ã€‚</p>
<p>PCI(Periheral Component Interconnect)æœ‰ä¸‰ç§åœ°å€ç©ºé—´ï¼š<strong>PCI I/Oç©ºé—´ã€PCIå†…å­˜åœ°å€ç©ºé—´å’ŒPCIé…ç½®ç©ºé—´</strong>ã€‚</p>
<p>PCI I/Oç©ºé—´å’ŒPCIå†…å­˜åœ°å€ç©ºé—´ç”±è®¾å¤‡é©±åŠ¨ç¨‹åºä½¿ç”¨</p>
<p>è€ŒPCIé…ç½®ç©ºé—´ç”±Linux PCIåˆå§‹åŒ–ä»£ç ä½¿ç”¨ï¼Œç”¨äºé…ç½®PCIè®¾å¤‡ï¼Œæ¯”å¦‚ä¸­æ–­å·ä»¥åŠI/Oæˆ–å†…å­˜åŸºåœ°å€ã€‚</p>
<p>å†…æ ¸ï¼šéå†å’Œé…ç½®</p>
<p>éå†é¡ºåºï¼šä»host-pciå¼€å§‹ï¼Œé‡åˆ°pci bridgeå°±åˆ°ä¸‹ä¸€çº§pciæ€»çº¿ç»§ç»­éå†ï¼Œç›´åˆ°éå†å®Œæˆã€‚ï¼ˆæ·±åº¦ä¼˜å…ˆï¼Ÿï¼‰</p>
<p>é…ç½®ï¼šPCIè®¾å¤‡ä¸­ä¸€èˆ¬éƒ½å¸¦æœ‰ä¸€äº›RAMå’ŒROM ç©ºé—´ï¼Œé€šå¸¸çš„æ§åˆ¶/çŠ¶æ€å¯„å­˜å™¨å’Œæ•°æ®å¯„å­˜å™¨ä¹Ÿå¾€å¾€ä»¥RAMåŒºé—´çš„å½¢å¼å‡ºç°ï¼Œè€Œè¿™äº›åŒºé—´çš„åœ°å€åœ¨è®¾å¤‡å†…éƒ¨ä¸€èˆ¬éƒ½æ˜¯ä»0å¼€å§‹ç¼–å€çš„ï¼Œé‚£ä¹ˆå½“æ€»çº¿ä¸ŠæŒ‚æ¥äº†å¤šä¸ªè®¾å¤‡æ—¶ï¼Œå¯¹è¿™äº›ç©ºé—´çš„è®¿é—®å°±ä¼šäº§ç”Ÿå†²çªã€‚æ‰€ä»¥ï¼Œè¿™äº›åœ°å€éƒ½è¦å…ˆæ˜ å°„åˆ°ç³»ç»Ÿæ€»çº¿ä¸Šï¼Œå†è¿›ä¸€æ­¥æ˜ å°„åˆ°å†…æ ¸çš„è™šæ‹Ÿåœ°å€ç©ºé—´ã€‚é…ç½®å°±æ˜¯é€šè¿‡å¯¹PCIé…ç½®ç©ºé—´çš„å¯„å­˜å™¨è¿›è¡Œæ“ä½œä»è€Œå®Œæˆåœ°å€çš„æ˜ å°„ã€‚ device physical address -&gt; system virtual address??</p>
<h1 id="DMA"><a href="#DMA" class="headerlink" title="DMA"></a>DMA</h1><p><a href="https://cloud.tencent.com/developer/article/1194593">https://cloud.tencent.com/developer/article/1194593</a></p>
<h2 id="Passthrough"><a href="#Passthrough" class="headerlink" title="Passthrough"></a>Passthrough</h2><p><strong>ç›´é€šæ¨¡å¼</strong>çš„å®ç°ä¾èµ–äºIOMMUçš„åŠŸèƒ½ã€‚VTDå¯¹IOVAçš„åœ°å€è½¬æ¢ä½¿å¾—ç›´é€šè®¾å¤‡å¯ä»¥åœ¨ç¡¬ä»¶å±‚æ¬¡ç›´æ¥ä½¿ç”¨GPAï¼ˆGuest Physical Addressï¼‰åœ°å€ã€‚GPUç›´é€šæŠ€æœ¯ç›¸å¯¹äºä»»ä½•å…¶ä»–è®¾å¤‡æ¥è¯´ï¼Œä¼šæœ‰é¢å¤–çš„PCI é…ç½®ç©ºé—´æ¨¡æ‹Ÿå’ŒMMIOçš„æ‹¦æˆªï¼ˆå‚è§QEMU VFIO quirkæœºåˆ¶ï¼‰ã€‚æ¯”å¦‚Hypervisoræˆ–è€…Device Module ä¸ä¼šå…è®¸è™šæ‹Ÿæœºå¯¹GPUç¡¬ä»¶å…³é”®å¯„å­˜å™¨çš„å®Œå…¨çš„è®¿é—®æƒé™ï¼Œä¸€äº›é«˜æƒé™çš„æ“ä½œä¼šè¢«ç›´æ¥æ‹¦æˆªã€‚å¤§å®¶æˆ–è®¸å·²ç»æ„è¯†åˆ°åŸæ¥ç›´é€šè®¾å¤‡ä¹Ÿæ˜¯æœ‰MMIOæ¨¡æ‹Ÿå’Œæ‹¦æˆªçš„ã€‚è¿™å¯¹äºæˆ‘ä»¬ç†è§£GPU åŠè™šæ‹ŸåŒ–å¾ˆæœ‰å¸®åŠ©ã€‚</p>
<h3 id="libvirt-layer"><a href="#libvirt-layer" class="headerlink" title="libvirt layer"></a>libvirt layer</h3><p>å°†PCIè®¾å¤‡ç›´æ¥åˆ†é…ç»™guest osæ—¶ï¼Œå¦‚æœä¸å…ˆä»guestä¸­hot-unplugè¯¥è®¾å¤‡ï¼Œå°†æ— æ³•è¿›è¡Œmigrationã€‚</p>
<p>managed: guestå¯åŠ¨æ—¶ä¼šè‡ªåŠ¨ä»hostä¸Šdetachï¼Œ guest shutdownæ—¶åˆé‡æ–°attachå›hostã€‚ï¼ˆimplictï¼‰</p>
<p>unmangedï¼šéœ€è¦æ‰‹åŠ¨ä»host detachï¼Œä¹‹åæ‰‹åŠ¨re-attachå›hostã€‚ä¸ç„¶libvirtä¼šrefuseã€‚ï¼ˆexplictï¼‰</p>
]]></content>
  </entry>
  <entry>
    <title>istioå­¦ä¹ ï¼ˆ1ï¼‰-pilot</title>
    <url>/posts/a94c45db.html</url>
    <content><![CDATA[<h2 id="service-meshï¼ˆæœåŠ¡ç½‘æ ¼ï¼‰"><a href="#service-meshï¼ˆæœåŠ¡ç½‘æ ¼ï¼‰" class="headerlink" title="service meshï¼ˆæœåŠ¡ç½‘æ ¼ï¼‰"></a>service meshï¼ˆæœåŠ¡ç½‘æ ¼ï¼‰</h2><p>Service Meshé€šè¿‡ä¸€ä¸ªä¸ªâ€ä»£ç†â€ æ¥ä¸ºå¾®æœåŠ¡è½¬å‘/æ¥æ”¶æ‰€æœ‰æµé‡ï¼Œé€šè¿‡æ§åˆ¶è¿™äº›ä»£ç†ï¼Œå°±å¯ä»¥å®ç°æœåŠ¡è¿æ¥ï¼Œæ³¨å†Œï¼Œå‘ç°ï¼Œè´Ÿè½½å‡è¡¡ï¼Œç†”æ–­ï¼Œç›‘æ§ç­‰ç­‰ä¸€ç³»åˆ—æœåŠ¡æ²»ç†ç›¸å…³åŠŸèƒ½ï¼Œä»è€Œå¾®æœåŠ¡çš„ä»£ç ä¸å†éœ€è¦æœåŠ¡æ²»ç†çš„å®ç°ï¼Œæ¢å¥è¯è¯´ï¼Œä¹Ÿå°±æ˜¯æœåŠ¡æ²»ç†å¯¹äºå¾®æœåŠ¡å¼€å‘è€…è€Œè¨€æ˜¯é€æ˜çš„ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼šç»¿è‰²æ–¹å—ä¸ºå¾®æœåŠ¡ï¼Œè“è‰²æ–¹å—ä¸º service mesh çš„ä»£ç†ï¼Œè“è‰²çº¿æ¡ä¸ºæœåŠ¡é—´é€šè®¯ã€‚å¯ä»¥çœ‹åˆ°è“è‰²çš„æ–¹å—å’Œçº¿æ¡ç»„æˆäº†æ•´ä¸ªç½‘æ ¼ã€‚è¿™ä¸ªç½‘ç»œå°±æ˜¯ Service Meshã€‚</p>
<img src="/posts/a94c45db/v2-638a9d12e8a7406b7a733f2eadf989f5_1440w.jpg" alt="img" style="zoom:30%;">

<h2 id="Istio"><a href="#Istio" class="headerlink" title="Istio"></a>Istio</h2><p>Goç¼–å†™ï¼Œæ§åˆ¶é¢ã€‚å¯¹åº”çš„æ•°æ®é¢æ˜¯é€šå¸¸æ˜¯envoyï¼ˆåŸºäºC++ï¼‰</p>
<h3 id="æ¶æ„å›¾"><a href="#æ¶æ„å›¾" class="headerlink" title="æ¶æ„å›¾"></a>æ¶æ„å›¾</h3><p><img src="/posts/a94c45db/arch.svg" alt="The overall architecture of an Istio-based application."></p>
<h3 id="åŸºæœ¬ç»„ä»¶"><a href="#åŸºæœ¬ç»„ä»¶" class="headerlink" title="åŸºæœ¬ç»„ä»¶"></a>åŸºæœ¬ç»„ä»¶</h3><h4 id="envoy"><a href="#envoy" class="headerlink" title="envoy"></a>envoy</h4><p>ä»¥sidecarçš„å½¢å¼è¿è¡Œåœ¨æœåŠ¡æ‰€åœ¨çš„podä¸­ï¼Œæ‰€æœ‰serviceçš„æµé‡è¿›å‡ºéƒ½å¿…é¡»é€šè¿‡envoy proxyï¼Œç”¨æ¥æ§åˆ¶serviceä¹‹é—´çš„è®¿é—®ï¼Œserviceæ˜¯æ„ŸçŸ¥ä¸åˆ°envoy proxyçš„å­˜åœ¨ã€‚</p>
<p>envoyå¯ä»¥å’Œæ§åˆ¶å¹³é¢ï¼ˆistioçš„ç»„ä»¶ï¼‰åŒå‘äº¤äº’ï¼Œå¯ä»¥ä»istioæ‹¿åˆ°ä¸€äº›ç­–ç•¥å’ŒæœåŠ¡å‘ç°çš„ä¿¡æ¯ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥ç»™istioä¼ å›ä¸€äº›ç›‘æ§çš„æ•°æ®ç­‰ç­‰ã€‚</p>
<h4 id="Istiod"><a href="#Istiod" class="headerlink" title="Istiod"></a>Istiod</h4><p>Istiodæä¾›æœåŠ¡å‘ç°, æœåŠ¡é…ç½®å’Œè¯ä¹¦ç®¡ç†ã€‚</p>
<p>stiod acts as a Certificate Authority (CA) and generates certificates to allow secure mTLS communication in the data plane.</p>
<h2 id="Istioçš„æœåŠ¡å‘ç°æµç¨‹"><a href="#Istioçš„æœåŠ¡å‘ç°æµç¨‹" class="headerlink" title="Istioçš„æœåŠ¡å‘ç°æµç¨‹"></a>Istioçš„æœåŠ¡å‘ç°æµç¨‹</h2><p><img src="/posts/a94c45db/image-20210226160141651.png" alt="image-20210226160141651"></p>
<p>istioçš„pilotç»„ä»¶æ—¶è´Ÿè´£æœåŠ¡å‘ç°çš„ã€‚åœ¨piloté‡Œåªæœ‰æœåŠ¡å‘ç°çš„å®šä¹‰ï¼Œä½†æ˜¯æ²¡æœ‰æœåŠ¡å‘ç°çš„å®ç°ï¼ŒæœåŠ¡å‘ç°çš„å®ç°æ˜¯åœ¨pilot adapterå¯¹æ¥çš„platformï¼ˆæ¯”å¦‚k8sï¼‰é‡Œçš„ã€‚pilot adapterå¯ä»¥å¯¹æ¥ä¸åŒçš„å¹³å°ï¼Œæ¯”å¦‚cloudfoudaryï¼Œeurakeï¼Œkubernetesï¼Œconsulç­‰ç­‰ï¼Œä½†æ˜¯k8sçš„é€‚é…æœ€å¥½ï¼Œä¹Ÿæ˜¯istioç¤¾åŒºçš„é‡ç‚¹ã€‚</p>
<h3 id="isitoå’ŒkubernetesæœåŠ¡æ¦‚å¿µå¯¹åº”å…³ç³»"><a href="#isitoå’ŒkubernetesæœåŠ¡æ¦‚å¿µå¯¹åº”å…³ç³»" class="headerlink" title="isitoå’ŒkubernetesæœåŠ¡æ¦‚å¿µå¯¹åº”å…³ç³»"></a>isitoå’ŒkubernetesæœåŠ¡æ¦‚å¿µå¯¹åº”å…³ç³»</h3><table>
<thead>
<tr>
<th align="center">isito</th>
<th align="center">kubernetes</th>
</tr>
</thead>
<tbody><tr>
<td align="center">service</td>
<td align="center">service</td>
</tr>
<tr>
<td align="center">instance</td>
<td align="center">endpoint</td>
</tr>
<tr>
<td align="center">version</td>
<td align="center">deployment</td>
</tr>
</tbody></table>
<img src="/posts/a94c45db/image-20210309105852832.png" alt="image-20210309105852832" style="zoom:80%;">

<p>æ¯ä¸ªenvoyé‡Œéƒ½æœ‰å…¨é‡çš„è§„åˆ™ã€‚ï¼ˆç°åœ¨ä¹Ÿæ˜¯å—ï¼Ÿï¼Ÿï¼‰</p>
<p>Envoy ï¼ˆC++ï¼‰ï¼ŒCNCFæ¯•ä¸šï¼ˆkubernetsï¼ŒPrometheusä¹‹åï¼‰ã€‚</p>
<p>xDSï¼š</p>
<p>listenerï¼ˆLDSï¼‰ï¼š</p>
<p>routesï¼ˆRDSï¼‰ï¼š</p>
<p>clusterï¼ˆCDSï¼‰ï¼š</p>
<p>endpointï¼ˆEDSï¼‰ï¼š</p>
<p>Envoyç›®å‰æ”¯æŒçš„ä¸‰ç§LBï¼š</p>
<ol>
<li>è½®è¯¢round robin</li>
<li>éšæœºrandom</li>
<li>åŠ æƒweighted least request.</li>
</ol>
<p>Istioï¼š</p>
<p>ç”¨æˆ·å¯ä»¥é…ç½®ï¼ˆé€šè¿‡rules APIï¼‰çš„CRDï¼š</p>
<p>gatewayï¼š</p>
<p>virtualserviceï¼š</p>
<p>destinationruleï¼š</p>
<p>serviceEntryï¼š</p>
<h3 id="Pilot"><a href="#Pilot" class="headerlink" title="Pilot"></a>Pilot</h3><p><img src="/posts/a94c45db/image-20210423095618162.png" alt="image-20210423095618162"></p>
<ol>
<li>å¹³å°é€‚é…å±‚: å°†ä¸åŒçš„å¹³å°èµ„æºå’Œistioçš„æŠ½è±¡æ¨¡å‹ç›¸äº’è½¬æ¢ã€‚</li>
<li>xds APIï¼š envoy API</li>
</ol>
<h3 id="citadelï¼š"><a href="#citadelï¼š" class="headerlink" title="citadelï¼š"></a>citadelï¼š</h3><p>æ²¡æœ‰citadelçš„æ—¶å€™ï¼Œå°±æ˜¯end to endçš„éå¯¹ç§°å¯†é’¥äº¤æ¢ï¼Œç„¶åå¯¹ç§°åŠ å¯†ä¼ è¾“æ•°æ®ã€‚</p>
<p>citadelï¼šå°±æ˜¯å­˜å‚¨è¯ä¹¦ï¼Œå‘æ”¾è¯ä¹¦çš„ä¸€ä¸ªä¸œè¥¿ã€‚</p>
<h3 id="Galley"><a href="#Galley" class="headerlink" title="Galley"></a>Galley</h3><p>istioè‡ªèº«åˆ›å»ºçš„CRDæœ‰50å¤šç§ï¼Œå¯ä»¥ç†è§£æˆéªŒè¯ï¼Œè§£æï¼Œç®¡ç†CRDçš„ä¸œè¥¿ã€‚</p>
<h3 id="Mixer"><a href="#Mixer" class="headerlink" title="Mixer"></a>Mixer</h3><p>1.7ä¹‹åå¼ƒç”¨ï¼Œä¸‹æ”¾åˆ°envoyé‡Œã€‚telemetry v2æ˜¯åœ¨istioé‡Œï¼Ÿ</p>
<h3 id="å…¶ä»–è§£å†³æ–¹æ¡ˆ"><a href="#å…¶ä»–è§£å†³æ–¹æ¡ˆ" class="headerlink" title="å…¶ä»–è§£å†³æ–¹æ¡ˆ"></a>å…¶ä»–è§£å†³æ–¹æ¡ˆ</h3><p>sofameshèš‚èšé‡‘æœï¼Œç”¨<strong>mosn</strong>æ›¿æ¢envoyï¼Œgolangï¼Œåˆå¹¶mixerï¼Œå¢å¼ºpilotï¼Œå¢åŠ å¯¹sofa rpcï¼Œ dubboçš„æ”¯æŒã€‚</p>
<p>linkerd =  control plane + data plane</p>
<p>linkerd v1å¯ä»¥è„±ç¦»k8s</p>
<p>linkerd v2å’Œk8sç´§è€¦åˆ</p>
<p>consul</p>
<p>192.168.0.195 zhang</p>
<p>192.168.0.196 ci</p>
<p>192.168.0.199 zhang</p>
]]></content>
      <categories>
        <category>service-mesh</category>
      </categories>
      <tags>
        <tag>service-mesh</tag>
        <tag>istio</tag>
      </tags>
  </entry>
  <entry>
    <title>markdownåŸºæœ¬è¯­æ³•</title>
    <url>/posts/47caaf1e.html</url>
    <content><![CDATA[<h1 id="ä¸€çº§æ ‡é¢˜"><a href="#ä¸€çº§æ ‡é¢˜" class="headerlink" title="ä¸€çº§æ ‡é¢˜"></a>ä¸€çº§æ ‡é¢˜</h1><h2 id="äºŒçº§"><a href="#äºŒçº§" class="headerlink" title="äºŒçº§"></a>äºŒçº§</h2><h3 id="ä¸‰çº§-ï¼ˆCTRL-3-æˆ–è€…-ï¼‰"><a href="#ä¸‰çº§-ï¼ˆCTRL-3-æˆ–è€…-ï¼‰" class="headerlink" title="ä¸‰çº§ ï¼ˆCTRL +3 æˆ–è€… ### ï¼‰"></a>ä¸‰çº§ ï¼ˆCTRL +3 æˆ–è€… ### ï¼‰</h3><h4 id="å››çº§"><a href="#å››çº§" class="headerlink" title="å››çº§"></a>å››çº§</h4><h6 id="æœ€å¤šæ”¯æŒåˆ°å…­çº§"><a href="#æœ€å¤šæ”¯æŒåˆ°å…­çº§" class="headerlink" title="æœ€å¤šæ”¯æŒåˆ°å…­çº§"></a>æœ€å¤šæ”¯æŒåˆ°å…­çº§</h6><h2 id="å­—ä½“"><a href="#å­—ä½“" class="headerlink" title="å­—ä½“"></a>å­—ä½“</h2><p><strong>hello world</strong></p>
<p>CTRL + B æˆ–è€… ä¸¤è¾¹åŠ **</p>
<p><em>hello world</em></p>
<p>CTRL + I æˆ–è€…ä¸¤è¾¹åŠ * </p>
<p><em><strong>hello world</strong></em></p>
<p>CTRL + B + I æˆ–è€… ä¸¤è¾¹åŠ ***</p>
<p><del>hello world</del></p>
<p>ALT + SHIFT + 5  æˆ–è€…~~ </p>
<h2 id="å¼•ç”¨"><a href="#å¼•ç”¨" class="headerlink" title="å¼•ç”¨"></a>å¼•ç”¨</h2><blockquote>
<p>è¿™æ˜¯ä¸€ä¸ªå¼•ç”¨ï¼Œ ç”¨&gt;å¼€å§‹ </p>
</blockquote>
<h2 id="åˆ†å‰²çº¿"><a href="#åˆ†å‰²çº¿" class="headerlink" title="åˆ†å‰²çº¿"></a>åˆ†å‰²çº¿</h2><hr>
<hr>
<p>ä¸‰ä¸ª-ï¼Œ æˆ–è€…ä¸‰ä¸ª*</p>
<h2 id="å›¾ç‰‡"><a href="#å›¾ç‰‡" class="headerlink" title="å›¾ç‰‡"></a>å›¾ç‰‡</h2><p><img src="https://www.w3schools.com/images/w3schools_green.jpg" alt="å›¾ç‰‡åå­—"></p>
<p>æ„Ÿå¹å·[å›¾ç‰‡åå­—]+ (å›¾ç‰‡åœ°å€)</p>
<h2 id="è¶…é“¾æ¥"><a href="#è¶…é“¾æ¥" class="headerlink" title="è¶…é“¾æ¥"></a>è¶…é“¾æ¥</h2><p><a href="https://kubernetes.io/docs/concepts/services-networking/service/#ips-and-vips">è¶…çº§é“¾æ¥</a></p>
<p>æ–¹æ‹¬å·é‡Œé¢å†™é“¾æ¥åå­—ï¼Œåé¢åŠ ()å†™é“¾æ¥åœ°å€ã€‚</p>
<h2 id="åˆ—è¡¨"><a href="#åˆ—è¡¨" class="headerlink" title="åˆ—è¡¨"></a>åˆ—è¡¨</h2><h3 id="æœ‰åºåˆ—è¡¨"><a href="#æœ‰åºåˆ—è¡¨" class="headerlink" title="æœ‰åºåˆ—è¡¨"></a>æœ‰åºåˆ—è¡¨</h3><ol>
<li>A</li>
<li>B</li>
<li>C</li>
</ol>
<h3 id="æ— åºåˆ—è¡¨"><a href="#æ— åºåˆ—è¡¨" class="headerlink" title="æ— åºåˆ—è¡¨"></a>æ— åºåˆ—è¡¨</h3><p>å‡å· + space</p>
<ul>
<li>A</li>
<li>B</li>
</ul>
<p>CTRL + [  å›åˆ°ä¸Šä¸€çº§<br>CTRL + ]  å›åˆ°ä¸‹ä¸€çº§</p>
<h2 id="è¡¨æ ¼"><a href="#è¡¨æ ¼" class="headerlink" title="è¡¨æ ¼"></a>è¡¨æ ¼</h2><table>
<thead>
<tr>
<th>åå­—</th>
<th>æ€§åˆ«</th>
<th>ç”Ÿæ—¥</th>
</tr>
</thead>
<tbody><tr>
<td>å¼ ä¸‰</td>
<td>ç”·</td>
<td>1997.1</td>
</tr>
</tbody></table>
<p>åå­— | æ€§åˆ«| ç”Ÿæ—¥|</p>
<p>â€“|â€“|â€“</p>
<p>xx|xx|xx|</p>
<p>è¿›å…¥æºä»£ç æ¨¡å¼(CTRL + /)ï¼Œåˆ é™¤è¡Œé—´ç©ºè¡Œï¼Œå°±å¯ä»¥ç”Ÿæˆè¡¨æ ¼äº†ã€‚</p>
<h2 id="ä»£ç "><a href="#ä»£ç " class="headerlink" title="ä»£ç "></a>ä»£ç </h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">public</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>language</category>
      </categories>
      <tags>
        <tag>markdown</tag>
      </tags>
  </entry>
  <entry>
    <title>å¤šè®¾å¤‡åŒæ­¥hexoy</title>
    <url>/posts/c9d1870c.html</url>
    <content><![CDATA[<h1 id="å¤šä¸ªè®¾å¤‡ä¹‹é—´åŒæ­¥hexo"><a href="#å¤šä¸ªè®¾å¤‡ä¹‹é—´åŒæ­¥hexo" class="headerlink" title="å¤šä¸ªè®¾å¤‡ä¹‹é—´åŒæ­¥hexo"></a>å¤šä¸ªè®¾å¤‡ä¹‹é—´åŒæ­¥hexo</h1><p><strong>åŸç†</strong></p>
<p>hexo deployä¼šå°†æœ¬åœ°åˆ›å»ºå¥½çš„ç›®å½•blogé‡Œé¢çš„æ–‡ä»¶ç”Ÿæˆå¯¹åº”çš„é™æ€æ–‡ä»¶ï¼ˆhtmlç­‰ï¼‰ï¼Œå¹¶ä¸”å°†å®ƒä¸Šä¼ åˆ°xxx.github.com repoä¸­ã€‚<br>åœ¨_config.ymlä¸­è®¾ç½®äº†deployè¦æ“ä½œçš„repoå’Œbranchï¼Œè¿™é‡Œæˆ‘ä½¿ç”¨çš„æ˜¯xxinran.github.ioçš„main branchã€‚</p>
]]></content>
      <categories>
        <category>hexo</category>
      </categories>
      <tags>
        <tag>hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>cpu-microarch</title>
    <url>/posts/f1d93d2c.html</url>
    <content><![CDATA[<p><img src="https://en.wikichip.org/w/images/thumb/e/ee/skylake_server_block_diagram.svg/950px-skylake_server_block_diagram.svg.png" alt="skylake server block diagram.svg"></p>
<p>front endï¼šå–å€¼ï¼Œè§£ç </p>
<p>execution engineï¼šè®¡ç®—</p>
<p>memory subsystemï¼š è¯»å†™å†…å­˜</p>
<p>L1ï¼Œ L2 per core</p>
]]></content>
  </entry>
  <entry>
    <title>linuxå†…å­˜ç®¡ç†</title>
    <url>/posts/d0683ba8.html</url>
    <content><![CDATA[<h1 id="ä¸»æµå­˜å‚¨è®¾å¤‡"><a href="#ä¸»æµå­˜å‚¨è®¾å¤‡" class="headerlink" title="ä¸»æµå­˜å‚¨è®¾å¤‡"></a>ä¸»æµå­˜å‚¨è®¾å¤‡</h1><p><img src="/posts/d0683ba8/%E5%AD%98%E5%82%A8%20(1).svg"></p>
<h1 id="ç‰©ç†å†…å­˜"><a href="#ç‰©ç†å†…å­˜" class="headerlink" title="ç‰©ç†å†…å­˜"></a>ç‰©ç†å†…å­˜</h1><p>æˆ‘ä»¬ä¸è®¨è®ºcacheï¼Œflashï¼Œromè¿™äº›ï¼Œåªè®¨è®ºmemoryä¹Ÿå°±æ˜¯é€šå¸¸æ‰€è¯´çš„ä¸»å­˜ï¼Œç°åœ¨ä¸€èˆ¬æ˜¯DDR4.</p>
<img src="/posts/d0683ba8/image-20210428163238359.png" alt="image-20210428163238359" style="zoom:67%;">

<p>å†…å­˜å·¥ä½œé¢‘ç‡ = min(cpuå¤–éƒ¨é¢‘ç‡ï¼Œä¸»æ¿é¢‘ç‡ï¼Œå†…å­˜è‡ªèº«é¢‘ç‡)</p>
<p>å¯¹äºä¸€ä¸ª32ä½ç³»ç»Ÿæ¥è¯´ï¼Œåœ°å€æ€»çº¿æœ€å¤šæ˜¯32bitï¼Œå®ƒèƒ½å¯»å€çš„æœ€å¤§èŒƒå›´æ˜¯2^32=4GBï¼Œæ‰€ä»¥ä¹Ÿå°±èƒ½æ’4GBçš„å†…å­˜æ¡ï¼Œæ’8GBçš„ä¹Ÿæ²¡æœ‰ç”¨ã€‚</p>
<p>64ä½CPUå‡ºç°ä¹‹åï¼Œå…¶åœ°å€æ€»çº¿ä½å®½ä¸€èˆ¬é‡‡ç”¨çš„æ˜¯36ä½æˆ–è€…40ä½ï¼Œå®ƒä»¬å¯»å€çš„ç‰©ç†åœ°å€ç©ºé—´ä¸º64GBæˆ–è€…1Tï¼ˆintelï¼‰ã€‚</p>
<blockquote>
<p>æ³¨æ„ï¼š å¸¸è¯´çš„<strong>CPUä½å®½</strong>æŒ‡çš„æ˜¯<strong>æ•°æ®æ€»çº¿</strong>ä½å®½ï¼Œæœ€å¤§å¯»å€èŒƒå›´å’ŒCPUä½å®½æ— å…³ã€‚</p>
</blockquote>
<img src="/posts/d0683ba8/image-20210428174116842.png" alt="image-20210428174116842" style="zoom:67%;">

<p>æŸ¥è¯¢ç³»ç»Ÿåœ°å€æ€»çº¿ä½å®½ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cat /proc/cpuinfo  | grep address</span><br><span class="line">address sizes   : 46 bits physical, 48 bits virtual</span><br><span class="line"><span class="meta">#</span><span class="bash"> ç‰©ç†å†…å­˜å¯»å€èŒƒå›´/è™šæ‹Ÿå†…å­˜å¯»å€èŒƒå›´å¯ä»¥ä¸åŒ</span></span><br></pre></td></tr></table></figure>
<h2 id="ç‰©ç†å†…å­˜3ä¸ªç®¡ç†åŒº"><a href="#ç‰©ç†å†…å­˜3ä¸ªç®¡ç†åŒº" class="headerlink" title="ç‰©ç†å†…å­˜3ä¸ªç®¡ç†åŒº"></a>ç‰©ç†å†…å­˜3ä¸ªç®¡ç†åŒº</h2><p><code>Linux</code> å†…æ ¸ä¼šå°†ç‰©ç†å†…å­˜åˆ†ä¸º3ä¸ªç®¡ç†åŒºï¼Œåˆ†åˆ«æ˜¯ï¼š</p>
<h3 id="ZONE-DMA"><a href="#ZONE-DMA" class="headerlink" title="ZONE_DMA"></a>ZONE_DMA</h3><p><code>DMA</code>å†…å­˜åŒºåŸŸã€‚åŒ…å«0MB~16MBä¹‹é—´çš„å†…å­˜é¡µæ¡†ï¼Œå¯ä»¥ç”±è€å¼åŸºäº<code>ISA</code>çš„è®¾å¤‡é€šè¿‡<code>DMA</code>ä½¿ç”¨ï¼Œç›´æ¥æ˜ å°„åˆ°å†…æ ¸çš„åœ°å€ç©ºé—´ã€‚</p>
<h3 id="ZONE-NORMAL"><a href="#ZONE-NORMAL" class="headerlink" title="ZONE_NORMAL"></a>ZONE_NORMAL</h3><p>æ™®é€šå†…å­˜åŒºåŸŸã€‚åŒ…å«16MB~896MBä¹‹é—´çš„å†…å­˜é¡µæ¡†ï¼Œå¸¸è§„é¡µæ¡†ï¼Œç›´æ¥æ˜ å°„åˆ°å†…æ ¸çš„åœ°å€ç©ºé—´ã€‚</p>
<h3 id="ZONE-HIGHMEM"><a href="#ZONE-HIGHMEM" class="headerlink" title="ZONE_HIGHMEM"></a>ZONE_HIGHMEM</h3><p>é«˜ç«¯å†…å­˜åŒºåŸŸã€‚åŒ…å«896MBä»¥ä¸Šçš„å†…å­˜é¡µæ¡†ï¼Œä¸è¿›è¡Œç›´æ¥æ˜ å°„ï¼Œå¯ä»¥é€šè¿‡æ°¸ä¹…æ˜ å°„å’Œä¸´æ—¶æ˜ å°„è¿›è¡Œè¿™éƒ¨åˆ†å†…å­˜é¡µæ¡†çš„è®¿é—®ã€‚</p>
<img src="/posts/d0683ba8/2.png" alt="Image" style="zoom:80%;">



<h1 id="è™šæ‹Ÿå†…å­˜"><a href="#è™šæ‹Ÿå†…å­˜" class="headerlink" title="è™šæ‹Ÿå†…å­˜"></a>è™šæ‹Ÿå†…å­˜</h1><p>å¯¹äº32ä½ç³»ç»Ÿæ¥è¯´ï¼Œä¸ºäº†å……åˆ†åˆ©ç”¨å’Œç®¡ç†ç³»ç»Ÿå†…å­˜èµ„æºï¼ŒLinuxé‡‡ç”¨è™šæ‹Ÿå†…å­˜ç®¡ç†æŠ€æœ¯ï¼Œåˆ©ç”¨è™šæ‹Ÿå†…å­˜æŠ€æœ¯è®©æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰<code>4GB</code> äº’ä¸å¹²æ¶‰çš„è™šæ‹Ÿåœ°å€ç©ºé—´ã€‚</p>
<p>ä¸ºä»€ä¹ˆæ˜¯4GB? </p>
<p>ä¹‹æ‰€ä»¥æ˜¯ 4GB ï¼Œæ˜¯å› ä¸ºåœ¨ 32 ä½çš„æ“ä½œç³»ç»Ÿä¸­ï¼Œä¸€ä¸ªæŒ‡é’ˆé•¿åº¦æ˜¯ 4 å­—èŠ‚ ï¼ˆ32ä½ï¼‰ï¼Œ 2çš„32æ¬¡ æ–¹ä¸ªåœ°å€å¯»å€èƒ½åŠ›æ˜¯ä» 0x00000000~0xFFFFFFFF å³ä¸º 4GB å¤§å°çš„å®¹é‡ã€‚</p>
<p>è¿›ç¨‹åˆå§‹åŒ–åˆ†é…å’Œæ“ä½œçš„éƒ½æ˜¯åŸºäºè¿™ä¸ªã€Œè™šæ‹Ÿåœ°å€ã€ï¼Œåªæœ‰å½“è¿›ç¨‹éœ€è¦å®é™…è®¿é—®å†…å­˜èµ„æºçš„æ—¶å€™æ‰ä¼šå»ºç«‹<strong>è™šæ‹Ÿåœ°å€å’Œç‰©ç†åœ°å€çš„æ˜ å°„</strong>ï¼Œè°ƒå…¥ç‰©ç†å†…å­˜é¡µã€‚</p>
<img src="/posts/d0683ba8/1.png" alt="Image" style="zoom:80%;">

<p>è¿™ä¹ˆåšçš„ç›®çš„æ˜¯ï¼š</p>
<ul>
<li>é¿å…ç”¨æˆ·ç›´æ¥è®¿é—®ç‰©ç†å†…å­˜åœ°å€ï¼Œé˜²æ­¢ä¸€äº›ç ´åæ€§æ“ä½œï¼Œä¿æŠ¤æ“ä½œç³»ç»Ÿ</li>
<li>æ¯ä¸ªè¿›ç¨‹éƒ½è¢«åˆ†é…äº†4GBçš„è™šæ‹Ÿå†…å­˜ï¼Œç”¨æˆ·ç¨‹åºå¯ä½¿ç”¨æ¯”å®é™…ç‰©ç†å†…å­˜æ›´å¤§çš„åœ°å€ç©ºé—´</li>
</ul>
<p>å½“éœ€è¿›ç¨‹è¦å®é™…è®¿é—®å†…å­˜çš„æ—¶å€™ï¼Œä¼šç”±å†…æ ¸çš„ã€Œè¯·æ±‚åˆ†é¡µæœºåˆ¶ã€äº§ç”Ÿã€Œç¼ºé¡µå¼‚å¸¸ã€è°ƒå…¥ç‰©ç†å†…å­˜é¡µã€‚</p>
<p><strong>64ä½ç³»ç»Ÿå¯¹æ¯”ï¼š</strong></p>
<img src="/posts/d0683ba8/64bit.png" alt="Linuxçš„è¿›ç¨‹åœ°å€ç©ºé—´[ä¸€]" style="zoom:40%;">

<h2 id="ç”¨æˆ·æ€å’Œå†…æ ¸æ€"><a href="#ç”¨æˆ·æ€å’Œå†…æ ¸æ€" class="headerlink" title="ç”¨æˆ·æ€å’Œå†…æ ¸æ€"></a>ç”¨æˆ·æ€å’Œå†…æ ¸æ€</h2><p>ç”¨æˆ·æ€åˆ‡æ¢åˆ°å†…æ ¸æ€çš„ 3 ç§æ–¹å¼ï¼šç³»ç»Ÿè°ƒç”¨ã€å¼‚å¸¸ã€å¤–è®¾ä¸­æ–­</p>
<p>ç”¨æˆ·æ€çš„ç¨‹åºå°±ä¸èƒ½éšæ„æ“ä½œå†…æ ¸åœ°å€ç©ºé—´ï¼Œå…·æœ‰ä¸€å®šçš„å®‰å…¨ä¿æŠ¤ä½œç”¨ï¼›å†…æ ¸æ€çº¿ç¨‹å…±äº«å†…æ ¸åœ°å€ç©ºé—´ï¼›</p>
<img src="/posts/d0683ba8/image-20210426162841923.png" alt="image-20210426162841923" style="zoom:78%;">

<h2 id="ç”¨æˆ·ç©ºé—´è™šæ‹Ÿå†…å­˜-3GB"><a href="#ç”¨æˆ·ç©ºé—´è™šæ‹Ÿå†…å­˜-3GB" class="headerlink" title="ç”¨æˆ·ç©ºé—´è™šæ‹Ÿå†…å­˜ - 3GB"></a>ç”¨æˆ·ç©ºé—´è™šæ‹Ÿå†…å­˜ - 3GB</h2><p>ç”¨æˆ·è¿›ç¨‹èƒ½è®¿é—®çš„æ˜¯ã€Œç”¨æˆ·ç©ºé—´ã€ï¼Œæ¯ä¸ªè¿›ç¨‹éƒ½æœ‰è‡ªå·±ç‹¬ç«‹çš„ç”¨æˆ·ç©ºé—´ï¼Œè™šæ‹Ÿåœ°å€èŒƒå›´ä»ä» <code>0x00000000</code> è‡³ <code>0xBFFFFFFF</code> æ€»å®¹é‡3G ã€‚</p>
<p>è¿›ç¨‹ï¼ˆæ‰§è¡Œçš„ç¨‹åºï¼‰å ç”¨çš„ç”¨æˆ·ç©ºé—´æŒ‰ç…§ã€Œ è®¿é—®å±æ€§ä¸€è‡´çš„åœ°å€ç©ºé—´å­˜æ”¾åœ¨ä¸€èµ· ã€çš„åŸåˆ™ï¼Œåˆ’åˆ†æˆ <code>5</code>ä¸ªä¸åŒçš„å†…å­˜åŒºåŸŸã€‚è®¿é—®å±æ€§æŒ‡çš„æ˜¯â€œå¯è¯»ã€å¯å†™ã€å¯æ‰§è¡Œç­‰ ã€‚</p>
<p><img src="/posts/d0683ba8/3.png" alt="Image"></p>
<ul>
<li><p>ä»£ç æ®µ</p>
<p>ä»£ç æ®µæ˜¯ç”¨æ¥å­˜æ”¾å¯æ‰§è¡Œæ–‡ä»¶çš„æ“ä½œæŒ‡ä»¤ï¼Œå¯æ‰§è¡Œç¨‹åºåœ¨å†…å­˜ä¸­çš„é•œåƒã€‚ä»£ç æ®µéœ€è¦é˜²æ­¢åœ¨è¿è¡Œæ—¶è¢«éæ³•ä¿®æ”¹ï¼Œæ‰€ä»¥<strong>åªå‡†è®¸è¯»å–æ“ä½œï¼Œå®ƒæ˜¯ä¸å¯å†™çš„</strong>ã€‚</p>
</li>
<li><p>æ•°æ®æ®µ</p>
<p>æ•°æ®æ®µç”¨æ¥å­˜æ”¾å¯æ‰§è¡Œæ–‡ä»¶ä¸­<strong>å·²åˆå§‹åŒ–å…¨å±€å˜é‡</strong>ï¼Œæ¢å¥è¯è¯´å°±æ˜¯å­˜æ”¾ç¨‹åºé™æ€åˆ†é…çš„å˜é‡å’Œå…¨å±€å˜é‡ã€‚</p>
</li>
<li><p>BSSæ®µ</p>
<p><code>BSS</code>æ®µåŒ…å«äº†ç¨‹åºä¸­<strong>æœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡</strong>ï¼Œåœ¨å†…å­˜ä¸­ <code>bss</code> æ®µå…¨éƒ¨ç½®é›¶ã€‚</p>
</li>
<li><p>å † <code>heap</code></p>
<p>å †æ˜¯ç”¨äºå­˜æ”¾è¿›ç¨‹è¿è¡Œä¸­è¢«<strong>åŠ¨æ€åˆ†é…çš„å†…å­˜æ®µ</strong>ï¼Œå®ƒçš„å¤§å°å¹¶ä¸å›ºå®šï¼Œå¯åŠ¨æ€æ‰©å¼ æˆ–ç¼©å‡ã€‚å½“è¿›ç¨‹è°ƒç”¨mallocç­‰å‡½æ•°åˆ†é…å†…å­˜æ—¶ï¼Œæ–°åˆ†é…çš„å†…å­˜å°±è¢«åŠ¨æ€æ·»åŠ åˆ°å †ä¸Šï¼ˆå †è¢«æ‰©å¼ ï¼‰ï¼›å½“åˆ©ç”¨freeç­‰å‡½æ•°é‡Šæ”¾å†…å­˜æ—¶ï¼Œè¢«é‡Šæ”¾çš„å†…å­˜ä»å †ä¸­è¢«å‰”é™¤ï¼ˆå †è¢«ç¼©å‡ï¼‰</p>
</li>
<li><p>æ ˆ <code>stack</code></p>
<p>æ ˆæ˜¯ç”¨æˆ·å­˜æ”¾ç¨‹åº<strong>ä¸´æ—¶åˆ›å»ºçš„å±€éƒ¨å˜é‡</strong>ï¼Œä¹Ÿå°±æ˜¯å‡½æ•°ä¸­å®šä¹‰çš„å˜é‡ï¼ˆä½†ä¸åŒ…æ‹¬ <code>static</code> å£°æ˜çš„å˜é‡ï¼Œstaticæ„å‘³ç€åœ¨æ•°æ®æ®µä¸­å­˜æ”¾å˜é‡ï¼‰ã€‚é™¤æ­¤ä»¥å¤–ï¼Œåœ¨å‡½æ•°è¢«è°ƒç”¨æ—¶ï¼Œå…¶å‚æ•°ä¹Ÿä¼šè¢«å‹å…¥å‘èµ·è°ƒç”¨çš„è¿›ç¨‹æ ˆä¸­ï¼Œå¹¶ä¸”å¾…åˆ°è°ƒç”¨ç»“æŸåï¼Œå‡½æ•°çš„è¿”å›å€¼ä¹Ÿä¼šè¢«å­˜æ”¾å›æ ˆä¸­ã€‚ç”±äºæ ˆçš„å…ˆè¿›å…ˆå‡ºç‰¹ç‚¹ï¼Œæ‰€ä»¥æ ˆç‰¹åˆ«æ–¹ä¾¿ç”¨æ¥ä¿å­˜/æ¢å¤è°ƒç”¨ç°åœºã€‚ä»è¿™ä¸ªæ„ä¹‰ä¸Šè®²ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå †æ ˆçœ‹æˆä¸€ä¸ªå¯„å­˜ã€äº¤æ¢ä¸´æ—¶æ•°æ®çš„å†…å­˜åŒºã€‚</p>
</li>
</ul>
<h2 id="å†…æ ¸ç©ºé—´è™šæ‹Ÿå†…å­˜-1GB"><a href="#å†…æ ¸ç©ºé—´è™šæ‹Ÿå†…å­˜-1GB" class="headerlink" title="å†…æ ¸ç©ºé—´è™šæ‹Ÿå†…å­˜ - 1GB"></a>å†…æ ¸ç©ºé—´è™šæ‹Ÿå†…å­˜ - 1GB</h2><p>åœ¨ <code>x86 32</code> ä½ç³»ç»Ÿé‡Œï¼ŒLinux å†…æ ¸åœ°å€ç©ºé—´æ˜¯æŒ‡è™šæ‹Ÿåœ°å€ä» <code>0xC0000000</code> å¼€å§‹åˆ° <code>0xFFFFFFFF</code> ä¸ºæ­¢çš„é«˜ç«¯å†…å­˜åœ°å€ç©ºé—´ï¼Œæ€»è®¡ <code>1G</code> çš„å®¹é‡ï¼Œ åŒ…æ‹¬äº†å†…æ ¸é•œåƒã€ç‰©ç†é¡µé¢è¡¨ã€é©±åŠ¨ç¨‹åºç­‰è¿è¡Œåœ¨å†…æ ¸ç©ºé—´ ã€‚è™šæ‹Ÿç©ºé—´çš„1GBæ€ä¹ˆå¯¹åº”åˆ°ç‰©ç†å†…å­˜çš„4GBç”šè‡³æ›´å¤šï¼ˆå–å†³äºåœ°å€æ€»çº¿æœ€å¤§å¯»å€å’Œæ’çš„å†…å­˜æ¡å¤§å°ï¼‰å‘¢ï¼Ÿ</p>
<img src="/posts/d0683ba8/image-20210429173652156.png" alt="image-20210429173652156" style="zoom:50%;">

<ul>
<li><p>ç›´æ¥æ˜ å°„åŒºï¼šçº¿æ€§ç©ºé—´ä¸­ä» 3G å¼€å§‹åˆ°3GB+896M çš„åŒºé—´ï¼Œç›´æ¥æ˜ å°„åˆ°ç‰©ç†å†…å­˜çš„ 0 - 896MBï¼ˆdma zone + normal zoneï¼‰ï¼Œç‰©ç†å’Œè™šæ‹Ÿä¸­é—´å·®ä¸€ä¸ªå›ºå®šçš„åç§»é‡ï¼šPAGE_OFFSET = 0xC0000000ã€‚</p>
<p>è™šæ‹Ÿåœ°å€ = <code>PAGE_OFFSET</code> + ç‰©ç†åœ°å€ï¼Œä¹Ÿå¯ä»¥ç”¨ <code>virt_to_phys()</code>å‡½æ•°å°†å†…æ ¸è™šæ‹Ÿç©ºé—´ä¸­çš„çº¿æ€§åœ°å€è½¬åŒ–ä¸ºç‰©ç†åœ°å€ã€‚</p>
</li>
<li><p>é™¤äº†ç›´æ¥æ˜ å°„åŒºï¼šè¿˜æœ‰4G-(3G+896MB) = 128MBçš„ç©ºé—´è¦æ˜ å°„åˆ°ç‰©ç†å†…å­˜çš„å…¶ä»–ç©ºé—´ï¼Œæ˜¾ç„¶1ï¼š1mapæ˜¯ä¸å¤Ÿçš„ã€‚æ‰€ä»¥å†…æ ¸ç©ºé—´æ‹¿å‡ºäº†æœ€åçš„ 128M åœ°å€åŒºé—´ï¼Œåˆ’åˆ†æˆä¸‹é¢ä¸‰ä¸ªé«˜ç«¯å†…å­˜æ˜ å°„åŒºï¼ˆåŠ¨æ€åˆ†é…ï¼Œå¯ä»¥é‡å¤æ˜ å°„ä¸åŒçš„åœ°å€ï¼‰ï¼š</p>
<ul>
<li>åŠ¨æ€å†…å­˜æ˜ å°„åŒºï¼šè¯¥åŒºåŸŸç”±å†…æ ¸å‡½æ•° vmalloc æ¥åˆ†é…ï¼Œç‰¹ç‚¹æ˜¯ï¼šçº¿æ€§ç©ºé—´è¿ç»­ï¼Œä½†æ˜¯å¯¹åº”çš„ç‰©ç†åœ°å€ç©ºé—´ä¸ä¸€å®šè¿ç»­ã€‚<code>vmalloc</code> åˆ†é…çš„çº¿æ€§åœ°å€æ‰€å¯¹åº”çš„ç‰©ç†é¡µå¯èƒ½å¤„äºä½ç«¯å†…å­˜ï¼Œä¹Ÿå¯èƒ½å¤„äºé«˜ç«¯å†…å­˜ã€‚</li>
<li>æ°¸ä¹…å†…å­˜æ˜ å°„åŒºï¼šè¯¥åŒºåŸŸå¯è®¿é—®é«˜ç«¯å†…å­˜ï¼ˆhighmemï¼‰ï¼Œè®¿é—®æ–¹æ³•æ˜¯ä½¿ç”¨ <code>alloc_page (_GFP_HIGHMEM)</code> åˆ†é…é«˜ç«¯å†…å­˜é¡µæˆ–è€…ä½¿ç”¨<code>kmap</code>å‡½æ•°å°†åˆ†é…åˆ°çš„é«˜ç«¯å†…å­˜æ˜ å°„åˆ°è¯¥åŒºåŸŸã€‚</li>
<li>å›ºå®šæ˜ å°„åŒºï¼šè¯¥åŒºåŸŸå’Œ 4G çš„é¡¶ç«¯åªæœ‰ 4k çš„éš”ç¦»å¸¦ï¼Œå…¶æ¯ä¸ªåœ°å€é¡¹éƒ½æœåŠ¡äºç‰¹å®šçš„ç”¨é€”ï¼Œå¦‚ï¼šACPI_BASE ç­‰</li>
</ul>
</li>
</ul>
<h2 id="è™šæ‹Ÿåœ°å€-ç‰©ç†åœ°å€çš„æ˜ å°„å…³ç³»å›¾"><a href="#è™šæ‹Ÿåœ°å€-ç‰©ç†åœ°å€çš„æ˜ å°„å…³ç³»å›¾" class="headerlink" title="è™šæ‹Ÿåœ°å€ -  ç‰©ç†åœ°å€çš„æ˜ å°„å…³ç³»å›¾"></a>è™šæ‹Ÿåœ°å€ -  ç‰©ç†åœ°å€çš„æ˜ å°„å…³ç³»å›¾</h2><img src="/posts/d0683ba8/image-20210429180241789.png" alt="image-20210429180241789" style="zoom:50%;">



<h1 id="MMU"><a href="#MMU" class="headerlink" title="MMU"></a>MMU</h1><p>æŠŠè™šæ‹Ÿåœ°å€è½¬æ¢æˆå†…å­˜çš„ç‰©ç†åœ°å€ï¼Œè¿™ä¸­é—´æ¶‰åŠåˆ©ç”¨<code>MMU</code> å†…å­˜ç®¡ç†å•å…ƒï¼ˆMemory Management Unit ) å¯¹è™šæ‹Ÿåœ°å€åˆ†æ®µå’Œåˆ†é¡µï¼ˆæ®µé¡µå¼ï¼‰åœ°å€è½¬æ¢ã€‚</p>
<ul>
<li>MMU æ˜¯ä¸€ç§ç¡¬ä»¶ç”µè·¯ï¼Œå®ƒåŒ…å«ä¸¤ä¸ªéƒ¨ä»¶ï¼Œä¸€ä¸ªæ˜¯åˆ†æ®µéƒ¨ä»¶ï¼Œä¸€ä¸ªæ˜¯åˆ†é¡µéƒ¨ä»¶</li>
<li>åˆ†æ®µæœºåˆ¶æŠŠä¸€ä¸ªé€»è¾‘åœ°å€è½¬æ¢ä¸ºçº¿æ€§åœ°å€</li>
<li>åˆ†é¡µæœºåˆ¶æŠŠä¸€ä¸ªçº¿æ€§åœ°å€è½¬æ¢ä¸ºç‰©ç†åœ°å€</li>
</ul>
<blockquote>
<p>å•ç‰‡æœºæ˜¯æ²¡æœ‰mmuçš„ï¼Œç¨‹åºç›´æ¥è®¿é—®ç‰©ç†åœ°å€ã€‚</p>
</blockquote>
<img src="/posts/d0683ba8/image-20210427151435405.png" alt="image-20210427151435405" style="zoom:66%;">

<h2 id="åˆ†æ®µæœºåˆ¶"><a href="#åˆ†æ®µæœºåˆ¶" class="headerlink" title="åˆ†æ®µæœºåˆ¶"></a>åˆ†æ®µæœºåˆ¶</h2><h2 id="åˆ†é¡µæœºåˆ¶"><a href="#åˆ†é¡µæœºåˆ¶" class="headerlink" title="åˆ†é¡µæœºåˆ¶"></a>åˆ†é¡µæœºåˆ¶</h2><p>é¡µè¡¨ä¿å­˜åœ¨<strong>ç‰©ç†å†…å­˜ä¸­</strong>ï¼Œ<strong>MMUä¼šæŸ¥æ‰¾é¡µè¡¨æ¥ç¡®å®šä¸€ä¸ªVAåº”è¯¥æ˜ å°„åˆ°ä»€ä¹ˆPAã€‚</strong></p>
<p><strong>æ®µé”™è¯¯</strong>æˆ‘ä»¬å·²ç»é‡åˆ°è¿‡å¾ˆå¤šæ¬¡äº†ï¼Œå®ƒæ˜¯è¿™æ ·äº§ç”Ÿçš„ï¼š</p>
<ol>
<li>ç”¨æˆ·ç¨‹åºè¦è®¿é—®çš„ä¸€ä¸ªVAï¼Œç»MMUæ£€æŸ¥æ— æƒè®¿é—®ã€‚</li>
<li>MMUäº§ç”Ÿä¸€ä¸ªå¼‚å¸¸ï¼ŒCPUä»ç”¨æˆ·æ¨¡å¼åˆ‡æ¢åˆ°ç‰¹æƒæ¨¡å¼ï¼Œè·³è½¬åˆ°å†…æ ¸ä»£ç ä¸­æ‰§è¡Œå¼‚å¸¸æœåŠ¡ç¨‹åºã€‚</li>
<li>å†…æ ¸æŠŠè¿™ä¸ªå¼‚å¸¸è§£é‡Šä¸ºæ®µé”™è¯¯ï¼ŒæŠŠå¼•å‘å¼‚å¸¸çš„è¿›ç¨‹ç»ˆæ­¢æ‰ã€‚</li>
</ol>
<p>page -  4KB</p>
<p>struct-page </p>
<p>4Gå†…å­˜ä¸€å…±æœ‰4GB/4KB = 2 ^20ä¸ª </p>
<h2 id="ç‰©ç†å†…å­˜åˆ†é…"><a href="#ç‰©ç†å†…å­˜åˆ†é…" class="headerlink" title="ç‰©ç†å†…å­˜åˆ†é…"></a>ç‰©ç†å†…å­˜åˆ†é…</h2><h3 id="å¤–éƒ¨ç¢ç‰‡"><a href="#å¤–éƒ¨ç¢ç‰‡" class="headerlink" title="å¤–éƒ¨ç¢ç‰‡"></a>å¤–éƒ¨ç¢ç‰‡</h3><p>å½“éœ€è¦åˆ†é…å¤§å—å†…å­˜çš„æ—¶å€™ï¼Œè¦ç”¨å¥½å‡ é¡µç»„åˆèµ·æ¥æ‰å¤Ÿï¼Œè€Œç³»ç»Ÿåˆ†é…ç‰©ç†å†…å­˜é¡µçš„æ—¶å€™ä¼šå°½é‡åˆ†é…è¿ç»­çš„å†…å­˜é¡µé¢ï¼Œé¢‘ç¹çš„åˆ†é…ä¸å›æ”¶ç‰©ç†é¡µå¯¼è‡´å¤§é‡çš„å°å—å†…å­˜å¤¹æ‚åœ¨å·²åˆ†é…é¡µé¢ä¸­é—´ï¼Œå½¢æˆå¤–éƒ¨ç¢ç‰‡ï¼Œä¸¾ä¸ªä¾‹å­ï¼š</p>
<p><img src="/posts/d0683ba8/waibu.png" alt="Image"></p>
<h3 id="å†…éƒ¨ç¢ç‰‡"><a href="#å†…éƒ¨ç¢ç‰‡" class="headerlink" title="å†…éƒ¨ç¢ç‰‡"></a>å†…éƒ¨ç¢ç‰‡</h3><p>ç‰©ç†å†…å­˜æ˜¯æŒ‰é¡µæ¥åˆ†é…çš„ï¼Œè¿™æ ·å½“å®é™…åªéœ€è¦å¾ˆå°å†…å­˜çš„æ—¶å€™ï¼Œä¹Ÿä¼šåˆ†é…è‡³å°‘æ˜¯ 4K å¤§å°çš„é¡µé¢ï¼Œè€Œå†…æ ¸ä¸­æœ‰å¾ˆå¤šéœ€è¦ä»¥å­—èŠ‚ä¸ºå•ä½åˆ†é…å†…å­˜çš„åœºæ™¯ï¼Œè¿™æ ·æœ¬æ¥åªæƒ³è¦å‡ ä¸ªå­—èŠ‚è€Œå·²å´ä¸å¾—ä¸åˆ†é…ä¸€é¡µå†…å­˜ï¼Œé™¤å»ç”¨æ‰çš„å­—èŠ‚å‰©ä¸‹çš„å°±å½¢æˆäº†å†…éƒ¨ç¢ç‰‡ã€‚</p>
<p><img src="/posts/d0683ba8/neibu.pnf" alt="Image"></p>
<h3 id="Buddyï¼ˆä¼™ä¼´ï¼‰åˆ†é…ç®—æ³•-gt-å¤–éƒ¨ç¢ç‰‡"><a href="#Buddyï¼ˆä¼™ä¼´ï¼‰åˆ†é…ç®—æ³•-gt-å¤–éƒ¨ç¢ç‰‡" class="headerlink" title="Buddyï¼ˆä¼™ä¼´ï¼‰åˆ†é…ç®—æ³• -&gt; å¤–éƒ¨ç¢ç‰‡"></a>Buddyï¼ˆä¼™ä¼´ï¼‰åˆ†é…ç®—æ³• -&gt; å¤–éƒ¨ç¢ç‰‡</h3><p>ç›¸åŒå¤§å°çš„é¡µæ¡†å—ç”¨é“¾è¡¨ä¸²èµ·æ¥ï¼Œé¡µæ¡†å—å°±åƒæ‰‹æ‹‰æ‰‹çš„å¥½ä¼™ä¼´ï¼Œä¹Ÿæ˜¯è¿™ä¸ªç®—æ³•åå­—çš„ç”±æ¥ã€‚</p>
<h3 id="slabåˆ†é…å™¨-gt-å†…éƒ¨ç¢ç‰‡"><a href="#slabåˆ†é…å™¨-gt-å†…éƒ¨ç¢ç‰‡" class="headerlink" title="slabåˆ†é…å™¨ - &gt; å†…éƒ¨ç¢ç‰‡"></a>slabåˆ†é…å™¨ - &gt; å†…éƒ¨ç¢ç‰‡</h3><p>é€šè¿‡å°†å†…å­˜æŒ‰ä½¿ç”¨å¯¹è±¡ä¸åŒ<strong>å†åˆ’åˆ†</strong>æˆä¸åŒå¤§å°çš„ç©ºé—´ï¼Œåº”ç”¨äºå†…æ ¸å¯¹è±¡çš„ç¼“å­˜ã€‚</p>
<h1 id="NUMA"><a href="#NUMA" class="headerlink" title="NUMA"></a>NUMA</h1><p>Nodeï¼ŒZoneï¼ŒPage</p>
<p><img src="/posts/d0683ba8/numa.jgp" alt="uma-numa"></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cat /proc/zoneinfo | grep Node</span><br><span class="line">Node 0, zone      DMA</span><br><span class="line">Node 0, zone    DMA32 # 64 bit system</span><br><span class="line">Node 0, zone   Normal</span><br><span class="line">Node 0, zone  Movable # é˜²æ­¢å†…å­˜ç¢ç‰‡åŒ–çš„ZONE_MOVABLE</span><br><span class="line">Node 0, zone   Device # æ”¯æŒè®¾å¤‡çƒ­æ’æ‹”çš„ZONE_DEVICE</span><br><span class="line">Node 1, zone      DMA</span><br><span class="line">Node 1, zone    DMA32</span><br><span class="line">Node 1, zone   Normal</span><br><span class="line">Node 1, zone  Movable</span><br><span class="line">Node 1, zone   Device</span><br><span class="line"><span class="meta">#</span><span class="bash"> æ²¡æœ‰ zone highmemï¼Œ å› ä¸ºæ˜¯64ä½ç³»ç»Ÿï¼Œå¯ä»¥ç›´æ¥æ˜ å°„</span></span><br></pre></td></tr></table></figure>









<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> lscpu</span></span><br><span class="line">Architecture:                    x86_64</span><br><span class="line">CPU op-mode(s):                  32-bit, 64-bit</span><br><span class="line">Byte Order:                      Little Endian</span><br><span class="line">Address sizes:                   46 bits physical, 48 bits virtual</span><br><span class="line">CPU(s):                          32  # cores per socket * sockets * thread per core </span><br><span class="line">On-line CPU(s) list:             0-31</span><br><span class="line">Thread(s) per core:              2</span><br><span class="line">Core(s) per socket:              8</span><br><span class="line">Socket(s):                       2</span><br><span class="line">NUMA node(s):                    2</span><br><span class="line">Vendor ID:                       GenuineIntel</span><br><span class="line">CPU family:                      6</span><br><span class="line">Model:                           45</span><br><span class="line">Model name:                      Intel(R) Xeon(R) CPU E5-2670 0 @ 2.60GHz</span><br><span class="line">Stepping:                        7</span><br><span class="line">CPU MHz:                         1207.495</span><br><span class="line">CPU max MHz:                     3300.0000</span><br><span class="line">CPU min MHz:                     1200.0000</span><br><span class="line">BogoMIPS:                        5187.02</span><br><span class="line">Virtualization:                  VT-x</span><br><span class="line">L1d cache:                       512 KiB  # instruction cache</span><br><span class="line">L1i cache:                       512 KiB  # data cache</span><br><span class="line">L2 cache:                        4 MiB</span><br><span class="line">L3 cache:                        40 MiB</span><br><span class="line">NUMA node0 CPU(s):               0-7,16-23</span><br><span class="line">NUMA node1 CPU(s):               8-15,24-31</span><br><span class="line">Vulnerability Itlb multihit:     KVM: Mitigation: Split huge pages</span><br><span class="line">Vulnerability L1tf:              Mitigation; PTE Inversion; VMX conditional cache flushes, SMT vulnerable</span><br><span class="line">Vulnerability Mds:               Mitigation; Clear CPU buffers; SMT vulnerable</span><br><span class="line">Vulnerability Meltdown:          Mitigation; PTI</span><br><span class="line">Vulnerability Spec store bypass: Mitigation; Speculative Store Bypass disabled via prctl and seccomp</span><br><span class="line">Vulnerability Spectre v1:        Mitigation; usercopy/swapgs barriers and __user pointer sanitization</span><br><span class="line">Vulnerability Spectre v2:        Mitigation; Full generic retpoline, IBPB conditional, IBRS_FW, STIBP conditional, RSB filling</span><br><span class="line">Vulnerability Srbds:             Not affected</span><br><span class="line">Vulnerability Tsx async abort:   Not affected</span><br><span class="line">Flags:                           fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxs</span><br><span class="line">                                 r sse sse2 ss ht tm pbe syscall nx pdpe1gb rdtscp lm constant_tsc arch_perfmon pebs bts rep_good</span><br><span class="line">                                  nopl xtopology nonstop_tsc cpuid aperfmperf pni pclmulqdq dtes64 monitor ds_cpl vmx smx est tm2</span><br><span class="line">                                  ssse3 cx16 xtpr pdcm pcid dca sse4_1 sse4_2 x2apic popcnt tsc_deadline_timer aes xsave avx lahf</span><br><span class="line">                                 _lm epb pti ssbd ibrs ibpb stib</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img src="/posts/d0683ba8/image-20210429154000972.png" alt="image-20210429154000972"></p>
<img src="/posts/d0683ba8/image-20210429154341590.png" alt="image-20210429154341590" style="zoom:67%;">

<h3 id><a href="#" class="headerlink" title></a></h3>]]></content>
      <categories>
        <category>linux</category>
      </categories>
      <tags>
        <tag>linux</tag>
      </tags>
  </entry>
  <entry>
    <title>ç½‘ç»œè™šæ‹ŸåŒ–ç®€ä»‹</title>
    <url>/posts/e41fb1bd.html</url>
    <content><![CDATA[<img src="/posts/e41fb1bd/image-20210201221242667.png" alt="image-20210201221242667" style="zoom:70%;">

]]></content>
      <categories>
        <category>è™šæ‹ŸåŒ–</category>
      </categories>
      <tags>
        <tag>network</tag>
        <tag>virtualization</tag>
      </tags>
  </entry>
  <entry>
    <title>å®¹å™¨çš„namespaceå’Œcgroups</title>
    <url>/posts/b56963ac.html</url>
    <content><![CDATA[<h2 id="namespace"><a href="#namespace" class="headerlink" title="namespace"></a>namespace</h2><h4 id="PID-namespace"><a href="#PID-namespace" class="headerlink" title="PID namespace"></a>PID namespace</h4><p>ä¸€ä¸ªå®¹å™¨å°±æ˜¯æ˜¯ä¸€ä¸ªè¿›ç¨‹ï¼Œåœ¨å¯åŠ¨ä¸‹é¢çš„å®¹å™¨çš„æ—¶å€™ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker run -it busybox sh  <span class="comment"># shæ˜¯å®¹å™¨çš„ç¬¬ä¸€ä¸ªè¿›ç¨‹</span></span></span><br><span class="line">/ # ps</span><br><span class="line">PID   USER     TIME  COMMAND</span><br><span class="line">    1 root      0:00 sh #PID=1</span><br><span class="line">    7 root      0:00 ps #PID=7</span><br></pre></td></tr></table></figure>
<p>Linuxåœ¨åˆ›å»ºæ–°è¿›ç¨‹çš„æ—¶å€™ï¼Œå®ƒçš„ç³»ç»Ÿè°ƒç”¨æ˜¯</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> pid = clone(main_function, stack_size, SIGCHLD, <span class="literal">NULL</span>); </span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å¯ä»¥åœ¨ç³»ç»Ÿè°ƒç”¨çš„æ—¶å€™ï¼Œä¼ å…¥ä¸€ä¸ª<code>CLONE_NEWPID</code>å‚æ•°ã€‚è¿™æ ·è¿™ä¸ªè¿›ç¨‹å°±æ˜¯åœ¨ä¸€ä¸ªå…¨æ–°çš„namespaceé‡Œï¼Œå¡”æ˜¯1å·è¿›ç¨‹ã€‚ä¸Šè¿°çš„<code>docker run</code>å‘½ä»¤çš„åº•å±‚ï¼Œå®åˆ™ä¹Ÿæ˜¯è°ƒç”¨äº†ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> pid = clone(main_function, stack_size, CLONE_NEWPID | SIGCHLD, <span class="literal">NULL</span>); </span><br></pre></td></tr></table></figure>
<p>è¿™åªæ˜¯Linuxæä¾›çš„namespaceçš„ä¸€ç§ï¼Œå«åšPID namespaceã€‚</p>
<p>åœ¨æ–°çš„å‘½åç©ºé—´é‡Œåˆ›å»ºçš„è¿›ç¨‹ï¼Œåœ¨å‘½åç©ºé—´é‡Œçš„PID=1ï¼Œä½†æ˜¯åœ¨hostä¸ŠæŸ¥çœ‹ï¼ŒPIDå°±ä¸ç­‰äº1äº†ã€‚</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ps -aux | grep sh</span></span><br><span class="line">root       36046  0.0  0.0   1324     4 pts/0    Ss+  01:15   0:00 sh  # PID=36046</span><br></pre></td></tr></table></figure>
<p>æ­¤å¤–ï¼ŒLinux æ“ä½œç³»ç»Ÿè¿˜æä¾›äº† <strong>Mount</strong>ã€<strong>UTS</strong>ã€<strong>IPC</strong>ã€<strong>Network</strong> å’Œ <strong>User</strong> è¿™äº› Namespaceï¼Œç”¨æ¥å¯¹å„ç§ä¸åŒçš„è¿›ç¨‹ä¸Šä¸‹æ–‡è¿›è¡Œâ€œéšœçœ¼æ³•â€æ“ä½œã€‚</p>
<h4 id="Mount-namespace"><a href="#Mount-namespace" class="headerlink" title="Mount namespace"></a>Mount namespace</h4><p>ç”¨äºè®©è¢«éš”ç¦»è¿›ç¨‹åªçœ‹åˆ°å½“å‰ Namespace é‡Œçš„æŒ‚è½½ç‚¹ä¿¡æ¯</p>
<h4 id="Network-Namespace"><a href="#Network-Namespace" class="headerlink" title="Network Namespace"></a>Network Namespace</h4><p>ç”¨äºè®©è¢«éš”ç¦»è¿›ç¨‹çœ‹åˆ°å½“å‰ Namespace é‡Œçš„ç½‘ç»œè®¾å¤‡å’Œé…ç½®ã€‚</p>
<h2 id="è™šæ‹Ÿæœº-vs-å®¹å™¨"><a href="#è™šæ‹Ÿæœº-vs-å®¹å™¨" class="headerlink" title="è™šæ‹Ÿæœº vs å®¹å™¨"></a>è™šæ‹Ÿæœº vs å®¹å™¨</h2><h4 id="hypervisorå’Œdocker-engine"><a href="#hypervisorå’Œdocker-engine" class="headerlink" title="hypervisorå’Œdocker engine"></a>hypervisorå’Œdocker engine</h4><img src="/posts/b56963ac/image-20210203222905761.png" alt="image-20210203222905761" style="zoom:50%;">

<p><strong>hypervisor</strong>ï¼šå¯¹åº”ç”¨è¿›ç¨‹çš„éš”ç¦»ç¯å¢ƒè´Ÿè´£</p>
<p><strong>docker engine</strong>ï¼šå¯¹éš”ç¦»æ€§ä¸è´Ÿè´£ä»»ï¼ŒçœŸæ­£å¯¹éš”ç¦»æ€§è´Ÿè´£çš„æ˜¯linux osï¼ˆnamespaceï¼‰ã€‚</p>
<h4 id="VMå’Œcontainer"><a href="#VMå’Œcontainer" class="headerlink" title="VMå’Œcontainer"></a>VMå’Œcontainer</h4><table>
<thead>
<tr>
<th>VM</th>
<th>Container</th>
</tr>
</thead>
<tbody><tr>
<td>æ€§èƒ½æŸè€—æ¯”è¾ƒå¤§ï¼Œä¸€ä¸ªVMè‡ªå·±å°±è¦å 100-200MBã€‚åœ¨åšç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œè¿˜éœ€è¦ç»è¿‡hypervisorå±‚çš„æ‹¦æˆªå’Œå¤„ç†ï¼Œè¿™åˆæ˜¯ä¸€å±‚æ€§èƒ½æŸè€—</td>
<td>æ²¡æœ‰å› ä¸ºè™šæ‹ŸåŒ–å¸¦æ¥çš„æ€§èƒ½æŸè€—ï¼Œä¹Ÿæ²¡æœ‰guest osï¼Œé™¤äº†å®¹å™¨æœ¬èº«ä¹‹å¤–ï¼Œå…¶ä»–èµ„æºå ç”¨å¯ä»¥å‡ ä¹ä¸è®¡ã€‚</td>
</tr>
<tr>
<td>éš”ç¦»æ€§é«˜ï¼Œä¸å…±äº«å†…æ ¸ï¼Œlinuxé›†ç¾¤å¯ä»¥èµ·Window VMï¼Œåä¹‹äº¦ç„¶</td>
<td>éš”ç¦»çš„ä¸å½»åº•ï¼Œå…±äº«å†…æ ¸ï¼Œä¸èƒ½åœ¨linuxä¸Šèµ·windowå®¹å™¨ï¼Œåä¹‹äº¦ç„¶</td>
</tr>
<tr>
<td>å¯¹ç”¨æˆ·è¦æ±‚ä½</td>
<td>å¯¹ç”¨æˆ·è¦æ±‚é«˜ï¼Œç”¨æˆ·è¦çŸ¥é“ï¼Œåœ¨å®¹å™¨é‡Œï¼Œä»€ä¹ˆèƒ½åšï¼Œä»€ä¹ˆä¸èƒ½åšï¼Œä¸ç„¶æœ‰å¯èƒ½æ”¹äº†å®¹å™¨é‡Œçš„ä¸œè¥¿ï¼Œhostä¸Šçš„ä¸œè¥¿ä¹Ÿå˜äº†</td>
</tr>
</tbody></table>
<p><strong>ä¾‹å­</strong>ï¼šåœ¨ Linux å†…æ ¸ä¸­ï¼Œæœ‰å¾ˆå¤šèµ„æºå’Œå¯¹è±¡æ˜¯ä¸èƒ½è¢« Namespace åŒ–çš„ï¼Œæœ€å…¸å‹çš„ä¾‹å­å°±æ˜¯ï¼š<strong>æ—¶é—´</strong>ã€‚è¿™å°±æ„å‘³ç€ï¼Œå¦‚æœä½ çš„å®¹å™¨ä¸­çš„ç¨‹åºä½¿ç”¨ settimeofday(2) ç³»ç»Ÿè°ƒç”¨ä¿®æ”¹äº†æ—¶é—´ï¼Œæ•´ä¸ªå®¿ä¸»æœºçš„æ—¶é—´éƒ½ä¼šè¢«éšä¹‹ä¿®æ”¹ï¼Œè¿™æ˜¾ç„¶ä¸ç¬¦åˆç”¨æˆ·çš„é¢„æœŸã€‚</p>
<h2 id="Cgroups"><a href="#Cgroups" class="headerlink" title="Cgroups"></a>Cgroups</h2><p>çŸ¥é“äº†namespaceæŠ€æœ¯ä¹‹åï¼Œæˆ‘ä»¬çŸ¥é“ä¸€ä¸ªå®¹å™¨å°±æ˜¯ä¸€ä¸ªè¿›ç¨‹ï¼Œå’Œhostä¸Šå…¶ä»–è¿›ç¨‹ä¸€æ ·ã€‚é‚£ä¹ˆå¦‚æœè¿™ä¸ªå®¹å™¨è¿›ç¨‹å ç”¨äº†hostä¸Šçš„æ‰€æœ‰èµ„æºï¼Œé‚£ä¹ˆè¿™ä¸ªhostå°±å¡æ­»äº†ã€‚è¿™æ˜¾ç„¶æ˜¯ä¸åˆç†çš„ã€‚æˆ‘ä»¬éœ€è¦é™åˆ¶å®¹å™¨çš„èµ„æºä¸Šé™ï¼Œè¿™å°±æ˜¯cgroupsåšçš„äº‹æƒ…ã€‚</p>
<p> <strong>Linux Cgroups å°±æ˜¯ Linux å†…æ ¸ä¸­ç”¨æ¥ä¸ºè¿›ç¨‹è®¾ç½®èµ„æºé™åˆ¶çš„ä¸€ä¸ªé‡è¦åŠŸèƒ½ã€‚</strong>ä¸»è¦é™åˆ¶CPUï¼Œå†…å­˜ï¼Œç£ç›˜ï¼Œç½‘ç»œå¸¦å®½ç­‰ç­‰ã€‚</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> cgroupsç»™ç”¨æˆ·æš´éœ²å‡ºæ¥çš„æ“ä½œæ¥å£æ˜¯æ–‡ä»¶ç³»ç»Ÿ</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ll /sys/fs/cgroup/</span></span><br><span class="line">total 0</span><br><span class="line">dr-xr-xr-x. 6 root root  0 Jan 30 10:16 blkio  # ä¸ºå—è®¾å¤‡åˆ¶å®šIOé™åˆ¶</span><br><span class="line">lrwxrwxrwx. 1 root root 11 Jan 30 10:16 cpu -&gt; cpu,cpuacct  # cpué™åˆ¶</span><br><span class="line">dr-xr-xr-x. 6 root root  0 Jan 30 10:16 cpu,cpuacct</span><br><span class="line">lrwxrwxrwx. 1 root root 11 Jan 30 10:16 cpuacct -&gt; cpu,cpuacct</span><br><span class="line">dr-xr-xr-x. 3 root root  0 Jan 30 10:16 cpuset  # ä¸ºè¿›ç¨‹åˆ†é…å•ç‹¬çš„cpuæ ¸å’Œå¯¹åº”çš„å†…å­˜èŠ‚ç‚¹</span><br><span class="line">dr-xr-xr-x. 6 root root  0 Jan 30 10:16 devices</span><br><span class="line">dr-xr-xr-x. 3 root root  0 Jan 30 10:16 freezer</span><br><span class="line">dr-xr-xr-x. 3 root root  0 Jan 30 10:16 hugetlb</span><br><span class="line">dr-xr-xr-x. 6 root root  0 Jan 30 10:16 memory  # å†…å­˜é™åˆ¶</span><br><span class="line">lrwxrwxrwx. 1 root root 16 Jan 30 10:16 net_cls -&gt; net_cls,net_prio</span><br><span class="line">dr-xr-xr-x. 3 root root  0 Jan 30 10:16 net_cls,net_prio</span><br><span class="line">lrwxrwxrwx. 1 root root 16 Jan 30 10:16 net_prio -&gt; net_cls,net_prio</span><br><span class="line">dr-xr-xr-x. 3 root root  0 Jan 30 10:16 perf_event</span><br><span class="line">dr-xr-xr-x. 6 root root  0 Jan 30 10:16 pids</span><br><span class="line">dr-xr-xr-x. 2 root root  0 Jan 30 10:16 rdma</span><br><span class="line">dr-xr-xr-x. 6 root root  0 Jan 30 10:16 systemd</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo mount -t cgroup</span></span><br><span class="line">cgroup on /sys/fs/cgroup/systemd type cgroup (rw,nosuid,nodev,noexec,relatime,seclabel,xattr,release_agent=/usr/lib/systemd/systemd-cgroups-agent,name=systemd)</span><br><span class="line">cgroup on /sys/fs/cgroup/perf_event type cgroup (rw,nosuid,nodev,noexec,relatime,seclabel,perf_event)</span><br><span class="line">cgroup on /sys/fs/cgroup/memory type cgroup (rw,nosuid,nodev,noexec,relatime,seclabel,memory)</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<h4 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> /sys/fs/cgroup/cpu</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> mkdir <span class="built_in">test</span> &amp;&amp; <span class="built_in">cd</span> <span class="built_in">test</span> &amp;&amp; ls</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> å‘ç°æ–°å»ºçš„<span class="built_in">test</span>ç›®å½•é‡Œå·²ç»æœ‰è‡ªåŠ¨ç”Ÿæˆçš„ä¸€äº›æ–‡ä»¶äº†ï¼Œæˆ‘ä»¬å¯ä»¥å†™è¿™äº›æ–‡ä»¶æ¥é™åˆ¶æŸä¸€ä¸ªè¿›ç¨‹çš„èµ„æºä¸Šé™</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> æˆ‘ä»¬å…ˆæ¥è¿è¡Œä¸€ä¸ªè¿›ç¨‹ï¼Œæ­»å¾ªç¯ï¼ŒæŠŠCPUå æ»¡ï¼Œå¯ä»¥é€šè¿‡topæŸ¥çœ‹</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="keyword">while</span> : ; <span class="keyword">do</span> : ; <span class="keyword">done</span></span> </span><br><span class="line">&amp;[1] 226</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> ç„¶åæˆ‘ä»¬å¯ä»¥é€šè¿‡å†™cgroup fsæ¥é™åˆ¶è¿™ä¸ªè¿›ç¨‹çš„cpuèµ„æºä¸Šé™</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> tasksé‡Œé¢æ˜¯è¦é™åˆ¶çš„è¿›ç¨‹çš„PID</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">echo</span> 226 &gt; tasks</span> </span><br><span class="line"><span class="meta">#</span><span class="bash"> é»˜è®¤-1ï¼Œè¡¨ç¤ºæ²¡æœ‰ä¸Šé™</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat /sys/fs/cgroup/cpu/container/cpu.cfs_quota_us</span> </span><br><span class="line">-1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 100ms</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat /sys/fs/cgroup/cpu/container/cpu.cfs_period_us</span> </span><br><span class="line">100000</span><br><span class="line"><span class="meta">#</span><span class="bash">20ms</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">echo</span> 20000 &gt; /sys/fs/cgroup/cpu/container/cpu.cfs_quota_us</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> è¯´æ˜ï¼šæ¯100msé‡Œï¼Œè¢«è¿™ä¸ªcgroupæ§åˆ¶çš„è¿›ç¨‹ï¼Œä¹Ÿå°±æ˜¯226ï¼Œåªèƒ½ä½¿ç”¨20msçš„æ—¶é—´ã€‚å°½ç®¡æ˜¯ä¸ªæ­»å¾ªç¯ï¼ŒåŠ äº†é™åˆ¶ä¹‹åcpuå ç”¨ç‡ä¸ä¼šé«˜äº20%ï¼Œç‰›ï¼</span></span><br></pre></td></tr></table></figure>
<h4 id="cgroupçš„ä¸€äº›é™åˆ¶"><a href="#cgroupçš„ä¸€äº›é™åˆ¶" class="headerlink" title="cgroupçš„ä¸€äº›é™åˆ¶"></a>cgroupçš„ä¸€äº›é™åˆ¶</h4><p>ä¸Šæ¥æˆ‘ä»¬ç”¨åˆ°çš„<code>top</code>å‘½ä»¤ï¼Œä¸»è¦çš„æ•°æ®æ¥æºéƒ½æ˜¯<code>/proc</code>ç›®å½•ä¸‹ã€‚è¿™ä¸ª/procç›®å½•è®°å½•å½“å‰å†…æ ¸è¿è¡ŒçŠ¶æ€çš„æ•°æ®ï¼Œå®ƒå¹¶ä¸çŸ¥é“cgroupé™åˆ¶äº†ä¸€ä¸ªå®¹å™¨ä»€ä¹ˆã€‚</p>
<p>æ‰€ä»¥åœ¨å®¹å™¨é‡Œè¿è¡Œtopæ—¶ï¼Œå®ƒä¹Ÿä¼šæ˜¾ç¤ºhostçš„cpuï¼Œå†…å­˜ä¿¡æ¯ã€‚</p>
]]></content>
      <categories>
        <category>docker</category>
      </categories>
      <tags>
        <tag>docker</tag>
        <tag>linux</tag>
      </tags>
  </entry>
  <entry>
    <title>è®¡ç®—æœºç½‘ç»œæ¦‚è¿°</title>
    <url>/posts/7c4ca347.html</url>
    <content><![CDATA[<h2 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h2><h3 id="1-é€Ÿç‡ç›¸å…³æ€§èƒ½æŒ‡æ ‡"><a href="#1-é€Ÿç‡ç›¸å…³æ€§èƒ½æŒ‡æ ‡" class="headerlink" title="1. é€Ÿç‡ç›¸å…³æ€§èƒ½æŒ‡æ ‡"></a>1. é€Ÿç‡ç›¸å…³æ€§èƒ½æŒ‡æ ‡</h3><h4 id="é€Ÿç‡"><a href="#é€Ÿç‡" class="headerlink" title="é€Ÿç‡"></a>é€Ÿç‡</h4><p>åœ¨æ•°å­—ä¿¡é“ä¸Šä¼ è¾“æ•°æ®ä½çš„é€Ÿåº¦ã€‚å•ä½: b/s,Kb/s,Mb/s,Tb/sï¼Œ<br>å¦‚æœç”¨å­—èŠ‚è¡¨ç¤ºï¼Œåˆ™æ˜¯B/s,KB/s,MB/s,TB/sï¼ˆ1Byte=8Bitï¼‰</p>
<h4 id="å¸¦å®½"><a href="#å¸¦å®½" class="headerlink" title="å¸¦å®½"></a>å¸¦å®½</h4><p>å•ä½åŒé€Ÿç‡ï¼ŒæŒ‡ç†æƒ³æ¡ä»¶ä¸‹çš„æœ€é«˜é€Ÿç‡ã€‚</p>
<h4 id="ååé‡"><a href="#ååé‡" class="headerlink" title="ååé‡"></a>ååé‡</h4><p>å•ä½æ—¶é—´å†…é€šè¿‡æŸä¸ªç½‘ç»œçš„æ•°æ®æ€»é‡ã€‚</p>
<h4 id="ä¾‹å­"><a href="#ä¾‹å­" class="headerlink" title="ä¾‹å­"></a>ä¾‹å­</h4><p>æ¯”å¦‚è¯´1000Må®½å¸¦çš„è·¯ç”±å™¨è¿ç€ä¸‰éƒ¨æ‰‹æœºï¼Œæ¯éƒ¨æ‰‹æœºéƒ½æ˜¯10mb/sçœ‹ç‰‡ï¼Œé‚£ä¹ˆé€Ÿç‡å°±æ˜¯10mb/sï¼Œå¸¦å®½æ˜¯å®½å¸¦çš„1000mï¼Œè·¯ç”±å™¨ååé‡æ˜¯30mb/sã€‚</p>
<img src="/posts/7c4ca347/image-20210208111213048.png" alt="image-20210208111213048" style="zoom:50%;">



<h3 id="2-æ—¶å»¶ç›¸å…³æ€§èƒ½æŒ‡æ ‡"><a href="#2-æ—¶å»¶ç›¸å…³æ€§èƒ½æŒ‡æ ‡" class="headerlink" title="2. æ—¶å»¶ç›¸å…³æ€§èƒ½æŒ‡æ ‡"></a>2. æ—¶å»¶ç›¸å…³æ€§èƒ½æŒ‡æ ‡</h3><h4 id="æ—¶å»¶"><a href="#æ—¶å»¶" class="headerlink" title="æ—¶å»¶"></a>æ—¶å»¶</h4><table>
<thead>
<tr>
<th>åç§°</th>
<th>æè¿°</th>
<th>è®¡ç®—å…¬å¼</th>
</tr>
</thead>
<tbody><tr>
<td>å‘é€æ—¶å»¶</td>
<td>æ•°æ®ä»ä¸»æœºåˆ°ä¿¡é“ä¸Šæ‰€ç”¨çš„æ—¶é—´</td>
<td>å‘é€çš„æ•°æ®é•¿åº¦/å‘é€é€Ÿç‡</td>
</tr>
<tr>
<td>ä¼ æ’­æ—¶å»¶</td>
<td>æ•°æ®åœ¨ä¿¡é“ä¸Šä¼ æ’­æ‰€èŠ±è´¹çš„æ—¶é—´</td>
<td>ä¿¡é“é•¿åº¦/ç”µç£æ³¢åœ¨ä¿¡é“ä¸Šä¼ æ’­çš„é€Ÿç‡</td>
</tr>
<tr>
<td>æ’é˜Ÿæ—¶å»¶</td>
<td>æ•°æ®åœ¨è·¯ç”±å™¨å‰ç­‰å¾…å‰é¢æ•°æ®å¤„ç†çš„æ—¶é—´</td>
<td>æ— è®¡ç®—æ–¹å¼</td>
</tr>
<tr>
<td>å¤„ç†æ—¶å»¶</td>
<td>æ•°æ®åœ¨è·¯ç”±å™¨ä¸­å¤„ç†éœ€æ±‚çš„æ—¶é—´</td>
<td>æ— è®¡ç®—æ–¹å¼</td>
</tr>
</tbody></table>
<h4 id="æ—¶å»¶å¸¦å®½ç§¯"><a href="#æ—¶å»¶å¸¦å®½ç§¯" class="headerlink" title="æ—¶å»¶å¸¦å®½ç§¯"></a>æ—¶å»¶å¸¦å®½ç§¯</h4><p>ä¼ æ’­æ—¶å»¶*å¸¦å®½</p>
<p>è¡¨ç¤ºæ•´ä¸ªé“¾è·¯ä¸Šæ€»å…±æœ‰å¤šå°‘bitçš„æ•°æ®ã€‚</p>
<h4 id="å¾€è¿”æ—¶é—´RTT"><a href="#å¾€è¿”æ—¶é—´RTT" class="headerlink" title="å¾€è¿”æ—¶é—´RTT"></a>å¾€è¿”æ—¶é—´RTT</h4><p>ä»å‘é€æ–¹å‘é€æ•°æ®å¼€å§‹ï¼Œåˆ°æ¥å—æ–¹ç¡®è®¤æ¥å—åˆ°æ•°æ®ä¸ºæ­¢èŠ±è´¹çš„æ—¶é—´</p>
<p>= ä¼ æ’­æ—¶å»¶*2 + å¤„ç†æ—¶å»¶</p>
<h3 id="3-åˆ©ç”¨ç‡"><a href="#3-åˆ©ç”¨ç‡" class="headerlink" title="3. åˆ©ç”¨ç‡"></a>3. åˆ©ç”¨ç‡</h3><h4 id="ä¿¡é“åˆ©ç”¨ç‡"><a href="#ä¿¡é“åˆ©ç”¨ç‡" class="headerlink" title="ä¿¡é“åˆ©ç”¨ç‡"></a>ä¿¡é“åˆ©ç”¨ç‡</h4><p>=  æœ‰æ•°æ®é€šè¿‡çš„æ—¶é—´/ï¼ˆæœ‰+æ— æ•°æ®é€šè¿‡çš„æ—¶é—´ï¼‰</p>
<h4 id="ç½‘ç»œåˆ©ç”¨ç‡"><a href="#ç½‘ç»œåˆ©ç”¨ç‡" class="headerlink" title="ç½‘ç»œåˆ©ç”¨ç‡"></a>ç½‘ç»œåˆ©ç”¨ç‡</h4><p>= æ‰€æœ‰ä¿¡é“åˆ©ç”¨ç‡åŠ æƒæ±‚å¹³å‡å€¼</p>
<h4 id="æ—¶å»¶å’Œåˆ©ç”¨ç‡çš„å…³ç³»"><a href="#æ—¶å»¶å’Œåˆ©ç”¨ç‡çš„å…³ç³»" class="headerlink" title="æ—¶å»¶å’Œåˆ©ç”¨ç‡çš„å…³ç³»"></a>æ—¶å»¶å’Œåˆ©ç”¨ç‡çš„å…³ç³»</h4><img src="/posts/7c4ca347/image-20210208111943694.png" alt="image-20210208111943694">



<h3 id="4-ç½‘ç»œçš„åˆ†å±‚ç»“æ„"><a href="#4-ç½‘ç»œçš„åˆ†å±‚ç»“æ„" class="headerlink" title="4. ç½‘ç»œçš„åˆ†å±‚ç»“æ„"></a>4. ç½‘ç»œçš„åˆ†å±‚ç»“æ„</h3><p><img src="/posts/7c4ca347/image-20210208112313439.png" alt="image-20210208112313439"></p>
<p>ç»“åˆTCP/IPå‚è€ƒæ¨¡å‹å’ŒOSIå‚è€ƒæ¨¡å‹ï¼Œç°åœ¨å¹¿æ³›ä½¿ç”¨çš„æ˜¯äº”å±‚å‚è€ƒæ¨¡å‹ï¼Œå¦‚ä¸‹å›¾ï¼š</p>
<p><img src="/posts/7c4ca347/image-20210208112446492.png" alt="image-20210208112446492"></p>
<p>ä¸‹é¢å°†æŒ‰ç…§è¿™äº”å±‚ä¸€æ¬¡ä»‹ç»ã€‚</p>
<h2 id="ç‰©ç†å±‚"><a href="#ç‰©ç†å±‚" class="headerlink" title="ç‰©ç†å±‚"></a>ç‰©ç†å±‚</h2><p>ä¸»è¦è´Ÿè´£ä¼ è¾“æ•°æ®æ¯”ç‰¹æµã€‚</p>
<h4 id="ç å…ƒ"><a href="#ç å…ƒ" class="headerlink" title="ç å…ƒ"></a>ç å…ƒ</h4><p>ä¸€ä¸ªç å…ƒå°±æ˜¯ä¸€ä¸ªè„‰å†²ä¿¡å·ï¼Œå¦‚æœè¿™ä¸ªè„‰å†²ä¿¡å·æ˜¯çŸ©å½¢è„‰å†²ï¼Œåªæœ‰é«˜ä½ä¸¤ä¸ªç”µå¹³ï¼Œåˆ™åªèƒ½è¡¨ç¤º0æˆ–è€…1ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªæ¯”ç‰¹ä½ã€‚å¦‚æœè¿™ä¸ªè„‰å†²ä¿¡å·æœ‰8ç§å˜åŒ–ï¼ˆå¯ä»¥æ˜¯ç”µå¹³é«˜ä½ï¼Œç›¸ä½å˜åŒ–ç­‰ï¼‰ï¼Œåˆ™å¯ä»¥è¡¨ç¤º3ä½æ¯”ç‰¹ä½ï¼ˆ000-111ï¼‰ä¸€å…±å…«ç§ã€‚</p>
<p><strong>ç»“è®º</strong>ï¼šä¸€ä¸ªç å…ƒå°±æ˜¯ä¸€ä¸ªè„‰å†²ï¼Œä¸€ä¸ªè„‰å†²æœ‰Nä¸­å˜åŒ–ï¼Œåˆ™å¯ä»¥è¡¨ç¤ºlog<sub>2</sub>Nä½bitã€‚</p>
<h4 id="æ³¢ç‰¹ï¼ˆBaudï¼‰"><a href="#æ³¢ç‰¹ï¼ˆBaudï¼‰" class="headerlink" title="æ³¢ç‰¹ï¼ˆBaudï¼‰"></a>æ³¢ç‰¹ï¼ˆBaudï¼‰</h4><p>ä¸€ç§’å¯ä»¥ä¼ è¾“å¤šå°‘ä¸ªç å…ƒã€‚</p>
<h4 id="é€Ÿç‡-1"><a href="#é€Ÿç‡-1" class="headerlink" title="é€Ÿç‡"></a>é€Ÿç‡</h4><p>åˆ†ä¸º<strong>ç å…ƒä¼ è¾“é€Ÿç‡</strong>å’Œ<strong>ä¿¡æ¯ä¼ è¾“é€Ÿç‡</strong></p>
<p>ä¿¡æ¯ä¼ è¾“é€Ÿç‡å°±æ˜¯b/sï¼Œå°±æ˜¯æˆ‘ä»¬å¹³å¸¸è¯´çš„<strong>ç½‘é€Ÿ</strong></p>
<p>ç å…ƒå¯ä»¥ç†è§£ä¸ºå‡ ä¸ªæ¯”ç‰¹çš„<strong>é›†åˆ</strong>ï¼Œæ‰€ä»¥ä¿¡æ¯ä¼ è¾“é€Ÿç‡ï¼ˆç½‘é€Ÿï¼‰=ç å…ƒä¼ è¾“é€Ÿç‡xç å…ƒæ‰€å¸¦ä¿¡æ¯é‡ï¼ˆå¤šå°‘æ¯”ç‰¹ï¼‰</p>
<h4 id="ä¸‰ç§é€šè®¯æ¨¡å¼"><a href="#ä¸‰ç§é€šè®¯æ¨¡å¼" class="headerlink" title="ä¸‰ç§é€šè®¯æ¨¡å¼"></a>ä¸‰ç§é€šè®¯æ¨¡å¼</h4><p>å•å·¥ï¼šåªèƒ½ä¸€ä¸ªå‘ä¸€ä¸ªæ”¶ï¼Œéœ€è¦1æ¡ä¿¡é“</p>
<p>åŠåŒå·¥ï¼šéƒ½å¯ä»¥å‘æˆ–è€…æ”¶ï¼Œä½†åŒä¸€æ—¶é—´åªèƒ½è¿›è¡Œä¸€ä¸ªï¼Œéœ€è¦2æ¡ä¿¡é“</p>
<p>å…¨åŒå·¥ï¼šå¯ä»¥åŒæ—¶æ”¶å’Œå‘ï¼Œéœ€è¦2æ¡ä¿¡é“</p>
<h4 id="ä¸¤ç§æ•°æ®ä¼ è¾“æ¨¡å¼"><a href="#ä¸¤ç§æ•°æ®ä¼ è¾“æ¨¡å¼" class="headerlink" title="ä¸¤ç§æ•°æ®ä¼ è¾“æ¨¡å¼"></a>ä¸¤ç§æ•°æ®ä¼ è¾“æ¨¡å¼</h4><p>ä¸²è¡Œï¼šé€Ÿåº¦æ…¢ï¼Œçœé’±ï¼Œé€‚åˆè¿œè·ç¦» </p>
<p>å¹¶è¡Œï¼šé€Ÿåº¦å¿«ï¼ŒèŠ±é’±ï¼Œé€‚åˆè¿‘è·ç¦»</p>
<p><img src="/posts/7c4ca347/image-20210208115132757.png" alt="image-20210208115132757"></p>
<h4 id="å·¥ä½œåœ¨ç‰©ç†å±‚çš„è®¾å¤‡"><a href="#å·¥ä½œåœ¨ç‰©ç†å±‚çš„è®¾å¤‡" class="headerlink" title="å·¥ä½œåœ¨ç‰©ç†å±‚çš„è®¾å¤‡"></a>å·¥ä½œåœ¨ç‰©ç†å±‚çš„è®¾å¤‡</h4><h5 id="ä¸­ç»§å™¨"><a href="#ä¸­ç»§å™¨" class="headerlink" title="ä¸­ç»§å™¨"></a>ä¸­ç»§å™¨</h5><p>å½“æ•°æ®ç¦»å¼€æºåœ¨ç½‘ç»œä¸Šä¼ é€æ—¶ï¼Œå®ƒæ˜¯è½¬æ¢ä¸ºèƒ½å¤Ÿæ²¿ç€ç½‘ç»œä»‹è´¨ä¼ è¾“çš„ç”µè„‰å†²æˆ–å…‰è„‰å†²çš„â€”â€”è¿™äº›è„‰å†²ç§°ä¸ºä¿¡å·ï¼ˆsignalï¼‰ã€‚å½“ä¿¡å·æ²¿ç€ç½‘ç»œä»‹è´¨è¿›è¡Œä¼ é€æ—¶ï¼Œ éšç€ç»è¿‡çš„çº¿ç¼†è¶Šæ¥è¶Šé•¿ï¼Œä¿¡å·å°±ä¼šå˜å¾—è¶Šæ¥è¶Šå¼±ï¼Œè¶Šæ¥è¶Šå·®ã€‚ä¸­ç»§å™¨çš„ç›®çš„æ˜¯åœ¨<strong>æ¯”ç‰¹çº§åˆ«</strong>å¯¹ç½‘ç»œä¿¡å·è¿›è¡Œ<strong>å†ç”Ÿå’Œé‡å®š</strong>æ—¶ï¼Œä»è€Œä½¿å¾—å®ƒä»¬èƒ½å¤Ÿåœ¨ç½‘ç»œä¸Šä¼ è¾“æ›´é•¿çš„è·ç¦»ã€‚</p>
<p>ä½œç”¨ï¼šå¯¹ä¿¡å·è¿›è¡Œæ”¾å¤§å’Œæ•´å½¢ï¼Œä»…é€‚ç”¨äºä»¥å¤ªç½‘ã€‚</p>
<img src="/posts/7c4ca347/image-20210208161145175.png" alt="image-20210208161145175" style="zoom:150%;">

<h5 id="é›†çº¿å™¨ï¼ˆHUBï¼‰"><a href="#é›†çº¿å™¨ï¼ˆHUBï¼‰" class="headerlink" title="é›†çº¿å™¨ï¼ˆHUBï¼‰"></a>é›†çº¿å™¨ï¼ˆHUBï¼‰</h5><p>ä¹Ÿæœ‰æ”¾å¤§å’Œæ•´å½¢çš„åŠŸèƒ½ï¼Œå¯ä»¥çœ‹ä½œæ˜¯ä¸€ä¸ªå¤šç«¯å£çš„ä¸­ç»§å™¨ã€‚</p>
<p>HUBæ˜¯ç½‘ç»œä¸­å„ä¸ªè®¾å¤‡çš„é€šç”¨è¿æ¥ç‚¹ï¼Œå®ƒé€šå¸¸ç”¨äºè¿æ¥LANçš„åˆ†æ®µã€‚HUBå«æœ‰å¤šä¸ªç«¯å£ã€‚æ¯ä¸€ä¸ªåˆ†ç»„åˆ°è¾¾æŸä¸ªç«¯å£æ—¶ï¼Œéƒ½ä¼šè¢«å¤åˆ¶åˆ°å…¶ä»–æ‰€æœ‰ç«¯å£ï¼ˆå¹¿æ’­ï¼‰ï¼Œä»¥ä¾¿æ‰€æœ‰çš„LANåˆ†æ®µéƒ½èƒ½çœ‹è§æ‰€æœ‰çš„åˆ†ç»„ã€‚é›†çº¿å™¨å¹¶ä¸è®¤è¯†ä¿¡å·ã€åœ°å€æˆ–æ•°æ®ä¸­ä»»ä½•ä¿¡æ¯æ¨¡å¼ã€‚</p>
<h6 id="é›†çº¿å™¨äº§ç”Ÿçš„æ€è·¯ï¼š"><a href="#é›†çº¿å™¨äº§ç”Ÿçš„æ€è·¯ï¼š" class="headerlink" title="é›†çº¿å™¨äº§ç”Ÿçš„æ€è·¯ï¼š"></a>é›†çº¿å™¨äº§ç”Ÿçš„æ€è·¯ï¼š</h6><p>ä¸€å¼€å§‹ï¼Œç”µè„‘ä¹‹å‰å°±é€šè¿‡ç½‘çº¿è¿æ¥ï¼Œå½“ç”µè„‘æ•°é‡å¢å¤šæ—¶ï¼Œå°±ä¼šå¾ˆä¹±ï¼Œç½‘ç»œå˜å¾—å¼‚å¸¸å¤æ‚ã€‚<img src="/posts/7c4ca347/image-20210208161725908.png" alt="image-20210208161725908" style="zoom:50%;"></p>
<p>æ‰€ä»¥æˆ‘ä»¬åœ¨è¿™äº›ç”µè„‘çš„ä¸­é—´åŠ ä¸€ä¸ªè®¾å¤‡â€”â€”é›†çº¿å™¨ã€‚</p>
<img src="/posts/7c4ca347/image-20210208162211908.png" alt="image-20210208162211908" style="zoom:67%;">



<p>æ¯ä¸ªç”µè„‘æ’åœ¨é›†çº¿å™¨çš„ä¸€ä¸ªç«¯å£ä¸Šã€‚è¿™æ ·æ¯å°ç”µè„‘å‘é€æ•°æ®éƒ½è¦é€šè¿‡é›†çº¿å™¨ã€‚æ¯”å¦‚Aè¦ç»™Eå‘æ¶ˆæ¯ï¼Œé‚£ä¹ˆAå‘å‡ºä¸€ä¸ªåŒ…ï¼Œè¿™ä¸ªåŒ…åˆ°è¾¾hubä¹‹åï¼Œä¼šè¢«hubå‘å¾€å„ä¸ªç«¯å£ï¼ŒBCDEéƒ½èƒ½æ”¶åˆ°ï¼Œåªæœ‰Eæ”¶åˆ°è¿™ä¸ªåŒ…ï¼Œå‘ç°åŒ…å¤´çš„MACæ ‡è¯†çš„æ—¶è‡ªå·±ï¼Œäºæ˜¯æ¥æ”¶è¿™ä¸ªåŒ…ï¼Œå…¶ä»–çš„BCDéƒ½ä¸¢å¼ƒè¿™ä¸ªåŒ…ã€‚</p>
]]></content>
      <categories>
        <category>network</category>
      </categories>
      <tags>
        <tag>network</tag>
      </tags>
  </entry>
  <entry>
    <title>Nginxç®€ä»‹</title>
    <url>/posts/cc1b6e67.html</url>
    <content><![CDATA[<h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><ul>
<li>åå‘ä»£ç†</li>
<li>è´Ÿè½½å‡è¡¡</li>
<li>åŠ¨é™åˆ†ç¦»</li>
</ul>
<h2 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo yum install nginx</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo systemctl start nginx.service</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> è®¿é—®æˆåŠŸ</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> curl localhost:80</span></span><br></pre></td></tr></table></figure>
<p><strong>æµ‹è¯•å®‰è£…æˆåŠŸ</strong></p>
<p>å› ä¸ºæˆ‘çš„æµ‹è¯•ç¯å¢ƒæ˜¯vagrant vmï¼Œæ‰€ä»¥éœ€è¦åšä¸€ä¸ªç«¯å£æ˜ å°„ï¼Œè¿™æ ·æˆ‘ä»¬å¯ä»¥åœ¨hostä¸Šè®¿é—®ã€‚</p>
<img src="/posts/cc1b6e67/image-20210201230936553.png" alt="image-20210201230936553" style="zoom:50%;">

<p>æˆåŠŸï¼</p>
<img src="/posts/cc1b6e67/image-20210201231043622.png" alt="image-20210201231043622" style="zoom:50%;">

<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> nginx -h</span></span><br><span class="line">nginx version: nginx/1.14.1</span><br><span class="line">Usage: nginx [-?hvVtTq] [-s signal] [-c filename] [-p prefix] [-g directives]</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">...</span><br><span class="line">  -s signal     : send signal to a master process: stop, quit, reopen, reload</span><br><span class="line">  -p prefix     : set prefix path (default: /usr/share/nginx/)</span><br><span class="line">  -c filename   : set configuration file (default: /etc/nginx/nginx.conf)</span><br><span class="line">  -g directives : set global directives out of configuration file</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> nginx -s stop åœæ­¢</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> nginx -s quit å®‰å…¨é€€å‡º</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> nginx -s reload é‡æ–°åŠ è½½é…ç½®æ–‡ä»¶</span></span><br></pre></td></tr></table></figure>
<h3 id="nginxé…ç½®æ–‡ä»¶"><a href="#nginxé…ç½®æ–‡ä»¶" class="headerlink" title="nginxé…ç½®æ–‡ä»¶"></a>nginxé…ç½®æ–‡ä»¶</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> vim /etc/nginx/nginx.conf</span></span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°nginx serveræ˜¯ç›‘å¬åœ¨80ç«¯å£çš„ï¼Œæˆ‘ä»¬å¯ä»¥ä¿®æ”¹ç«¯å£ï¼Œç„¶åç”¨<code>nginx -s reload</code>æ¥ç”Ÿæ•ˆã€‚</p>
<img src="/posts/cc1b6e67/image-20210201231634344.png" alt="image-20210201231634344" style="zoom:50%;">



<h3 id="è¯¦è§£nginx-conf"><a href="#è¯¦è§£nginx-conf" class="headerlink" title="è¯¦è§£nginx.conf"></a>è¯¦è§£nginx.conf</h3><p> ä¸‰éƒ¨åˆ†</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">user  www;# å·¥ä½œè¿›ç¨‹çš„å±ä¸»</span><br><span class="line"> worker_processes  4;# å·¥ä½œè¿›ç¨‹æ•°ï¼Œä¸€èˆ¬ä¸ CPU æ ¸æ•°ç­‰åŒ</span><br><span class="line"> </span><br><span class="line"><span class="meta"> #</span><span class="bash">error_log  logs/error.log;</span></span><br><span class="line"><span class="meta"> #</span><span class="bash">error_log  logs/error.log  notice;</span></span><br><span class="line"><span class="meta"> #</span><span class="bash">error_log  logs/error.log  info;</span></span><br><span class="line"> </span><br><span class="line"><span class="meta"> #</span><span class="bash">pid        logs/nginx.pid;</span></span><br><span class="line"> </span><br><span class="line"> events &#123;</span><br><span class="line">    use epoll;#Linux ä¸‹æ€§èƒ½æœ€å¥½çš„ event æ¨¡å¼</span><br><span class="line">    worker_connections  2048;# æ¯ä¸ªå·¥ä½œè¿›ç¨‹å…è®¸æœ€å¤§çš„åŒæ—¶è¿æ¥æ•°</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> http &#123;</span><br><span class="line">		upstream xxx&#123;</span><br><span class="line">				server1:port1</span><br><span class="line">				server2:port3</span><br><span class="line">		&#125; </span><br><span class="line">		</span><br><span class="line">		server &#123;</span><br><span class="line">				location / &#123;</span><br><span class="line">						proxy_pass xxx</span><br><span class="line">				&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p><a href="https://www.cnblogs.com/fengzhongzhuzu/p/8848115.html">https://www.cnblogs.com/fengzhongzhuzu/p/8848115.html</a></p>
<h3 id="Nginxçš„è´Ÿè½½å‡è¡¡è°ƒåº¦ç®—æ³•"><a href="#Nginxçš„è´Ÿè½½å‡è¡¡è°ƒåº¦ç®—æ³•" class="headerlink" title="Nginxçš„è´Ÿè½½å‡è¡¡è°ƒåº¦ç®—æ³•"></a>Nginxçš„è´Ÿè½½å‡è¡¡è°ƒåº¦ç®—æ³•</h3><h4 id="weightè½®è¯¢-é»˜è®¤ï¼Œå¸¸ç”¨"><a href="#weightè½®è¯¢-é»˜è®¤ï¼Œå¸¸ç”¨" class="headerlink" title="weightè½®è¯¢(é»˜è®¤ï¼Œå¸¸ç”¨)"></a>weightè½®è¯¢(é»˜è®¤ï¼Œå¸¸ç”¨)</h4><p>æ”¶åˆ°çš„è¯·æ±‚<strong>æŒ‰ç…§æƒé‡åˆ†é…</strong>åˆ°ä¸åŒçš„åç«¯æœåŠ¡å™¨ï¼Œå³ä½¿åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼ŒæŸä¸€å°åç«¯æœåŠ¡å™¨å®•æœºï¼ŒNginxä¼šè‡ªåŠ¨å°†è¯¥æœåŠ¡å™¨å‰”é™¤å‡ºé˜Ÿåˆ—ï¼Œè¯·æ±‚å—ç†æƒ…å†µä¸ä¼šå—åˆ°ä»»ä½•å½±å“ã€‚è¿™ç§æ–¹å¼ä¸‹ï¼Œå¯ä»¥ç»™ä¸åŒçš„åç«¯æœåŠ¡å™¨è®¾ç½®ä¸€ä¸ªæƒé‡å€¼(weight)ï¼Œç”¨äºè°ƒæ•´ä¸åŒçš„æœåŠ¡å™¨ä¸Šè¯·æ±‚çš„åˆ†é…ç‡ï¼›æƒé‡æ•°æ®è¶Šå¤§ï¼Œè¢«åˆ†é…åˆ°è¯·æ±‚çš„å‡ ç‡è¶Šå¤§ï¼›è¯¥æƒé‡å€¼ï¼Œä¸»è¦æ˜¯é’ˆå¯¹å®é™…å·¥ä½œç¯å¢ƒä¸­ä¸åŒçš„åç«¯æœåŠ¡å™¨ç¡¬ä»¶é…ç½®è¿›è¡Œè°ƒæ•´çš„ã€‚</p>
<h4 id="ip-hashï¼ˆå¸¸ç”¨ï¼‰"><a href="#ip-hashï¼ˆå¸¸ç”¨ï¼‰" class="headerlink" title="ip_hashï¼ˆå¸¸ç”¨ï¼‰"></a>ip_hashï¼ˆå¸¸ç”¨ï¼‰</h4><p>æ¯ä¸ªè¯·æ±‚æŒ‰ç…§å‘èµ·å®¢æˆ·ç«¯çš„ipçš„hashç»“æœè¿›è¡ŒåŒ¹é…ï¼Œè¿™æ ·çš„ç®—æ³•ä¸‹ä¸€ä¸ªå›ºå®šipåœ°å€çš„å®¢æˆ·ç«¯æ€»ä¼šè®¿é—®åˆ°åŒä¸€ä¸ªåç«¯æœåŠ¡å™¨ï¼Œè¿™ä¹Ÿåœ¨ä¸€å®šç¨‹åº¦ä¸Šè§£å†³äº†é›†ç¾¤éƒ¨ç½²ç¯å¢ƒä¸‹<strong>sessionå…±äº«çš„</strong>é—®é¢˜ã€‚</p>
<h4 id="fairæ™ºèƒ½è°ƒæ•´è°ƒåº¦ç®—æ³•"><a href="#fairæ™ºèƒ½è°ƒæ•´è°ƒåº¦ç®—æ³•" class="headerlink" title="fairæ™ºèƒ½è°ƒæ•´è°ƒåº¦ç®—æ³•"></a>fairæ™ºèƒ½è°ƒæ•´è°ƒåº¦ç®—æ³•</h4><p>åŠ¨æ€çš„æ ¹æ®åç«¯æœåŠ¡å™¨çš„è¯·æ±‚å¤„ç†åˆ°å“åº”çš„æ—¶é—´è¿›è¡Œå‡è¡¡åˆ†é…ï¼Œå“åº”æ—¶é—´çŸ­å¤„ç†æ•ˆç‡é«˜çš„æœåŠ¡å™¨åˆ†é…åˆ°è¯·æ±‚çš„æ¦‚ç‡é«˜ï¼Œå“åº”æ—¶é—´é•¿å¤„ç†æ•ˆç‡ä½çš„æœåŠ¡å™¨åˆ†é…åˆ°çš„è¯·æ±‚å°‘ï¼›ç»“åˆäº†å‰ä¸¤è€…çš„ä¼˜ç‚¹çš„ä¸€ç§è°ƒåº¦ç®—æ³•ã€‚ä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯Nginxé»˜è®¤ä¸æ”¯æŒfairç®—æ³•ï¼Œå¦‚æœè¦ä½¿ç”¨è¿™ç§è°ƒåº¦ç®—æ³•ï¼Œè¯·å®‰è£…upstream_fairæ¨¡å—ã€‚</p>
<h4 id="url-hash"><a href="#url-hash" class="headerlink" title="url_hash"></a>url_hash</h4><p>æŒ‰ç…§è®¿é—®çš„urlçš„hashç»“æœåˆ†é…è¯·æ±‚ï¼Œæ¯ä¸ªè¯·æ±‚çš„urlä¼šæŒ‡å‘åç«¯å›ºå®šçš„æŸä¸ªæœåŠ¡å™¨ï¼Œå¯ä»¥åœ¨Nginxä½œä¸ºé™æ€æœåŠ¡å™¨çš„æƒ…å†µä¸‹æé«˜ç¼“å­˜æ•ˆç‡ã€‚åŒæ ·è¦æ³¨æ„Nginxé»˜è®¤ä¸æ”¯æŒè¿™ç§è°ƒåº¦ç®—æ³•ï¼Œè¦ä½¿ç”¨çš„è¯éœ€è¦å®‰è£…Nginxçš„hashè½¯ä»¶åŒ…ã€‚</p>
]]></content>
  </entry>
  <entry>
    <title>è¿›ç¨‹å’Œçº¿ç¨‹</title>
    <url>/posts/6ac22eb.html</url>
    <content><![CDATA[<img src="/posts/6ac22eb/image-20210225180738908.png" alt="image-20210225180738908" style="zoom:67%;">

<blockquote>
<p>å‚è€ƒï¼š<a href="https://cloud.tencent.com/developer/article/1688297">https://cloud.tencent.com/developer/article/1688297</a></p>
</blockquote>
<h2 id="ç®€å•çš„ç†è§£"><a href="#ç®€å•çš„ç†è§£" class="headerlink" title="ç®€å•çš„ç†è§£"></a>ç®€å•çš„ç†è§£</h2><p>å¯¹äºæ“ä½œç³»ç»Ÿæ¥è¯´ï¼Œä¸€ä¸ªä»»åŠ¡å°±æ˜¯ä¸€ä¸ªè¿›ç¨‹ï¼ˆ<strong>Process</strong>ï¼‰ï¼Œæ¯”å¦‚æ‰“å¼€ä¸€ä¸ªæµè§ˆå™¨å°±æ˜¯å¯åŠ¨ä¸€ä¸ªæµè§ˆå™¨è¿›ç¨‹ï¼Œæ‰“å¼€ä¸€ä¸ªè®°äº‹æœ¬å°±å¯åŠ¨äº†ä¸€ä¸ªè®°äº‹æœ¬è¿›ç¨‹ï¼Œæ‰“å¼€ä¸¤ä¸ªè®°äº‹æœ¬å°±å¯åŠ¨äº†ä¸¤ä¸ªè®°äº‹æœ¬è¿›ç¨‹ï¼Œæ‰“å¼€ä¸€ä¸ªWordå°±å¯åŠ¨äº†ä¸€ä¸ªWordè¿›ç¨‹ã€‚</p>
<p>æœ‰äº›è¿›ç¨‹è¿˜ä¸æ­¢åŒæ—¶å¹²ä¸€ä»¶äº‹ï¼Œæ¯”å¦‚Wordï¼Œå®ƒå¯ä»¥åŒæ—¶è¿›è¡Œæ‰“å­—ã€æ‹¼å†™æ£€æŸ¥ã€æ‰“å°ç­‰äº‹æƒ…ã€‚åœ¨ä¸€ä¸ªè¿›ç¨‹å†…éƒ¨ï¼Œè¦åŒæ—¶å¹²å¤šä»¶äº‹ï¼Œå°±éœ€è¦åŒæ—¶è¿è¡Œå¤šä¸ªâ€œå­ä»»åŠ¡â€ï¼Œæˆ‘ä»¬æŠŠè¿›ç¨‹å†…çš„è¿™äº›â€œå­ä»»åŠ¡â€ç§°ä¸ºçº¿ç¨‹ï¼ˆ<strong>Thread</strong>ï¼‰ã€‚</p>
<h2 id="å¹¶è¡Œå’Œå¹¶å‘"><a href="#å¹¶è¡Œå’Œå¹¶å‘" class="headerlink" title="å¹¶è¡Œå’Œå¹¶å‘"></a>å¹¶è¡Œå’Œå¹¶å‘</h2><p>å¹¶è¡Œæ˜¯çœŸæ­£çš„åŒæ—¶è¿è¡Œï¼Œéœ€è¦å¤šæ ¸ã€‚</p>
<p>å¹¶å‘åªæ˜¯çœ‹èµ·æ¥åŒæ—¶è¿è¡Œï¼Œæœ€å¸¸è§çš„å°±æ˜¯<strong>æ—¶é—´ç‰‡è½®è½¬è°ƒåº¦ç®—æ³•</strong>ã€‚</p>
<h2 id="è¿›ç¨‹å’Œçº¿ç¨‹çš„åŒºåˆ«"><a href="#è¿›ç¨‹å’Œçº¿ç¨‹çš„åŒºåˆ«" class="headerlink" title="è¿›ç¨‹å’Œçº¿ç¨‹çš„åŒºåˆ«"></a>è¿›ç¨‹å’Œçº¿ç¨‹çš„åŒºåˆ«</h2><p><strong>å…±äº«åŒä¸€åœ°å€ç©ºé—´</strong>ï¼ˆä¹Ÿå°±æ˜¯åŒæ ·çš„<strong>åŠ¨æ€å†…å­˜ï¼Œæ˜ å°„æ–‡ä»¶ï¼Œç›®æ ‡ä»£ç ç­‰ç­‰</strong>ï¼‰ï¼Œ<strong>æ‰“å¼€çš„æ–‡ä»¶é˜Ÿåˆ—å’Œå…¶ä»–å†…æ ¸èµ„æº</strong>ã€‚</p>
<h5 id><a href="#" class="headerlink" title></a></h5><table>
<thead>
<tr>
<th align="center">è¿›ç¨‹</th>
<th align="center">çº¿ç¨‹</th>
</tr>
</thead>
<tbody><tr>
<td align="center">æœ‰ç‹¬ç«‹çš„åœ°å€ç©ºé—´</td>
<td align="center">æœ‰è‡ªå·±çš„æ ˆå’Œå±€éƒ¨å˜é‡ï¼Œä½†æ²¡æœ‰å•ç‹¬çš„åœ°å€ç©ºé—´ã€‚<br>åŒä¸€è¿›ç¨‹ä¸­çš„å¤šä¸ªçº¿ç¨‹å…±äº«ä»£ç æ®µï¼ˆä»£ç å’Œå¸¸é‡ï¼‰ï¼Œæ•°æ®æ®µï¼ˆå…¨å±€å˜é‡å’Œé™æ€å˜é‡ï¼‰ï¼Œæ‰©å±•æ®µï¼ˆå †å­˜å‚¨ï¼‰ã€‚<br>ä½†æ˜¯æ¯ä¸ªçº¿ç¨‹æ‹¥æœ‰è‡ªå·±çš„æ ˆæ®µï¼Œæ ˆæ®µåˆå«è¿è¡Œæ—¶æ®µï¼Œç”¨æ¥å­˜æ”¾æ‰€æœ‰å±€éƒ¨å˜é‡å’Œä¸´æ—¶å˜é‡ã€‚ï¼‰</td>
</tr>
<tr>
<td align="center">åœ¨ä¿æŠ¤æ¨¡å¼ä¸‹ä¸ä¼šå¯¹å…¶å®ƒè¿›ç¨‹äº§ç”Ÿå½±å“</td>
<td align="center">ä¸€ä¸ªçº¿ç¨‹æ­»æ‰å°±ç­‰äºæ•´ä¸ªè¿›ç¨‹æ­»æ‰</td>
</tr>
<tr>
<td align="center">æ‹¥æœ‰ç‹¬ç«‹çš„å†…å­˜å•å…ƒ</td>
<td align="center">å…±äº«è¿›ç¨‹çš„å†…å­˜</td>
</tr>
<tr>
<td align="center">ç®¡é“ã€ç³»ç»ŸIPCï¼ˆåŒ…æ‹¬<a href="https://cloud.tencent.com/product/cmq?from=10680">æ¶ˆæ¯é˜Ÿåˆ—</a>ã€ä¿¡å·é‡ã€ä¿¡å·ã€å…±äº«å†…å­˜ç­‰ï¼‰ã€ä»¥åŠå¥—æ¥å­—socket</td>
<td align="center">å¯ä»¥ç›´æ¥è¯»å†™è¿›ç¨‹æ•°æ®æ®µå’Œå…¨å±€å˜é‡ï¼ˆäº’æ–¥é”ï¼Œä¿¡å·é‡ï¼‰</td>
</tr>
<tr>
<td align="center">ä¸Šä¸‹æ–‡åˆ‡æ¢æ…¢</td>
<td align="center">è¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢å¿«</td>
</tr>
<tr>
<td align="center"><strong>è¿›ç¨‹æ˜¯æ“ä½œç³»ç»Ÿåˆ†é…èµ„æºçš„å•ä½</strong></td>
<td align="center"><strong>æ˜¯CPUè°ƒåº¦å’Œåˆ†æ´¾æ‰§è¡Œçš„åŸºæœ¬å•ä½</strong></td>
</tr>
<tr>
<td align="center">è¿›ç¨‹ç¼–ç¨‹è°ƒè¯•ç®€å•å¯é æ€§é«˜ï¼Œä½†æ˜¯åˆ›å»ºé”€æ¯å¼€é”€å¤§</td>
<td align="center">çº¿ç¨‹æ­£ç›¸åï¼Œå¼€é”€å°ï¼Œåˆ‡æ¢é€Ÿåº¦å¿«ï¼Œä½†æ˜¯ç¼–ç¨‹è°ƒè¯•ç›¸å¯¹å¤æ‚</td>
</tr>
</tbody></table>
<p>åˆ›å»ºçº¿ç¨‹çš„ä»£ä»·æ¯”åˆ›å»ºè¿›ç¨‹çš„ä»£ä»·å°å¾ˆå¤šï¼Œå¦‚ä¸‹å›¾ï¼š</p>
<p><img src="/posts/6ac22eb/image-20210225181636565.png" alt="image-20210225181636565"></p>
]]></content>
      <categories>
        <category>linux</category>
      </categories>
  </entry>
  <entry>
    <title>ä»£ç†æœåŠ¡å™¨åŸºæœ¬ä»‹ç»</title>
    <url>/posts/65bbead6.html</url>
    <content><![CDATA[<h2 id="ä¸ºä»€ä¹ˆéœ€è¦proxy-server"><a href="#ä¸ºä»€ä¹ˆéœ€è¦proxy-server" class="headerlink" title="ä¸ºä»€ä¹ˆéœ€è¦proxy server?"></a>ä¸ºä»€ä¹ˆéœ€è¦proxy server?</h2><ol>
<li><p>ç›‘æ§ï¼Œå†…å®¹è¿‡æ»¤</p>
<ul>
<li>å…¬å¸çš„proxy serverå¯ä»¥æ¸…æ¥šçš„çŸ¥é“ï¼Œä½ çš„æµé‡è¦è®¿é—®ä»€ä¹ˆç½‘ç«™ã€‚proxy serverå¯ä»¥ç¦æ‰ä¸€äº›ç½‘å€ï¼Œæˆ–è€…redirectåˆ°ä¸€äº›æç¤ºé¡µé¢ã€‚</li>
<li>å…¬å¸çš„proxy serverå¯ä»¥ç›‘æ§ä½ æ¯å¤©éƒ½åœ¨è®¿é—®ä»€ä¹ˆç½‘ç«™ï¼ŒèŠ±äº†å¤šé•¿æ—¶é—´ã€‚</li>
</ul>
</li>
<li><p>èŠ‚çº¦å¸¦å®½ï¼ŒèŠ‚çœæˆæœ¬</p>
<ul>
<li>åœ¨proxy serverä¸Šä¼šæœ‰ä¸€äº›cacheï¼Œé‡Œé¢å­˜æ”¾äº†æœ€è¿‘è®¿é—®çš„websiteçš„æ•°æ®ï¼Œå¦‚æœæœ‰1000ä¸ªrequesté€šè¿‡åŒä¸€ä¸ªproxy serverè®¿é—®website Aï¼Œè¿™æ—¶å¦‚æœproxy serverä¸Šæœ‰website Açš„æœ€æ–°æ•°æ®åœ¨cacheé‡Œï¼Œå°±å¯ä»¥ç›´æ¥è¿”å›ç»™è¿™1000ä¸ªclientã€‚å¦‚æœproxy serverä¸Šæ²¡æœ‰ï¼Œä¹Ÿåªéœ€è¦å‘ä¸€ä¸ªwebsite Açš„è¯·æ±‚ï¼Œç„¶åæŠŠè¿”å›æ•°æ®æ”¾åœ¨cacheé‡Œã€‚</li>
</ul>
</li>
<li><p>æé«˜æ€§èƒ½</p>
<ul>
<li>é€šè¿‡ä»£ç†æœåŠ¡å™¨çš„ç¼“å­˜ï¼ˆæ¯”å¦‚ CDNï¼‰å’Œè´Ÿè½½å‡è¡¡ï¼ˆæ¯”å¦‚ nginx lbï¼‰åŠŸèƒ½ï¼ŒæœåŠ¡å™¨ç«¯å¯ä»¥åŠ é€Ÿè¯·æ±‚çš„è®¿é—®ï¼Œåœ¨æ›´å¿«çš„æ—¶é—´å†…è¿”å›ç»“æœï¼‰</li>
</ul>
</li>
<li><p>å®‰å…¨å’Œéšç§</p>
<ul>
<li><p>æœ‰ä¸€äº›proxy serverå¯ä»¥éšè—æ‰clientçš„IPç­‰ä¸ªäººä¿¡æ¯ï¼Œè¿™æ ·é€šè¿‡proxyè®¿é—®ç½‘ç«™ï¼Œweb serverå¹¶ä¸èƒ½çŸ¥é“æ˜¯è°åœ¨çœŸæ­£çš„è®¿é—®å®ƒã€‚</p>
</li>
<li><p>å…¬å¸å¯ä»¥åœ¨å†…ç½‘å’Œå¤–ç½‘ä¹‹é—´é€šè¿‡ä»£ç†è¿›è¡Œè½¬å‘ï¼Œè¿™æ ·ä¸ä»…å¯¹å¤–éšè—äº†å®ç°çš„ç»†èŠ‚ï¼Œè€Œä¸”å¯ä»¥åœ¨ä»£ç†å±‚å¯¹çˆ¬è™«ã€ç—…æ¯’æ€§è¯·æ±‚è¿›è¡Œè¿‡æ»¤ï¼Œä¿æŠ¤å†…éƒ¨æœåŠ¡ã€‚</p>
</li>
<li><p>è¿˜å¯ä»¥åŠ å¯†æ•°æ®</p>
</li>
</ul>
</li>
</ol>
<blockquote>
<p>é£é™©ï¼š</p>
<p>å› ä¸ºæ‰€æœ‰clientçš„è¯·æ±‚éƒ½è¦é€šè¿‡proxy serverè®¿é—®internetï¼Œæ‰€ä»¥æœ‰æ•°æ®æ³„éœ²çš„é£é™©ã€‚ä¹Ÿæœ‰ä¸€äº›æŠ€æœ¯å¯ä»¥å®ç°æ•°æ®åŠ å¯†ï¼Œè§„é¿è¿™ç§riskï¼Œåé¢ä¼šè®²åˆ°ã€‚</p>
</blockquote>
<h2 id="ä»£ç†æœåŠ¡å™¨çš„åˆ†ç±»ï¼š"><a href="#ä»£ç†æœåŠ¡å™¨çš„åˆ†ç±»ï¼š" class="headerlink" title="ä»£ç†æœåŠ¡å™¨çš„åˆ†ç±»ï¼š"></a>ä»£ç†æœåŠ¡å™¨çš„åˆ†ç±»ï¼š</h2><ol>
<li><h4 id="æŒ‰ç…§åŒ¿ååŠŸèƒ½åˆ†ç±»ï¼ˆæ˜¯å¦å…·æœ‰éšè—IPçš„åŠŸèƒ½ï¼‰"><a href="#æŒ‰ç…§åŒ¿ååŠŸèƒ½åˆ†ç±»ï¼ˆæ˜¯å¦å…·æœ‰éšè—IPçš„åŠŸèƒ½ï¼‰" class="headerlink" title="æŒ‰ç…§åŒ¿ååŠŸèƒ½åˆ†ç±»ï¼ˆæ˜¯å¦å…·æœ‰éšè—IPçš„åŠŸèƒ½ï¼‰"></a>æŒ‰ç…§åŒ¿ååŠŸèƒ½åˆ†ç±»ï¼ˆæ˜¯å¦å…·æœ‰éšè—IPçš„åŠŸèƒ½ï¼‰</h4><ul>
<li><p>éåŒ¿åï¼ˆå’Œé€æ˜ä»£ç†çš„åŒºåˆ«ï¼Ÿï¼Ÿï¼Ÿï¼‰</p>
</li>
<li><p>åŒ¿åï¼šä½¿ç”¨æ­¤ç§ä»£ç†æ—¶ï¼Œè™½ç„¶è¢«è®¿é—®çš„ç½‘ç«™ä¸èƒ½çŸ¥é“ä½ çš„ IP åœ°å€ï¼Œä½†ä»ç„¶å¯ ä»¥çŸ¥é“ä½ åœ¨ä½¿ç”¨ä»£ç†ï¼Œæœ‰äº›ä¾¦æµ‹ IP çš„ç½‘é¡µä¹Ÿä»ç„¶å¯ä»¥æŸ¥åˆ°ä½ çš„ IPã€‚</p>
</li>
<li><p>é«˜åº¦åŒ¿åï¼šä½¿ç”¨æ­¤ç§ä»£ç†æ—¶ï¼Œè¢«è®¿é—®çš„ç½‘ç«™ä¸çŸ¥é“ä½ çš„ IP åœ°å€ï¼Œä¹Ÿä¸çŸ¥é“ä½ åœ¨ä½¿ç”¨ä»£ç†è¿›è¡Œè®¿é—®ã€‚æ­¤ç§ä»£ç†çš„éšè— IP åœ°å€çš„åŠŸèƒ½æœ€å¼ºã€‚</p>
</li>
<li><p>é€æ˜ä»£ç†ï¼ˆç®€å•ä»£ç†ï¼‰ï¼šé€æ˜ä»£ç†çš„æ„æ€æ˜¯å®¢æˆ·ç«¯æ ¹æœ¬ä¸éœ€è¦çŸ¥é“æœ‰ä»£ç†æœåŠ¡å™¨çš„å­˜åœ¨ï¼Œå®ƒæ”¹ç¼–ä½ çš„ request fieldsï¼ˆæŠ¥æ–‡ï¼‰ï¼Œå¹¶ä¼šä¼ é€çœŸå® IPã€‚web serverä¼šç›´æ¥è·å¾—clientçš„IPï¼Œå¹¶ä¸”çŸ¥é“clientæ˜¯é€šè¿‡proxyè®¿é—®çš„å®ƒã€‚</p>
</li>
</ul>
</li>
<li><h4 id="æŒ‰ä»£ç†æœåŠ¡å™¨çš„ç”¨é€”åˆ†ç±»"><a href="#æŒ‰ä»£ç†æœåŠ¡å™¨çš„ç”¨é€”åˆ†ç±»" class="headerlink" title="æŒ‰ä»£ç†æœåŠ¡å™¨çš„ç”¨é€”åˆ†ç±»"></a>æŒ‰ä»£ç†æœåŠ¡å™¨çš„ç”¨é€”åˆ†ç±»</h4><ul>
<li>HTTPä»£ç†</li>
<li>SSLä»£ç†</li>
<li>HTTP CONNECTä»£ç†</li>
<li>FTPä»£ç†</li>
<li>POP3ä»£ç†</li>
<li>Telnetä»£ç†</li>
<li>Socksä»£ç†</li>
<li>ç­‰ç­‰ç­‰ç­‰</li>
</ul>
</li>
<li><h4 id="æŒ‰ç…§ç›¸å¯¹äºclient-serverçš„è§’è‰²åˆ†ç±»"><a href="#æŒ‰ç…§ç›¸å¯¹äºclient-serverçš„è§’è‰²åˆ†ç±»" class="headerlink" title="æŒ‰ç…§ç›¸å¯¹äºclient-serverçš„è§’è‰²åˆ†ç±»"></a>æŒ‰ç…§ç›¸å¯¹äºclient-serverçš„è§’è‰²åˆ†ç±»</h4><h5 id="æ­£å‘ä»£ç†"><a href="#æ­£å‘ä»£ç†" class="headerlink" title="æ­£å‘ä»£ç†"></a>æ­£å‘ä»£ç†</h5><p>ä»£ç†å¯¹å®¢æˆ·ç«¯ä¸æ˜¯é€æ˜çš„ï¼Œå®¢æˆ·ç«¯éœ€è¦çŸ¥é“ä»£ç†çš„åœ°å€å¹¶ä¸”æ‰‹åŠ¨é…ç½®ã€‚é…ç½®äº†ä»£ç†ï¼Œæµè§ˆå™¨åœ¨å‘é€è¯·æ±‚çš„æ—¶å€™ä¼šå¯¹æŠ¥æ–‡åšç‰¹æ®Šçš„ä¿®æ”¹ã€‚</p>
<h5 id="åå‘ä»£ç†"><a href="#åå‘ä»£ç†" class="headerlink" title="åå‘ä»£ç†"></a>åå‘ä»£ç†</h5><p>è¯´å®¢æˆ·ç«¯ä¸€èˆ¬ä¸çŸ¥é“ä»£ç†çš„å­˜åœ¨ï¼Œè®¤ä¸ºè‡ªå·±æ˜¯ç›´æ¥å’ŒæœåŠ¡å™¨é€šä¿¡ã€‚æˆ‘ä»¬å¤§éƒ¨åˆ†è®¿é—®çš„ç½‘ç«™å°±æ˜¯åå‘ä»£ç†æœåŠ¡å™¨ï¼Œåå‘ä»£ç†æœåŠ¡å™¨ä¼šè½¬å‘åˆ°çœŸæ­£çš„æœåŠ¡å™¨ï¼Œä¸€èˆ¬åœ¨åå‘ä»£ç†è¿™ä¸€å±‚å®ç°<strong>è´Ÿè½½å‡è¡¡</strong>å’Œ<strong>é«˜å¯ç”¨</strong>çš„åŠŸèƒ½ã€‚è€Œä¸”è¿™é‡Œä¹Ÿå¯ä»¥çœ‹åˆ°ï¼Œå®¢æˆ·ç«¯æ˜¯ä¸ä¼šçŸ¥é“çœŸæ­£æœåŠ¡å™¨ç«¯çš„ ip åœ°å€å’Œç«¯å£çš„ï¼Œè¿™åœ¨ä¸€å®šç¨‹åº¦ä¸Šèµ·åˆ°äº†å®‰å…¨ä¿æŠ¤çš„ä½œç”¨ã€‚</p>
<img src="/posts/65bbead6/image-20210129182705751.png" alt="image-20210129182705751" style="zoom:60%;"></li>
</ol>
<h2 id="ä»£ç†å…·ä½“åšä»€ä¹ˆï¼Ÿ"><a href="#ä»£ç†å…·ä½“åšä»€ä¹ˆï¼Ÿ" class="headerlink" title="ä»£ç†å…·ä½“åšä»€ä¹ˆï¼Ÿ"></a>ä»£ç†å…·ä½“åšä»€ä¹ˆï¼Ÿ</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">- ä¿®æ”¹ HTTP è¯·æ±‚ï¼šurlã€headerã€body  </span><br><span class="line">- è¿‡æ»¤è¯·æ±‚ï¼šæ ¹æ®ä¸€å®šçš„è§„åˆ™ä¸¢å¼ƒã€è¿‡æ»¤è¯·æ±‚ </span><br><span class="line">- å†³å®šè½¬å‘åˆ°å“ªä¸ªåç«¯ï¼ˆå¯ä»¥æ˜¯é™æ€å®šä¹‰çš„ï¼Œä¹Ÿå¯ä»¥æ˜¯åŠ¨æ€å†³å®šï¼‰ #nginx etc.</span><br><span class="line">- ä¿å­˜æœåŠ¡å™¨çš„åº”ç­”ï¼Œåç»­çš„è¯·æ±‚å¯ä»¥ç›´æ¥ä½¿ç”¨ä¿å­˜çš„åº”ç­” # cache on proxy server</span><br><span class="line">- ä¿®æ”¹åº”ç­”ï¼šå¯¹åº”ç­”åšä¸€äº›æ ¼å¼çš„è½¬æ¢ï¼Œä¿®æ”¹æ•°æ®ï¼Œç”šè‡³è¿”å›å®Œå…¨ä¸ä¸€æ ·çš„åº”ç­”æ•°æ®  #security issue?</span><br><span class="line">- é‡è¯•æœºåˆ¶ï¼Œå¦‚æœåç«¯æœåŠ¡å™¨æš‚æ—¶æ— æ³•å“åº”ï¼Œéš”ä¸€æ®µæ—¶é—´é‡è¯•</span><br><span class="line">- â€¦â€¦</span><br></pre></td></tr></table></figure>



<p>æ™®é€šä»£ç†</p>
<p>éš§é“ä»£ç†</p>
<h2 id="ä»£ç†å’Œç½‘å…³çš„åŒºåˆ«"><a href="#ä»£ç†å’Œç½‘å…³çš„åŒºåˆ«" class="headerlink" title="ä»£ç†å’Œç½‘å…³çš„åŒºåˆ«"></a>ä»£ç†å’Œç½‘å…³çš„åŒºåˆ«</h2>]]></content>
      <categories>
        <category>network</category>
      </categories>
      <tags>
        <tag>proxy</tag>
      </tags>
  </entry>
  <entry>
    <title>containerPort, targetPort, port, nodePortç­‰çš„åŒºåˆ«</title>
    <url>/posts/3836ec52.html</url>
    <content><![CDATA[<p>æœ¬æ–‡ä¼šé€šè¿‡containerä¸­çš„åº”ç”¨çš„å‡ ç§è®¿é—®æ–¹å¼æ¥è§£é‡ŠcontainerPort, targetPort, port, nodePortçš„å…³ç³»å’ŒåŒºåˆ«ã€‚</p>
<h2 id="containerPort"><a href="#containerPort" class="headerlink" title="containerPort"></a>containerPort</h2><p>å®¹å™¨æš´éœ²çš„ç«¯å£ï¼Œåœ¨container specé‡Œå£°æ˜ã€‚</p>
<img src="/posts/3836ec52/image-20210308182307042.png" alt="image-20210308182307042" style="zoom:50%;">

<p>å¯ä»¥é€šè¿‡podIP:containerPortæ¥è®¿é—®å®¹å™¨å†…åº”ç”¨ã€‚</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> k get pod -owide</span></span><br><span class="line">NAME    READY   STATUS    RESTARTS   AGE    IP                  NODE  </span><br><span class="line">pod1    2/2     Running   0          133m   192.168.227.89   otcloud-node1   </span><br><span class="line">pod2    2/2     Running   0          47m    192.168.227.97   otcloud-node1   </span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">å¯ä»¥è®¿é—®å®¹å™¨å†…åº”ç”¨</span></span><br><span class="line">curl 192.168.227.97:9080</span><br></pre></td></tr></table></figure>
<p><strong>Notesï¼š</strong></p>
<p>å¦‚æœä¸€ä¸ªpodé‡Œå£°æ˜äº†å¤šä¸ªå®¹å™¨ï¼Œé‚£ä¹ˆæ¯ä¸ªå®¹å™¨æš´éœ²çš„ç«¯å£å¿…é¡»ä¸åŒï¼Œå¦åˆ™å®¹å™¨å¯åŠ¨ä¼šå¤±è´¥ã€‚ï¼ˆAddress already in useï¼‰</p>
<p><strong>æ›´è¿›ä¸€æ­¥</strong>ï¼Œå› ä¸ºä¸€ä¸ªpodé‡Œçš„æ‰€æœ‰å®¹å™¨éƒ½å…±äº«ç½‘ç»œnamespaceï¼Œæ‰€ä»¥å®ƒä»¬å…±äº«IPï¼Œå’Œç«¯å£ã€‚</p>
<h2 id="targetPort"><a href="#targetPort" class="headerlink" title="targetPort"></a>targetPort</h2><p>æ˜¯<strong>Service</strong>èµ„æºé‡Œçš„ä¸€ä¸ªæ¦‚å¿µï¼Œåœ¨serviceçš„å£°æ˜ä¸­ä½¿ç”¨ã€‚</p>
<p>targetPortæ˜¯Podä¸Šçš„ç«¯å£ï¼Œä»port/nodePortä¸Šæ¥çš„æ•°æ®ï¼Œç»è¿‡kube-proxyæµå…¥åˆ°åç«¯podçš„targetPortä¸Šï¼Œæœ€åè¿›å…¥å®¹å™¨ã€‚</p>
<p>å¦‚æœä¸æŒ‡æ˜targetPortï¼Œé»˜è®¤targetPortå’Œserviceæš´éœ²çš„portä¸€è‡´ã€‚</p>
<p>ä¸‹é¢æ˜¯ä¸€ä¸ªserviceçš„å£°æ˜ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">productpage</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">productpage</span></span><br><span class="line">    <span class="attr">service:</span> <span class="string">productpage</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">9999</span>  <span class="comment"># clusterip:port </span></span><br><span class="line">    <span class="comment"># targetPort: 9080 # å¦‚æœä¸å†™ï¼Œé»˜è®¤æ˜¯9999</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">productpage</span></span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"> k describe svc productpage</span><br><span class="line">Name:              productpage</span><br><span class="line">Namespace:         default</span><br><span class="line">Labels:            app=productpage</span><br><span class="line">                   service=productpage</span><br><span class="line">Annotations:       &lt;none&gt;</span><br><span class="line">Selector:          app=productpage</span><br><span class="line">Type:              ClusterIP</span><br><span class="line">IP Families:       &lt;none&gt;</span><br><span class="line">IP:                10.97.239.58</span><br><span class="line">IPs:               10.97.239.58</span><br><span class="line">Port:              http  9999/TCP  </span><br><span class="line">TargetPort:        9999/TCP  # 9999 å’Œä¸Šé¢containeræš´éœ²çš„æ¥å£ä¸ä¸€è‡´ï¼Œè®¿é—®ä¸€å®šä¼šå¤±è´¥</span><br><span class="line">Endpoints:         192.168.227.97:9999</span><br><span class="line">Session Affinity:  None</span><br><span class="line">Events:            &lt;none&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>è§£å†³æ–¹æ³•ï¼š</strong></p>
<ol>
<li>æ˜¾å¼åœ°å£°æ˜targetPort: 9080</li>
<li>ä½¿ç”¨9080ä½œä¸ºportï¼Œè¿™æ ·targetportä¹Ÿæ˜¯9080ï¼Œå°±å¯ä»¥å’Œcontainer portè¿æ¥èµ·æ¥ã€‚</li>
</ol>
<p>è¿™é‡Œæˆ‘ä»¬æŠŠtargetPortæ˜¾å¼çš„å†™æˆ9080ï¼Œä¼šå¾—åˆ°ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"> k describe svc productpage</span><br><span class="line">Name:              productpage</span><br><span class="line">Namespace:         default</span><br><span class="line">Labels:            app=productpage</span><br><span class="line">                   service=productpage</span><br><span class="line">Annotations:       &lt;none&gt;</span><br><span class="line">Selector:          app=productpage</span><br><span class="line">Type:              ClusterIP</span><br><span class="line">IP Families:       &lt;none&gt;</span><br><span class="line">IP:                10.97.239.58 # cluster IPï¼</span><br><span class="line">IPs:               10.97.239.58</span><br><span class="line">Port:              http  9999/TCP # æ³¨æ„ï¼</span><br><span class="line">TargetPort:        9080/TCP  # æ³¨æ„ï¼</span><br><span class="line">Endpoints:         192.168.227.97:9080 # æ³¨æ„ï¼</span><br><span class="line">Session Affinity:  None</span><br><span class="line">Events:            &lt;none&gt;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªserviceçš„ç»†èŠ‚è¦å¥½å¥½ç ”ç©¶ä¸€ä¸‹ã€‚</p>
<p><strong>IPï¼š</strong>Serviceçš„cluster IPã€‚</p>
<p><strong>Portï¼š</strong>Serviceçš„cluster IPæš´éœ²çš„æ¥å£ã€‚</p>
<p><strong>TargetPortï¼š</strong>å®¹å™¨æš´éœ²çš„æ¥å£ã€‚</p>
<p><strong>Endpointï¼š</strong> podIP:targetPortï¼Œæ³¨æ„è¿™é‡Œæ˜¯targetPortï¼Œä¸æ˜¯containerPortã€‚</p>
<p>åˆæœ‰è®¿é—®å®¹å™¨å†…åº”ç”¨çš„æ–°æ–¹å¼ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> clusterIP:port</span></span><br><span class="line">curl 10.97.239.58:9999</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> by endpoint, è·ŸcontainerPorté‡Œè®²åˆ°çš„å®é™…æ˜¯ä¸€æ ·çš„</span></span><br><span class="line">curl 192.168.227.97:9080</span><br></pre></td></tr></table></figure>


<h2 id="Port"><a href="#Port" class="headerlink" title="Port"></a>Port</h2><p>ä¸Šé¢è®²çš„å·®ä¸å¤šäº†ï¼Œä¹Ÿæ˜¯<strong>service</strong>é‡Œçš„æ¦‚å¿µï¼Œæ˜¯æŒ‡åœ¨clusterIPä¸Šæš´éœ²çš„ç«¯å£ï¼Œæ˜¯ä¸€ä¸ªè™šæ‹Ÿçš„ä¸œè¥¿ã€‚</p>
<p>clusterIPï¼šè™šæ‹Ÿçš„IPï¼Œåœ¨é›†ç¾¤å†…å¯ä»¥ç›¸äº’è®¿é—®ã€‚å®ƒåªæ˜¯å­˜åœ¨serviceçš„è§„åˆ™å½“ä¸­ã€‚ <strong>æ³¨æ„ï¼Œå®ƒä¸æ˜¯podIPã€‚</strong></p>
<h2 id="nodePort"><a href="#nodePort" class="headerlink" title="nodePort"></a>nodePort</h2><p>nodePort æä¾›äº†<strong>é›†ç¾¤å¤–</strong>éƒ¨å®¢æˆ·ç«¯è®¿é—® Service çš„ä¸€ç§æ–¹å¼ï¼ŒnodePort æä¾›äº†é›†ç¾¤å¤–éƒ¨å®¢æˆ·ç«¯è®¿é—® Service çš„ç«¯å£ï¼Œé€šè¿‡ <code>nodeIP:nodePort</code> æä¾›äº†å¤–éƒ¨æµé‡è®¿é—®k8sé›†ç¾¤ä¸­serviceçš„å…¥å£ã€‚</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> k get svc -owide</span></span><br><span class="line">NAME          TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)         AGE    SELECTOR</span><br><span class="line">productpage   NodePort    10.97.239.58   &lt;none&gt;       9999:30066/TCP  25m app=productpage</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> k describe svc productpage</span></span><br><span class="line">Name:                     productpage</span><br><span class="line">Namespace:                default</span><br><span class="line">Labels:                   app=productpage</span><br><span class="line">                          service=productpage</span><br><span class="line">Annotations:              &lt;none&gt;</span><br><span class="line">Selector:                 app=productpage</span><br><span class="line">Type:                     NodePort</span><br><span class="line">IP Families:              &lt;none&gt;</span><br><span class="line">IP:                       10.97.239.58</span><br><span class="line">IPs:                      10.97.239.58</span><br><span class="line">Port:                     http  9999/TCP</span><br><span class="line">TargetPort:               9080/TCP</span><br><span class="line">NodePort:                 http  30066/TCP  # åœ¨host nodeä¸Šæš´éœ²çš„ç«¯å£</span><br><span class="line">Endpoints:                192.168.227.97:9080</span><br><span class="line">Session Affinity:         None</span><br><span class="line">External Traffic Policy:  Cluster</span><br><span class="line">Events:                   &lt;none&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>åˆä¸€ç§æ–°çš„è®¿é—®æ–¹å¼ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">hostIP:nodeport</span></span><br><span class="line">curl localhost:30066</span><br></pre></td></tr></table></figure>


<p>æ€»ç»“ï¼š</p>
<p><img src="/posts/3836ec52/image-20210308190947963.png" alt="image-20210308190947963"></p>
<p>ä¸‰ç§è®¿é—®æ–¹å¼ä»¥åŠèŒƒå›´ï¼š</p>
<table>
<thead>
<tr>
<th>æ–¹å¼</th>
<th>èŒƒå›´</th>
</tr>
</thead>
<tbody><tr>
<td>podIP:targetPort</td>
<td>å’Œpodåœ¨åŒä¸€ä¸ªç½‘ç»œä¸‹</td>
</tr>
<tr>
<td>clusterIP:port</td>
<td>åœ¨é›†ç¾¤ä¸­</td>
</tr>
<tr>
<td>hostIP:nodeport</td>
<td>ä¸»æœºä¹‹é—´ä¹Ÿå¯ä»¥è®¿é—®</td>
</tr>
</tbody></table>
]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
  </entry>
  <entry>
    <title>å…¬å¸å†…éƒ¨sshè®¾ç½®socksä»£ç†</title>
    <url>/posts/a9be766e.html</url>
    <content><![CDATA[<blockquote>
<p><a href="https://intelpedia.intel.com/Proxy_at_Intel">Proxy at Intel - Intelpedia</a></p>
<p>å› ä¸ºå…¬å¸è®¾ç½®äº†vpnï¼Œæ‰€ä»¥é€šè¿‡å…¬å¸ç”µè„‘è®¿é—®å¤–ç½‘æ—¶éœ€è¦é€šè¿‡ä»£ç†ï¼ˆhttp, https, socksç­‰ï¼‰ã€‚</p>
</blockquote>
<h4 id="èµ·å› "><a href="#èµ·å› " class="headerlink" title="èµ·å› "></a>èµ·å› </h4><p>åœ¨éƒ¨ç½²hexoæ—¶ï¼Œç”¨åˆ°äº†git deployerã€‚è¿™ä¸ªdeployeråœ¨æ¯æ¬¡<code>hexo deploy</code>çš„æ—¶å€™ä¼šé€šè¿‡sshé“¾æ¥æˆ‘çš„githubè´¦å·çš„xxx.github.ioé¡¹ç›®ï¼Œè¿æ¥æŠ¥é”™ã€‚</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> çœ‹ä¸€ä¸‹hexoçš„_config.ymlæ–‡ä»¶</span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat _config.yml  | grep -A10 deploy</span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># Docs: https://hexo.io/docs/one-command-deployment</span></span></span><br><span class="line">deploy:</span><br><span class="line">  type: git</span><br><span class="line">  repository: git@github.com:xxinran/xxinran.github.io.git</span><br><span class="line">  branch: main</span><br></pre></td></tr></table></figure>
<p>åœ¨sshkeyä¸Šä¼ æˆåŠŸçš„æƒ…å†µä¸‹ï¼Œæµ‹è¯•sshè¿æ¥github</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ssh -T git@github.com  #å¤±è´¥</span><br></pre></td></tr></table></figure>
<p>åæ¥å‘ç°æ˜¯sshæ²¡æœ‰é…ç½®ä»£ç†ï¼Œæœ‰ä¸¤ä¸ªæ–¹æ¡ˆï¼š</p>
<ol>
<li>è®¾ç½®httpä»£ç†ï¼ˆå¤±è´¥äº†ï¼‰</li>
<li>è®¾ç½®socksä»£ç†ï¼ˆæˆåŠŸï¼‰</li>
</ol>
<h4 id="å¦‚ä½•è®¾ç½®socksä»£ç†"><a href="#å¦‚ä½•è®¾ç½®socksä»£ç†" class="headerlink" title="å¦‚ä½•è®¾ç½®socksä»£ç†"></a>å¦‚ä½•è®¾ç½®socksä»£ç†</h4><p>åœ¨<a href="https://intelpedia.intel.com/Proxy_at_Intel#Using_openssh_to_connect_out_via_SOCKS_proxy">å…¬å¸æ–‡æ¡£</a>ä¸­çœ‹åˆ°ï¼Œå¯ä»¥é€šè¿‡è®¾ç½®socksä»£ç†ï¼Œå»ºç«‹å¯¹å¤–éƒ¨çš„sshè¿æ¥ã€‚</p>
<p>éœ€è¦ä¿®æ”¹<code>.ssh/config</code>æ–‡ä»¶ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> linux</span></span><br><span class="line">Host *</span><br><span class="line">   ProxyCommand nc -X 5 -x proxy-xxx.intel.com:1080 %h %p</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> windowsä¸Šéœ€è¦æŠŠncå‘½ä»¤æ”¹æˆconnectï¼Œå‚æ•°-Sè¡¨ç¤ºæ˜¯socksä»£ç†ã€‚</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat ~/.ssh/config | tail -5</span></span><br><span class="line">Host github.com</span><br><span class="line">   HostName github.com</span><br><span class="line">   User git</span><br><span class="line">   ProxyCommand connect -S proxy-xxx.intel.com:1080 %h %p</span><br><span class="line">   ForwardAgent yes</span><br></pre></td></tr></table></figure>
<p>ä¹‹åå°±å¯ä»¥æˆåŠŸsshè¿æ¥githubäº†ã€‚</p>
<p>ä½†æ˜¯<code>ping proxy-xxx.intel.com</code>æ˜¯pingä¸é€šçš„ï¼Œåº”è¯¥æ˜¯å…¬å¸å…³é—­äº†ã€‚</p>
]]></content>
      <categories>
        <category>deploy, network, intel</category>
      </categories>
      <tags>
        <tag>network</tag>
        <tag>ssh</tag>
        <tag>socks</tag>
      </tags>
  </entry>
  <entry>
    <title>ç§‘å­¦ä¸Šç½‘ssr</title>
    <url>/posts/a838020d.html</url>
    <content><![CDATA[<blockquote>
<p>å·¥å…·ï¼š<br>shadowsocks-libev<br>google vm</p>
</blockquote>
<h2 id="google-vmçš„åŸºæœ¬é…ç½®"><a href="#google-vmçš„åŸºæœ¬é…ç½®" class="headerlink" title="google vmçš„åŸºæœ¬é…ç½®"></a>google vmçš„åŸºæœ¬é…ç½®</h2><h3 id="å‡†å¤‡å·¥ä½œ"><a href="#å‡†å¤‡å·¥ä½œ" class="headerlink" title="å‡†å¤‡å·¥ä½œ"></a>å‡†å¤‡å·¥ä½œ</h3><p>å…·ä½“åˆ›å»ºæ­¥éª¤ç•¥ï¼Œéœ€è¦ä¸€ä¸ªç»‘å®šä¸€ä¸ªæµ·å¤–é“¶è¡Œå¡ã€‚</p>
<p>ä¸‹é¢æ˜¯æˆ‘åˆ›å»ºçš„è™šæ‹Ÿæœºã€‚</p>
<p><img src="/posts/a838020d/image-20210220162859580.png" alt="image-20210220162859580"></p>
<p>åˆ›å»ºå¥½ä¹‹åå¯ä»¥å»ç«™é•¿ä¹‹å®¶pingä¸€ä¸‹ï¼Œä¿è¯åœ¨å›½å†…å¤§å¤šæ•°åœ°æ–¹å¯ä»¥pingé€šã€‚å¦‚æœpingä¸é€šåˆ äº†é‡å»ºã€‚</p>
<p>ç„¶åé€šè¿‡å·¦è¾¹çš„<code>ssh</code>ç™»å½•ä¸Šå»ã€‚</p>
<h3 id="å®‰è£…ssr"><a href="#å®‰è£…ssr" class="headerlink" title="å®‰è£…ssr"></a>å®‰è£…ssr</h3><h4 id="dependency"><a href="#dependency" class="headerlink" title="dependency"></a>dependency</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo apt update</span><br><span class="line">sudo apt-get install --no-install-recommends gettext build-essential autoconf libtool libpcre3-dev asciidoc xmlto libev-dev libc-ares-dev automake libmbedtls-dev libsodium-dev</span><br></pre></td></tr></table></figure>
<h4 id="install-from-source"><a href="#install-from-source" class="headerlink" title="install from source"></a>install from source</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo apt install git</span><br><span class="line">git clone https://github.com/shadowsocks/shadowsocks-libev.git</span><br><span class="line">sudo apt-get install --no-install-recommends gettext build-essential autoconf libtool libpcre3-dev asciidoc xmlto libev-dev libc-ares-dev automake libmbedtls-dev libsodium-dev</span><br><span class="line">cd shadowsocks-libev/ ./autogen.sh</span><br></pre></td></tr></table></figure>
<p>missing makefile - &gt;  <code>git submodule update --init --recursive</code></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">./configure</span><br><span class="line"><span class="meta">#</span><span class="bash"> maybe not needï¼š</span></span><br><span class="line">make</span><br><span class="line">sudo make install</span><br><span class="line">dpkg-buildpackage -b -us -uc -I</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">æŠ¥é”™: missing pkg-config</span></span><br><span class="line">sudo apt-get install -y pkg-config debhelper </span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> install deb pkg</span></span><br><span class="line">cd .. &amp;&amp; sudo dpkg -i shadowsocks-libev*.deb</span><br></pre></td></tr></table></figure>
<h4 id="edit-config-file"><a href="#edit-config-file" class="headerlink" title="edit config file"></a>edit config file</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">vim /etc/shadowsocks-libev/config.json </span><br><span class="line">&#123;</span><br><span class="line">  &quot;server&quot;:[&quot;::1&quot;, &quot;127.0.0.1&quot;], # internal IP</span><br><span class="line">  &quot;mode&quot;:&quot;tcp_and_udp&quot;,</span><br><span class="line">  &quot;server_port&quot;:8388, # need enable this port&#x27;s ingress in firewall</span><br><span class="line">  &quot;local_port&quot;:1080,</span><br><span class="line">  &quot;password&quot;:&quot;password&quot;,</span><br><span class="line">  &quot;timeout&quot;:86400,</span><br><span class="line">  &quot;method&quot;:&quot;aes-256-cfb&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> restart service</span></span><br><span class="line">sudo systemctl restart shadowsocks-libev</span><br></pre></td></tr></table></figure>
<h4 id="firewall-configuration"><a href="#firewall-configuration" class="headerlink" title="firewall configuration"></a>firewall configuration</h4><p><img src="/posts/a838020d/image-20210420112717314.png" alt="image-20210420112717314"></p>
<h3 id="å®‰è£…å®¢æˆ·ç«¯"><a href="#å®‰è£…å®¢æˆ·ç«¯" class="headerlink" title="å®‰è£…å®¢æˆ·ç«¯"></a>å®‰è£…å®¢æˆ·ç«¯</h3><h4 id="æ‰‹æœº"><a href="#æ‰‹æœº" class="headerlink" title="æ‰‹æœº"></a>æ‰‹æœº</h4><p>shadowrocket</p>
<h4 id="MacOS"><a href="#MacOS" class="headerlink" title="MacOS"></a>MacOS</h4><p>shadowsocks-NG</p>
<p>need local socks proxy</p>
]]></content>
      <tags>
        <tag>network</tag>
        <tag>deploy</tag>
      </tags>
  </entry>
  <entry>
    <title>tlså’Œmtlsæ¯”è¾ƒ</title>
    <url>/posts/425c0d17.html</url>
    <content><![CDATA[<h2 id="TLS"><a href="#TLS" class="headerlink" title="TLS"></a>TLS</h2><p>æºäºSSLï¼Œåæ”¹åTLSï¼ˆTransport Layer Securityï¼‰</p>
<ol>
<li>å¯ä»¥å®ç°é€šè®¯åŒæ–¹çš„èº«ä»½è®¤è¯ï¼Œåº”ç”¨æ•°æ®åŠ å¯†ã€‚</li>
<li>ä¸ä¸Šå±‚çš„åº”ç”¨å±‚åè®®æ— è€¦åˆï¼Œåº”ç”¨å±‚åè®®èƒ½é€æ˜åœ°è¿è¡Œåœ¨TLSåè®®æ„å»ºçš„å®‰å…¨é€šé“ä¹‹ä¸Šã€‚</li>
</ol>
<p>TLSç”±è®°å½•å±‚ï¼ˆè®°å½•åè®®ï¼Œ record protocolï¼‰å’Œæ¡æ‰‹åè®®å±‚ï¼ˆæ¡æ‰‹åè®®ã€å¯†é’¥å˜æ›´åè®®ã€å‘Šè­¦åè®®ï¼Œåº”ç”¨æ•°æ®åè®®ï¼‰ç»„æˆã€‚</p>
<img src="/posts/425c0d17/image-20210329145853869.png" alt="image-20210329145853869" style="zoom:80%;">



<p><img src="https://segmentfault.com/img/bVbCCMD/view" alt="preview"></p>
<p>HTTPS = HTTP over TLS.</p>
<p>æ•£åˆ—å‡½æ•° Hashã€å¯¹ç§°åŠ å¯†å’Œéå¯¹ç§°åŠ å¯†ï¼Œå…¶åˆ©ç”¨éå¯¹ç§°åŠ å¯†å®ç°èº«ä»½è®¤è¯å’Œå¯†é’¥åå•†ï¼Œå¯¹ç§°åŠ å¯†ç®—æ³•é‡‡ç”¨åå•†çš„å¯†é’¥å¯¹æ•°æ®åŠ å¯†ï¼ŒåŸºäºæ•£åˆ—å‡½æ•°éªŒè¯ä¿¡æ¯çš„å®Œæ•´æ€§</p>
<p>mTLS</p>
]]></content>
  </entry>
  <entry>
    <title>QATåœ¨Ubuntu18.04ä¸Šçš„å®‰è£…å’Œè™šæ‹ŸåŒ–</title>
    <url>/posts/461bb783.html</url>
    <content><![CDATA[<p>æœ¬æ–‡å°†ä»‹ç»QAT c62xxè®¾å¤‡åœ¨Ubuntu 18.04ä¸Šçš„å®‰è£…éƒ¨ç½²å’Œè™šæ‹ŸåŒ–ã€‚</p>
<blockquote>
<p>å‚è€ƒç½‘ç«™ï¼š<a href="https://01.org/intel-quickassist-technology">https://01.org/intel-quickassist-technology</a></p>
</blockquote>
<h3 id="Prerequisite"><a href="#Prerequisite" class="headerlink" title="Prerequisite"></a>Prerequisite</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> uname -a</span></span><br><span class="line">Linux tme-prc002 5.3.0-53-generic #47~18.04.1-Ubuntu SMP Thu May 7 13:10:50 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux</span><br></pre></td></tr></table></figure>
<h3 id="Updating-grub-Configuration-File"><a href="#Updating-grub-Configuration-File" class="headerlink" title="Updating grub Configuration File"></a>Updating grub Configuration File</h3><p>To enable IOMMU and SRIOV</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo vim /etc/default/grub</span><br></pre></td></tr></table></figure>
<p>Modify <code>GRUB_CMDLINE_LINUX_DEFAULT=&quot;quiet splash&quot;</code> to <code>&quot;quiet splash intel_iommu=on&quot;</code></p>
<p>Update grub and reboot:</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">update-grub</span><br><span class="line">sudo reboot</span><br></pre></td></tr></table></figure>
<h3 id="Building-and-Installing-Software"><a href="#Building-and-Installing-Software" class="headerlink" title="Building and Installing Software"></a>Building and Installing Software</h3><h4 id="Create-a-working-directory-for-the-software-This-directory-can-be-user-defined-but"><a href="#Create-a-working-directory-for-the-software-This-directory-can-be-user-defined-but" class="headerlink" title="Create a working directory for the software. This directory can be user defined, but"></a>Create a working directory for the software. This directory can be user defined, but</h4><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="variable">$</span> <span class="built_in">cd</span> <span class="variable">$HOME</span> </span><br><span class="line"><span class="variable">$</span> mkdir /QAT</span><br><span class="line"><span class="variable">$</span> <span class="built_in">cd</span> /QAT</span><br></pre></td></tr></table></figure>
<h4 id="Download-the-software"><a href="#Download-the-software" class="headerlink" title="Download the software."></a>Download the software.</h4><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">curl -O https:<span class="regexp">//</span><span class="number">01</span>.org<span class="regexp">/sites/</span>default<span class="regexp">/files/</span>downloads<span class="regexp">/intelr-quickassist-technology/</span>qat1.<span class="number">7</span>.l.<span class="number">4.3</span>.<span class="number">0</span>-<span class="number">00033</span>.tar.gz</span><br></pre></td></tr></table></figure>
<h4 id="Unpack-the-software"><a href="#Unpack-the-software" class="headerlink" title="Unpack the software."></a>Unpack the software.</h4><figure class="highlight elixir"><table><tr><td class="code"><pre><span class="line"><span class="variable">$ </span>tar -zxof &lt;QAT tarball name&gt;  </span><br><span class="line"><span class="variable">$ </span>chmod -R o-rwx *</span><br></pre></td></tr></table></figure>
<h4 id="Install-dependencies-if-needed"><a href="#Install-dependencies-if-needed" class="headerlink" title="Install dependencies if needed."></a>Install dependencies if needed.</h4><p>For CentOS:</p>
<figure class="highlight elixir"><table><tr><td class="code"><pre><span class="line"><span class="variable">$ </span>yum -y groupinstall <span class="string">&quot;Development Tools&quot;</span></span><br><span class="line"><span class="variable">$ </span>yum -y install pciutils</span><br><span class="line"><span class="variable">$ </span>yum -y install libudev-devel</span><br><span class="line"><span class="variable">$ </span>yum -y install kernel-devel-<span class="variable">$(</span>uname -r)</span><br><span class="line"><span class="variable">$ </span>yum -y install gcc</span><br><span class="line"><span class="variable">$ </span>yum -y install openssl-devel</span><br></pre></td></tr></table></figure>
<p>For Ubuntu:</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">$ apt-<span class="builtin-name">get</span> update</span><br><span class="line">$ apt-<span class="builtin-name">get</span> install pciutils-dev</span><br><span class="line">$ apt-<span class="builtin-name">get</span> install g++</span><br><span class="line">$ apt-<span class="builtin-name">get</span> install pkg-config</span><br><span class="line">$ apt-<span class="builtin-name">get</span> install libssl-dev</span><br></pre></td></tr></table></figure>
<h4 id="configure-make-and-make-install-the-software-packages"><a href="#configure-make-and-make-install-the-software-packages" class="headerlink" title="configure, make and make install the software packages."></a>configure, make and make install the software packages.</h4><figure class="highlight elixir"><table><tr><td class="code"><pre><span class="line"><span class="comment"># suggest to clear up the env if there is a previous or modified version installed</span></span><br><span class="line"><span class="variable">$ </span>make uninstall</span><br><span class="line"><span class="variable">$ </span>./configure --enable-icp-sriov=host  <span class="comment"># It fails if missing dependency package.</span></span><br><span class="line"><span class="variable">$ </span>make</span><br><span class="line"><span class="variable">$ </span>make install  </span><br><span class="line"><span class="variable">$ </span>service qat_service start  </span><br><span class="line"><span class="variable">$ </span>service qat_service_vfs start</span><br></pre></td></tr></table></figure>
<p>NOTE: in Guest OS, enable the SR-IOV build on the host by using:</p>
<figure class="highlight jboss-cli"><table><tr><td class="code"><pre><span class="line">$ <span class="string">./configure</span> <span class="params">--enable-icp-sriov=guest</span></span><br></pre></td></tr></table></figure>
<h4 id="Verifying-SR-IOV-On-The-Host"><a href="#Verifying-SR-IOV-On-The-Host" class="headerlink" title="Verifying SR-IOV On The Host"></a>Verifying SR-IOV On The Host</h4><figure class="highlight llvm"><table><tr><td class="code"><pre><span class="line">$ lspci | grep <span class="number">37</span><span class="keyword">c</span><span class="number">9</span>  </span><br><span class="line"># <span class="keyword">or</span> </span><br><span class="line">$ lspci -d <span class="number">8086</span>:<span class="number">37</span><span class="keyword">c</span><span class="number">9</span></span><br><span class="line">$ lspci -d:<span class="number">37</span><span class="keyword">c</span><span class="number">9</span></span><br><span class="line">...</span><br><span class="line"><span class="number">01</span>:<span class="number">01.0</span> Co-processor: Intel Corporation Device <span class="number">37</span><span class="keyword">c</span><span class="number">9</span></span><br><span class="line"><span class="number">01</span>:<span class="number">01.1</span> Co-processor: Intel Corporation Device <span class="number">37</span><span class="keyword">c</span><span class="number">9</span></span><br><span class="line"><span class="number">01</span>:<span class="number">01.2</span> Co-processor: Intel Corporation Device <span class="number">37</span><span class="keyword">c</span><span class="number">9</span></span><br><span class="line">...</span><br><span class="line"><span class="number">01</span>:<span class="number">01.7</span> Co-processor: Intel Corporation Device <span class="number">37</span><span class="keyword">c</span><span class="number">9</span></span><br><span class="line"><span class="number">01</span>:<span class="number">02.0</span> Co-processor: Intel Corporation Device <span class="number">37</span><span class="keyword">c</span><span class="number">9</span></span><br><span class="line"><span class="number">01</span>:<span class="number">02.1</span> Co-processor: Intel Corporation Device <span class="number">37</span><span class="keyword">c</span><span class="number">9</span></span><br><span class="line">...</span><br><span class="line"><span class="number">01</span>:<span class="number">02.6</span> Co-processor: Intel Corporation Device <span class="number">37</span><span class="keyword">c</span><span class="number">9</span></span><br><span class="line"><span class="number">01</span>:<span class="number">02.7</span> Co-processor: Intel Corporation Device <span class="number">37</span><span class="keyword">c</span><span class="number">9</span></span><br></pre></td></tr></table></figure>
<p>Or using <code>adf_ctl</code></p>
<figure class="highlight elixir"><table><tr><td class="code"><pre><span class="line"><span class="variable">$ </span>adf_ctl status</span><br></pre></td></tr></table></figure>
<p>This utility can bring up/down device by ourselves.</p>
<h4 id="Detailed-SR-IOV-enabling-please-refer-to-the-guide"><a href="#Detailed-SR-IOV-enabling-please-refer-to-the-guide" class="headerlink" title="Detailed SR-IOV enabling please refer to the guide."></a>Detailed SR-IOV enabling please refer to the guide.</h4><p>Please refer to:<br><a href="https://01.org/sites/default/files/downloads/330689qatvirtualizationappnoterev008us.pdf">https://01.org/sites/default/files/downloads/330689qatvirtualizationappnoterev008us.pdf</a></p>
]]></content>
      <categories>
        <category>deploy</category>
      </categories>
      <tags>
        <tag>qat</tag>
      </tags>
  </entry>
  <entry>
    <title>åœ¨macä¸Šç”¨vagrantå’Œvirtualboxåˆ›å»ºè™šæ‹Ÿæœº</title>
    <url>/posts/e1d7a8.html</url>
    <content><![CDATA[<h2 id="vagrantä»‹ç»"><a href="#vagrantä»‹ç»" class="headerlink" title="vagrantä»‹ç»"></a>vagrantä»‹ç»</h2><p>åŸºäºrubyï¼Œç”¨äºåˆ›å»ºå’Œéƒ¨ç½²è™šæ‹ŸåŒ–å¼€å‘ç¯å¢ƒã€‚å®ƒ ä½¿ç”¨Oracleçš„å¼€æº<a href="https://baike.baidu.com/item/VirtualBox">VirtualBox</a>è™šæ‹ŸåŒ–ç³»ç»Ÿï¼Œä½¿ç”¨ Chefåˆ›å»ºè‡ªåŠ¨åŒ–è™šæ‹Ÿç¯å¢ƒã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å®ƒæ¥å¹²å¦‚ä¸‹è¿™äº›äº‹ï¼š</p>
<ul>
<li><p>å»ºç«‹å’Œåˆ é™¤è™šæ‹Ÿæœº</p>
</li>
<li><p>é…ç½®è™šæ‹Ÿæœºè¿è¡Œå‚æ•°</p>
</li>
<li><p>ç®¡ç†è™šæ‹Ÿæœºè¿è¡ŒçŠ¶æ€</p>
</li>
<li><p>è‡ªåŠ¨é…ç½®å’Œå®‰è£…å¼€å‘ç¯å¢ƒÃŸ</p>
</li>
<li><p>æ‰“åŒ…å’Œåˆ†å‘è™šæ‹Ÿæœºè¿è¡Œç¯å¢ƒ</p>
</li>
</ul>
<p>ã€€ã€€Vagrantçš„è¿è¡Œï¼Œéœ€è¦<strong>ä¾èµ–</strong>æŸé¡¹å…·ä½“çš„<strong>è™šæ‹ŸåŒ–æŠ€æœ¯</strong>ï¼Œæœ€å¸¸è§çš„æœ‰VirtualBoxä»¥åŠVMWareä¸¤æ¬¾ï¼Œæ—©æœŸï¼ŒVagrantåªæ”¯æŒVirtualBoxï¼Œåæ¥æ‰åŠ å…¥äº†VMWareçš„æ”¯æŒã€‚ç°åœ¨vagrantæ”¯æŒæ›´å¤šçš„è™šæ‹ŸåŒ–ç³»ç»Ÿï¼ŒåŒ…æ‹¬libvirtï¼Œkvmï¼Œqemuï¼Œvmwareï¼Œç”šè‡³dockerã€‚ä½†è¿˜æ˜¯ä»¥virtualboxä¸ºä¸»ã€‚</p>
<img src="/posts/e1d7a8/image-20210128223212650.png" alt="image-20210128223212650" style="zoom:50%;">

<h3 id="vagrantå’Œvirtualbox"><a href="#vagrantå’Œvirtualbox" class="headerlink" title="vagrantå’Œvirtualbox"></a>vagrantå’Œvirtualbox</h3><p>virtualboxæœ¬èº«ä¹Ÿå¯ä»¥åˆ›å»ºvmï¼Œåªæ˜¯ç›¸å¯¹éº»çƒ¦ï¼Œvagrantå¯ä»¥è°ƒç”¨virtualboxçš„æ¥å£æ›´åŠ æ–¹ä¾¿çš„åˆ›å»ºvmã€‚</p>
<h3 id="åœ¨macä¸Šå®‰è£…vagrant-virtualbox"><a href="#åœ¨macä¸Šå®‰è£…vagrant-virtualbox" class="headerlink" title="åœ¨macä¸Šå®‰è£…vagrant+virtualbox"></a>åœ¨macä¸Šå®‰è£…vagrant+virtualbox</h3><h4 id="å®‰è£…vagrant"><a href="#å®‰è£…vagrant" class="headerlink" title="å®‰è£…vagrant"></a>å®‰è£…vagrant</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">brew install vagrant</span><br><span class="line">vagrant -v</span><br></pre></td></tr></table></figure>
<h4 id="å®‰è£…virtualbox"><a href="#å®‰è£…virtualbox" class="headerlink" title="å®‰è£…virtualbox"></a>å®‰è£…virtualbox</h4><p>å›½å¤–çš„dmgæ–‡ä»¶ä¸‹è½½å¾ˆæ…¢ï¼Œæˆ‘æ˜¯å›½å†…éšä¾¿æ‰¾äº†ä¸€ä¸ª<a href="https://ftp-new-pc.pconline.com.cn/pub/download/201909/pconline1567810102832.dmg?md5=dLIvaxUfMIGWrr-oloz2Jg&expires=1611979478">æº</a>ã€‚</p>
<img src="/posts/e1d7a8/image-20210130123540411.png" alt="image-20210130123540411" style="zoom:50%;">

<p>virtualboxæœ¬èº«ä¹Ÿå¯ä»¥åˆ›å»ºvmï¼Œä½†æ˜¯æ¯”è¾ƒå¤æ‚ã€‚</p>
<h4 id="ä¸‹è½½box"><a href="#ä¸‹è½½box" class="headerlink" title="ä¸‹è½½box"></a>ä¸‹è½½box</h4><p>vagrantä¸­boxçš„æ¦‚å¿µï¼Œç±»ä¼¼äºdocker imageã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡æŒ‡å®šboxæ¥å¯åŠ¨ä¸€ä¸ªvagrant vmã€‚</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> å…ˆä¸‹è½½box fileåˆ°æœ¬åœ°ï¼Œå†add</span></span><br><span class="line">vagrant box add centos8 /path/to/boxfile</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> ç›´æ¥ä»ç½‘ä¸Šä¸‹è½½box fileï¼Œå¹¶ä¸”add</span></span><br><span class="line">vagrant box add centos8 url_to_box_file</span><br></pre></td></tr></table></figure>
<p>vagrantboxçš„å®˜æ–¹ä¸‹è½½åœ°å€ä»å›½å†…è¿æ¥å¾ˆæ…¢ï¼Œæˆ‘æ‰¾åˆ°äº†ä¸€äº›å›½å†…çš„æºã€‚</p>
<blockquote>
<p>centos 8</p>
<p><a href="http://mirrors.ustc.edu.cn/centos-cloud/centos/8/vagrant/x86_64/images/CentOS-8-Vagrant-8.3.2011-20201204.2.x86_64.vagrant-virtualbox.box">http://mirrors.ustc.edu.cn/centos-cloud/centos/8/vagrant/x86_64/images/CentOS-8-Vagrant-8.3.2011-20201204.2.x86_64.vagrant-virtualbox.box</a></p>
<p>ubuntu1804</p>
<p><a href="https://mirrors.tuna.tsinghua.edu.cn/ubuntu-cloud-images/bionic/current/bionic-server-cloudimg-amd64-vagrant.box">https://mirrors.tuna.tsinghua.edu.cn/ubuntu-cloud-images/bionic/current/bionic-server-cloudimg-amd64-vagrant.box</a></p>
</blockquote>
<h4 id="å¯åŠ¨è™šæ‹Ÿæœº"><a href="#å¯åŠ¨è™šæ‹Ÿæœº" class="headerlink" title="å¯åŠ¨è™šæ‹Ÿæœº"></a>å¯åŠ¨è™šæ‹Ÿæœº</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> vagrant box add centos8 http://mirrors.ustc.edu.cn/centos-cloud/centos/8/vagrant/x86_64/images/CentOS-8-Vagrant-8.3.2011-20201204.2.x86_64.vagrant-virtualbox.box</span></span><br><span class="line">==&gt; box: Box file was not detected as metadata. Adding it directly...</span><br><span class="line">==&gt; box: Adding box &#x27;centos8&#x27; (v0) for provider:</span><br><span class="line">    box: Downloading: http://mirrors.ustc.edu.cn/centos-cloud/centos/8/vagrant/x86_64/images/CentOS-8-Vagrant-8.3.2011-20201204.2.x86_64.vagrant-virtualbox.box</span><br><span class="line">==&gt; box: Successfully added box &#x27;centos8&#x27; (v0) for &#x27;virtualbox&#x27;!</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> vagrant box list</span></span><br><span class="line">centos8    (virtualbox, 0)</span><br><span class="line">ubuntu1804 (virtualbox, 0)</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> åˆ›å»ºæœ¬åœ°vagrantç›®å½•</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> vagrant</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> è¿™ä¸€æ­¥ä¼šåˆ›å»ºä¸€ä¸ªvmçš„Vagrantfileï¼Œæ‰€æœ‰å…³äºvmçš„é…ç½®éƒ½åœ¨è¿™ä¸ªæ–‡ä»¶é‡Œã€‚</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> vagrant init centos8</span></span><br><span class="line">A `Vagrantfile` has been placed in this directory. You are now</span><br><span class="line">ready to `vagrant up` your first virtual environment! Please read</span><br><span class="line">the comments in the Vagrantfile as well as documentation on</span><br><span class="line">`vagrantup.com` for more information on using Vagrant.</span><br><span class="line"> </span><br><span class="line"><span class="meta"> #</span><span class="bash"> å¯åŠ¨vm</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> vagrant up</span></span><br><span class="line">Bringing machine &#x27;default&#x27; up with &#x27;virtualbox&#x27; provider...</span><br><span class="line">==&gt; default: Importing base box &#x27;centos8&#x27;...</span><br><span class="line">==&gt; default: Matching MAC address for NAT networking...</span><br><span class="line">==&gt; default: Setting the name of the VM: vagrant_default_1611980890156_41411</span><br><span class="line">==&gt; default: Clearing any previously set network interfaces...</span><br><span class="line">==&gt; default: Preparing network interfaces based on configuration...</span><br><span class="line">    default: Adapter 1: nat</span><br><span class="line">    default: Adapter 2: hostonly</span><br><span class="line">==&gt; default: Forwarding ports...</span><br><span class="line">    default: 22 (guest) =&gt; 2222 (host) (adapter 1)  # ç«¯å£æ˜ å°„, å¦‚æœèµ·äº†å¤šä¸ªvagrant vmï¼Œé‚£ä¹ˆå„ä¸ª</span><br><span class="line">    																								# vm ä¼šæ˜ å°„åˆ°hostçš„ä¸åŒç«¯å£</span><br><span class="line">==&gt; default: Booting VM...</span><br><span class="line">==&gt; default: Waiting for machine to boot. This may take a few minutes...</span><br><span class="line">    default: SSH address: 127.0.0.1:2222</span><br><span class="line">    default: SSH username: vagrant</span><br><span class="line">    default: SSH auth method: private key</span><br><span class="line">    default:</span><br><span class="line">    default: Vagrant insecure key detected. Vagrant will automatically replace</span><br><span class="line">    default: this with a newly generated keypair for better security.</span><br><span class="line">    default:</span><br><span class="line">    default: Inserting generated public key within guest...</span><br><span class="line">    default: Removing insecure key from the guest if it&#x27;s present...</span><br><span class="line">    default: Key inserted! Disconnecting and reconnecting using new SSH key...</span><br><span class="line">==&gt; default: Machine booted and ready!</span><br><span class="line">==&gt; default: Checking for guest additions in VM...</span><br><span class="line">    default: No guest additions were detected on the base box for this VM! Guest</span><br><span class="line">    default: additions are required for forwarded ports, shared folders, host only</span><br><span class="line">    default: networking, and more. If SSH fails on this machine, please install</span><br><span class="line">    default: the guest additions and repackage the box to continue.</span><br><span class="line">    default:</span><br><span class="line">    default: This is not an error message; everything may continue to work properly,</span><br><span class="line">    default: in which case you may ignore this message.</span><br><span class="line">==&gt; default: Configuring and enabling network interfaces...</span><br><span class="line">==&gt; default: Rsyncing folder: /Users/xinran/vagrant/ =&gt; /vagrant</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> ç™»å…¥/é€€å‡ºvm</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> vagrant ssh</span></span><br><span class="line">Last login: Sat Jan 30 04:28:57 2021 from 10.0.2.2</span><br><span class="line">[vagrant@localhost ~]$ </span><br><span class="line">[vagrant@localhost ~]$ exit</span><br><span class="line">logout</span><br><span class="line">Shared connection to 127.0.0.1 closed.</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> æŸ¥çœ‹hostä¸Šçš„2222ç«¯å£</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> lsof -i:2222</span></span><br><span class="line">COMMAND     PID   USER   FD   TYPE             DEVICE SIZE/OFF NODE NAME</span><br><span class="line">VBoxHeadl 13238 xinran   16u  IPv4 0x294cd01b85b191f5      0t0  TCP localhost:rockwell-csp2 (LISTEN)</span><br><span class="line">VBoxHeadl 13238 xinran   20u  IPv4 0x294cd01b95fd8815      0t0  TCP localhost:rockwell-csp2-&gt;localhost:63021 (ESTABLISHED)</span><br><span class="line">ssh       13880 xinran    3u  IPv4 0x294cd01b94ae9e35      0t0  TCP localhost:63021-&gt;localhost:rockwell-csp2 (ESTABLISHED)</span><br><span class="line">ssh       13894 xinran    3u  IPv4 0x294cd01b94ae9e35      0t0  TCP localhost:63021-&gt;localhost:rockwell-csp2 (ESTABLISHE</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Note: åœ¨ä¸‹è½½box imageæ—¶ï¼Œè¦æ‰¾åˆ°å¯¹åº”providerçš„boxã€‚æˆ‘ç¬¬ä¸€æ¬¡ä¸‹è½½æˆäº†libvirt providerçš„boxï¼Œç„¶åvagrant initå°±å¤±è´¥äº†ï¼Œå› ä¸ºæˆ‘çš„hostä¸Šè£…çš„æ˜¯virtualboxä½œä¸ºproviderã€‚</p>
</blockquote>
]]></content>
      <tags>
        <tag>vagrant</tag>
        <tag>virtualbox</tag>
      </tags>
  </entry>
  <entry>
    <title>åœ¨centos8ä¸Šä½¿èƒ½vca-aå¡</title>
    <url>/posts/dd7abf56.html</url>
    <content><![CDATA[<h2 id="vcaå¡çš„å†…éƒ¨ç»“æ„"><a href="#vcaå¡çš„å†…éƒ¨ç»“æ„" class="headerlink" title="vcaå¡çš„å†…éƒ¨ç»“æ„"></a>vcaå¡çš„å†…éƒ¨ç»“æ„</h2><p><img src="/posts/dd7abf56/image-20210202160154068.png" alt="image-20210202160154068"></p>
<ul>
<li><p>ä¸€å—kabylake CPUï¼Œä¸Šé¢å¸¦ä¸€ä¸ªIntel GFX 610é›†æˆæ˜¾å¡ã€‚</p>
</li>
<li><p>12ä¸ªmovidius VPUï¼š</p>
<ul>
<li>å…¶ä¸­ä¸¤ä¸ªé€šè¿‡USBè¿æ¥åˆ°CPUä¸Š</li>
<li>å‰©ä¸‹çš„10ä¸ªé€šè¿‡PCI-USB bridgeå’ŒCPUé€šä¿¡<ul>
<li>PCI-USB bridge ï¼šThe <strong>ASM1042A</strong> is ASMediaâ€™s new generation of Universal Serial Bus 3.0 extended host controller, bridging PCI Express to two ports of USB3.0</li>
</ul>
</li>
</ul>
</li>
<li><p>ä¸€ä¸ªPCIe switchï¼šä¸ºhostæä¾›NTB</p>
<ul>
<li>NTBï¼ˆNon-Transparent-Bridgeï¼‰</li>
</ul>
</li>
</ul>
<h2 id="Hostä¸Švca-softwareå®‰è£…"><a href="#Hostä¸Švca-softwareå®‰è£…" class="headerlink" title="Hostä¸Švca softwareå®‰è£…"></a>Hostä¸Švca softwareå®‰è£…</h2><p><img src="/posts/dd7abf56/image-20210202162348217.png" alt="image-20210202162348217"></p>
<p>serviceè·‘åœ¨hostä¸Šï¼Œagentå’Œå…¶ä»–çš„workloadéƒ½è·‘åœ¨vcaå¡ä¸Šï¼Œå¡ä¸Šæœ‰ä¸ªå•ç‹¬çš„osï¼Œubuntu1804ã€‚</p>
<h3 id="ä¸‹è½½software-packagesæºç "><a href="#ä¸‹è½½software-packagesæºç " class="headerlink" title="ä¸‹è½½software packagesæºç "></a>ä¸‹è½½software packagesæºç </h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> git <span class="built_in">clone</span> https://github.com/OpenVisualCloud/VCAC-SW-Analytics.git -b release/VCAC-A/R6</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> tree -L 2</span></span><br><span class="line">.</span><br><span class="line">â”œâ”€â”€ Documents                   # å¹³å¹³æ— å¥‡çš„æ–‡æ¡£</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ VCAC-Analytics-releasenotes-rev6-0.pdf</span><br><span class="line">â”‚Â Â  â””â”€â”€ VCAC-Analytics-software-installation-guide-rev6-0.pdf</span><br><span class="line">â”œâ”€â”€ Intel_Media_Analytics_Host  # Host files</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ scripts                 # scripts to build kernel and vca driver module</span><br><span class="line">â”‚Â Â  â””â”€â”€ tar                     # kernel patch, vca driver patch and utilities</span><br><span class="line">â””â”€â”€ Intel_Media_Analytics_Node  # Software packages</span><br><span class="line">    â”œâ”€â”€ scripts                 # scripte to build ubunut1804 image and dockerfiles </span><br><span class="line">    â””â”€â”€ tar                     # patch for kernel on card, install pkg for VPU metrics</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="ä½¿ç”¨dockeråœ¨å®¹å™¨é‡Œbuildå®‰è£…åŒ…"><a href="#ä½¿ç”¨dockeråœ¨å®¹å™¨é‡Œbuildå®‰è£…åŒ…" class="headerlink" title="ä½¿ç”¨dockeråœ¨å®¹å™¨é‡Œbuildå®‰è£…åŒ…"></a>ä½¿ç”¨dockeråœ¨å®¹å™¨é‡Œbuildå®‰è£…åŒ…</h3><p>åœ¨hostä¸Š ç”¨dockerå¯åŠ¨å®¹å™¨ï¼Œå»buildä¸€äº›è½¯ä»¶åŒ…ï¼Œç­‰ç­‰ã€‚</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker info | grep Dir</span></span><br><span class="line">Docker Root Dir: /var/lib/docker</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªdockerç›®å½•æœ€å¤šåªæœ‰50GBï¼Œä¸å¤Ÿå»build vcadï¼Œå¯èƒ½ä¼šæŠ¥é”™<code>&quot;no space left on device&quot; </code>, æ‰€ä»¥æˆ‘ä»¬éœ€è¦æ¢ä¸€ä¸ªDocker Root Dirã€‚</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> vim /usr/lib/systemd/system/docker.service<span class="string">&quot;</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> add <span class="string">&quot;--graph /home/docker&quot;</span> after <span class="string">&quot;ExecStart=/user/bin/dockerd</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat /usr/lib/systemd/system/docker.service | grep graph</span></span><br><span class="line">ExecStart=/usr/bin/dockerd --graph /home/docker -H fd:// --containerd=/run/containerd/containerd.sock</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> é‡å¯</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> systemctl daemon-reload</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> systemctl restart docker</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> å†æŸ¥çœ‹ä¸€ä¸‹ï¼Œå·²ç»æ”¹å¥½äº†</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> docker info  | grep Dir</span></span><br><span class="line">Docker Root Dir: /home/docker</span><br></pre></td></tr></table></figure>


<p>æ‹‰å–centos8çš„image</p>
<p><img src="/posts/dd7abf56/image-20210202170918413.png" alt="image-20210202170918413"></p>
<p>å®‰è£…ä¸€äº›éœ€è¦çš„pkg</p>
<p><img src="/posts/dd7abf56/image-20210202171007593.png" alt="image-20210202171007593"></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[space@inspurserver CentOS8]$ docker ps</span><br><span class="line">CONTAINER ID   IMAGE                      COMMAND                  CREATED              STATUS              PORTS     NAMES</span><br><span class="line">d4ecdebab101   vcaa/centos-8.1-test:1.0   &quot;/home/space/VCAC-SWâ€¦&quot;   About a minute ago   Up About a minute             sleepy_ride</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">pwd</span>: /home/space/VCAC-SW-Analytics/VCAC-A/Intel_Media_Analytics_Host/scripts</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo ./build.sh</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">pwd</span>: /home/space/VCAC-SW-Analytics/VCAC-A/Intel_Media_Analytics_Node/scripts</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo ./vcad_build.sh -o EXTENDED  <span class="comment"># EXTENDEDå¯ä»¥åœ¨ubuntu osé‡Œè£…ä¸Šopenvinoç­‰è½¯ä»¶ã€‚</span></span></span><br></pre></td></tr></table></figure>
<h3 id="å®‰è£…æ–°kernelï¼Œvcaè½¯ä»¶ç­‰"><a href="#å®‰è£…æ–°kernelï¼Œvcaè½¯ä»¶ç­‰" class="headerlink" title="å®‰è£…æ–°kernelï¼Œvcaè½¯ä»¶ç­‰"></a>å®‰è£…æ–°kernelï¼Œvcaè½¯ä»¶ç­‰</h3><p>ç”¨ç”Ÿæˆçš„åŒ…ï¼Œå»æ¢kernelï¼Œå®‰è£…hostä¸Šçš„vca daemonï¼Œvca cliï¼Œ kernelï¼Œ kernel-develç­‰ç­‰ã€‚</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> å®‰è£…kernelåŒ…</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo yum -y localinstall kernel-4.18.0-147_1.fb4dfe2.VCA+-1.x86_64.rpm</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo yum -y localinstall kernel-devel-4.18.0-147_1.fb4dfe2.VCA+-1.x86_64.rpm</span></span><br><span class="line"><span class="meta">#</span><span class="bash">å®‰è£…vca driver module</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo yum -y localinstall vcass-modules-4.18.0-147_1.fb4dfe2.VCA</span></span><br><span class="line">+-1.690990a-0.x86_64.rpm</span><br><span class="line"><span class="meta">#</span><span class="bash"> å®‰è£…vca daemon</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo yum -y localinstall daemon-vca-2.7.3-centos8-x86_64.rpm</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo yum -y localinstall ../../tar/Centos8/vca_query-1.0_centos8-1.x86_64.rpm</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> æ¢default kernelï¼Œå‚è€ƒ https://www.golinuxcloud.com/change-default-kernel-version-rhel-centos-8/</span></span><br><span class="line">sudo grubby --set-default &quot;/boot/vmlinuz-4.18.0.0e222f9.VCA+&quot; </span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> reboot</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo reboot</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> å¼€æœºä¹‹åéªŒè¯kernelæ›´æ¢æˆåŠŸ</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> uname -r</span></span><br><span class="line">4.18.0.0e222f9.VCA+</span><br></pre></td></tr></table></figure>
<h3 id="enable-iommu"><a href="#enable-iommu" class="headerlink" title="enable iommu"></a>enable iommu</h3><p>å…¶å®æˆ‘ä¹‹å‰è®¾ç½®äº†<code>intel_iommu=on </code>ï¼Œä½†æ˜¯ç”±äºæ¢äº†kernelï¼Œä¹‹å‰é‚£ä¸ªkernelçš„cmdlineä¸èµ·ä½œç”¨äº†ã€‚</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> åœ¨è¿™é‡Œé‡æ–°è®¾ç½®ä¸€ä¸‹</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat /boot/grub2/grubenv</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> GRUB Environment Block</span></span><br><span class="line">saved_entry=4f71b0d5929445139ae33f60b7e05767-4.18.0.0e222f9.VCA+</span><br><span class="line">kernelopts=root=LABEL=cloudimg-rootfs ro console=ttyS0,115200n8 no_timer_check net.ifnames=0 crashkernel=auto rd.auto=1 intel_iommu=on</span><br><span class="line">boot_success=1</span><br><span class="line">boot_indeterminate=0</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo reboot</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> ç„¶åå°±å¯ä»¥çœ‹åˆ°ä½¿èƒ½å¥½çš„iommu groupsäº†ï¼</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ls /sys/kernel/iommu_groups/</span></span><br><span class="line">0   11  14  17  2   22  25  28  30  33  36  39  41  44  47  5   52  55  58  60  63  66 </span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">check cmdline</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat /proc/cmdline</span></span><br><span class="line">BOOT_IMAGE=(hd0,gpt1)/boot/vmlinuz-4.18.0.0e222f9.VCA+ root=LABEL=cloudimg-rootfs ro console=ttyS0,115200n8 no_timer_check net.ifnames=0 crashkernel=auto rd.auto=1 intel_iommu=on</span><br></pre></td></tr></table></figure>
<h3 id="éªŒè¯"><a href="#éªŒè¯" class="headerlink" title="éªŒè¯"></a>éªŒè¯</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> æŠ¥é”™ï¼å› ä¸ºä¸æ˜¯rootæƒé™</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> vcactl info BIOS 0 0</span></span><br><span class="line">ERROR: could not parse vca configuration file!</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo su</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> æˆåŠŸï¼</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> vcactl status</span></span><br><span class="line">Card: 0 Cpu: 0  STATE: bios_up</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> æŠ¥é”™ï¼Œè¿™ä¸ªæ—¶å€™ubuntu1804å’Œhostçš„ç½‘ç»œè¿˜æ²¡æœ‰é…ç½®å¥½</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo vcactl network ip</span></span><br><span class="line">ERROR: Card: 0 Cpu: 0 - Card needs to be in &quot;os_ready&quot;, &quot;net_device_ready&quot;, &quot;dhcp_error&quot;, &quot;net_device_no_ip&quot;, &quot;dhcp_in_progress&quot; or &quot;dhcp_done&quot; state!</span><br></pre></td></tr></table></figure>
<h3 id="åœ¨vcaå¡ä¸Šè½½å…¥ubuntu-os"><a href="#åœ¨vcaå¡ä¸Šè½½å…¥ubuntu-os" class="headerlink" title="åœ¨vcaå¡ä¸Šè½½å…¥ubuntu os"></a>åœ¨vcaå¡ä¸Šè½½å…¥ubuntu os</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> å…³é—­å·²æ‰“å¼€çš„å—è®¾å¤‡</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> vcactl blockio close 0 0 vcablk0</span></span><br><span class="line">WARNING: Card: 0 Cpu: 0 - Block device vcablk0 is not open. You do not need to close it.</span><br><span class="line"><span class="meta">#</span><span class="bash"> åœ¨buildå¥½çš„ubuntuçš„imageåŠ è½½è¿›vcaå¡ä¸­</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> vcactl blockio open 0 0 vcablk0 RW /home/space/VCAC-SW-Analytics/VCAC-A/Intel_Media_Analytics_Node/build/vcad/INSTALL/vca_disk48_k5.3_ubuntu18.04_1.0.1.vcad</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">æŸ¥çœ‹</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> vcactl status</span></span><br><span class="line">Card: 0 Cpu: 0  STATE: bios_ready</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> åœ¨bios_readyä¹‹åï¼Œéœ€è¦é‡å¯ä¸€ä¸‹vcaå¡ï¼Œä½¿å…¶ç”Ÿæ•ˆ</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> å…³æœº</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> vcactl pwrbtn-long 0 0</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> vcactl status</span></span><br><span class="line">Card: 0 Cpu: 0  STATE: power_off</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> å¼€æœº</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> vcactl pwrbtn-short 0 0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> vcactl reset 0 0 --force</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> vcactl boot 0 0 vcablk0 --force</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> vcactl status</span></span><br><span class="line">Card: 0 Cpu: 0  STATE: booting</span><br><span class="line"><span class="meta">$</span><span class="bash"> vcactl status</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> vcactl network ip</span></span><br><span class="line">Card 0 Cpu 0:</span><br><span class="line">172.32.1.1</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> å¯†ç æ˜¯vista1</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ssh root@172.32.1.1</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> åˆ°è¿™é‡Œï¼Œvcaå¡çš„osä¹Ÿå®‰è£…å®Œæ¯•äº†ï¼</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>vcaå¡ä¸Šosï¼Œå¯ä»¥å’Œhostç›¸äº’pingé€šï¼Œ</p>
<p>ä½†è¿æ¥ä¸ä¸Šinternetã€‚dnsä¹Ÿæ²¡æœ‰è®¾ç½®å¥½ã€‚</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">root@vca_node_00:~# wget www.baidu.com</span><br><span class="line">--2021-02-02 15:06:13--  http://www.baidu.com/</span><br><span class="line">Resolving www.baidu.com (www.baidu.com)... failed: Temporary failure in name resolution.</span><br><span class="line">wget: unable to resolve host address &#x27;www.baidu.com&#x27;</span><br><span class="line">root@vca_node_00:~# ping baidu.com</span><br><span class="line">ping: baidu.com: Temporary failure in name resolution</span><br></pre></td></tr></table></figure>
<h3 id="vca-amp-host-ç½‘ç»œé…ç½®"><a href="#vca-amp-host-ç½‘ç»œé…ç½®" class="headerlink" title="vca &amp; host ç½‘ç»œé…ç½®"></a>vca &amp; host ç½‘ç»œé…ç½®</h3><p><strong>åœ¨hostä¸Š</strong></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> config proxy</span></span><br><span class="line">touch /etc/yum.repos.d/10proxy</span><br><span class="line">vim 10proxy</span><br><span class="line">Acquire::http::Proxy &quot; local network http proxy &quot;;</span><br><span class="line">scp /etc/yum.repos.d/10proxy root@172.32.1.1:/etc/apt/apt.conf.d/10proxy  </span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> config dns</span></span><br><span class="line">scp /etc/resolv.conf root@172.32.1.1:/etc</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">disable</span> firewall</span></span><br><span class="line">systemctl stop firewalld.service</span><br><span class="line">systemctl disable firewalld.service</span><br><span class="line">systemctl status firewalld.service</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">enable</span> ip forwarding <span class="keyword">in</span> host kernel</span></span><br><span class="line">echo 1 &gt; /proc/sys/net/ipv4/ip_forward</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> add rules to NAT</span></span><br><span class="line">iptables -t nat -A POSTROUTING -s 172.32.1.1 -d 0/0 -j MASQUERADE</span><br></pre></td></tr></table></figure>
<p><strong>åœ¨VCAå¡ä¸Š</strong></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ssh root@172.32.1.1</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> configure proxy</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> hostæ²¡æœ‰proxyçš„æ—¶å€™ï¼Œå¯ä»¥ä¸è®¾ç½®</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> vim ~/.bashrc</span></span><br><span class="line">export https_proxy=&quot; local network https proxy&quot;</span><br><span class="line">export http_proxy=&quot; local network http proxy&quot;</span><br><span class="line">export ftp_proxy=&quot; local network ftp proxy&quot;</span><br></pre></td></tr></table></figure>
<h4 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">wget www.baidu.com</span><br><span class="line">wget www.google.com</span><br></pre></td></tr></table></figure>
<p>VCAå¡åº”è¯¥å’Œhostæœ‰ä¸€æ ·çš„ç½‘ç»œè¿é€šèƒ½åŠ›ã€‚</p>
<h2 id="åœ¨vcaå¡ä¸Šå®‰è£…software"><a href="#åœ¨vcaå¡ä¸Šå®‰è£…software" class="headerlink" title="åœ¨vcaå¡ä¸Šå®‰è£…software"></a>åœ¨vcaå¡ä¸Šå®‰è£…software</h2><p><strong>Load SMBus driver</strong></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> apt update</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> modprobe i2c-i801</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> modprobe i2c-dev</span>  </span><br></pre></td></tr></table></figure>
<p><strong>Load HDDL driver</strong></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> insmod /lib/modules/5.3.18-1.9bf7f75.vca+/kernel/drivers/ion/myd_ion.ko</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> insmod /lib/modules/5.3.18-1.9bf7f75.vca+/kernel/drivers/usb/myd/myd_vsc.ko</span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> lsmod | grep myd</span></span><br><span class="line">myd_vsc                24576  0</span><br><span class="line">myd_ion                49152  0</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>devices</category>
      </categories>
      <tags>
        <tag>device</tag>
        <tag>intel</tag>
      </tags>
  </entry>
  <entry>
    <title>åœ¨centosä¸Šä¿®æ”¹æºå¹¶å®‰è£…docker</title>
    <url>/posts/8d209cf6.html</url>
    <content><![CDATA[<h3 id="ç¯å¢ƒ"><a href="#ç¯å¢ƒ" class="headerlink" title="ç¯å¢ƒ"></a>ç¯å¢ƒ</h3><p>åœ¨macä¸Šç”¨vagrantèµ·äº†ä¸€ä¸ªcentos8çš„vmã€‚</p>
<h3 id="æ¢ç³»ç»Ÿyumæº"><a href="#æ¢ç³»ç»Ÿyumæº" class="headerlink" title="æ¢ç³»ç»Ÿyumæº"></a>æ¢ç³»ç»Ÿyumæº</h3><blockquote>
<p>è¿™é‡Œæ¢çš„æ˜¯æ¸…åçš„æºã€‚</p>
<p> å‚è€ƒï¼š<a href="https://mirrors.tuna.tsinghua.edu.cn/help/centos/">https://mirrors.tuna.tsinghua.edu.cn/help/centos/</a></p>
</blockquote>
<p>å»ºè®®å…ˆå¤‡ä»½ <code>/etc/yum.repos.d/</code> å†…çš„æ–‡ä»¶ï¼ˆCentOS 7 åŠä¹‹å‰ä¸º <code>CentOS-Base.repo</code>ï¼ŒCentOS 8 ä¸º<code>CentOS-Linux-*.repo</code>ï¼‰</p>
<p>ç„¶åç¼–è¾‘ <code>/etc/yum.repos.d/</code> ä¸­çš„ç›¸åº”æ–‡ä»¶ï¼Œåœ¨ <code>mirrorlist=</code> å¼€å¤´è¡Œå‰é¢åŠ  <code>#</code> æ³¨é‡Šæ‰ï¼›å¹¶å°† <code>baseurl=</code> å¼€å¤´è¡Œå–æ¶ˆæ³¨é‡Šï¼ˆå¦‚æœè¢«æ³¨é‡Šçš„è¯ï¼‰ï¼ŒæŠŠè¯¥è¡Œå†…çš„åŸŸåï¼ˆä¾‹å¦‚<code>mirror.centos.org</code>ï¼‰æ›¿æ¢ä¸º <code>mirrors.tuna.tsinghua.edu.cn</code>ã€‚</p>
<p>ä»¥ä¸Šæ­¥éª¤å¯ä»¥è¢«ä¸‹æ–¹çš„å‘½ä»¤ä¸€æ­¥å®Œæˆ</p>
<figure class="highlight coq"><table><tr><td class="code"><pre><span class="line">sudo sed -e &#x27;s|<span class="type">^mirrorlist</span>=|<span class="type">#mirrorlist</span>=|<span class="type">g</span>&#x27; \</span><br><span class="line">         -e &#x27;s|<span class="type">^#baseurl</span>=http://mirror.centos.org|<span class="type">baseurl</span>=https://mirrors.tuna.tsinghua.edu.cn|<span class="type">g</span>&#x27; \</span><br><span class="line">         -i.bak \</span><br><span class="line">         /etc/yum.repos.d/CentOS-*.repo</span><br></pre></td></tr></table></figure>
<p>æ³¨æ„å…¶ä¸­çš„<code>*</code>é€šé…ç¬¦ï¼Œå¦‚æœåªéœ€è¦æ›¿æ¢ä¸€äº›æ–‡ä»¶ä¸­çš„æºï¼Œè¯·è‡ªè¡Œå¢åˆ ã€‚</p>
<p>æ³¨æ„ï¼Œå¦‚æœéœ€è¦å¯ç”¨å…¶ä¸­ä¸€äº› repoï¼Œéœ€è¦å°†å…¶ä¸­çš„ <code>enabled=0</code> æ”¹ä¸º <code>enabled=1</code>ã€‚</p>
<p>æœ€åï¼Œæ›´æ–°è½¯ä»¶åŒ…ç¼“å­˜</p>
<figure class="highlight ebnf"><table><tr><td class="code"><pre><span class="line"><span class="attribute">sudo yum makecache</span></span><br></pre></td></tr></table></figure>
<p>è¿™æ—¶ä¸‹è½½å¸¸ç”¨çš„è½¯ä»¶åŒ…å°±å·²ç»å˜å¿«äº†ã€‚</p>
<h3 id="æ¢ä¸‹è½½dockerçš„æº"><a href="#æ¢ä¸‹è½½dockerçš„æº" class="headerlink" title="æ¢ä¸‹è½½dockerçš„æº"></a>æ¢ä¸‹è½½dockerçš„æº</h3><blockquote>
<p>å‚è€ƒï¼š<a href="https://mirrors.tuna.tsinghua.edu.cn/help/docker-ce/">https://mirrors.tuna.tsinghua.edu.cn/help/docker-ce/</a></p>
</blockquote>
<p>ç„¶åæˆ‘æ ¹æ®dockerçš„å®˜æ–¹æ–‡æ¡£å®‰è£…dockerï¼Œå‘ç°yum install docker-ceçš„æ—¶å€™ç‰¹åˆ«æ…¢ã€‚åŸå› æ˜¯å®˜æ–¹æ–‡æ¡£é…ç½®çš„dockeræºrepoæ˜¯å›½å¤–çš„ï¼Œå›½å¤–è®¿é—®å¾ˆæ…¢ã€‚äºæ˜¯å»ç½‘ä¸Šæ‰¾äº†æ¸…åçš„æºã€‚</p>
<p>å¦‚æœä½ ä¹‹å‰å®‰è£…è¿‡ dockerï¼Œè¯·å…ˆåˆ æ‰</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">sudo yum <span class="builtin-name">remove</span> docker docker-common docker-selinux docker-engine</span><br></pre></td></tr></table></figure>
<p>å®‰è£…ä¸€äº›ä¾èµ–</p>
<figure class="highlight gml"><table><tr><td class="code"><pre><span class="line">sudo yum install -<span class="symbol">y</span> yum-utils device-mapper-<span class="symbol">persistent</span>-data lvm2</span><br></pre></td></tr></table></figure>
<p>æ ¹æ®ä½ çš„å‘è¡Œç‰ˆä¸‹è½½repoæ–‡ä»¶: CentOS/RHEL Fedora</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">wget -O <span class="regexp">/etc/yum</span>.repos.d<span class="regexp">/docker-ce.repo https:/</span><span class="regexp">/download.docker.com/</span>linux<span class="regexp">/centos/</span>docker-ce.repo</span><br></pre></td></tr></table></figure>
<p>æŠŠè½¯ä»¶ä»“åº“åœ°å€æ›¿æ¢ä¸º TUNAï¼Œè¿™ä¸€æ­¥å¾ˆå…³é”®ï¼Œå¤§éƒ¨åˆ†ç½‘ä¸Šçš„åšå®¢éƒ½æ²¡æœ‰æåˆ°ï¼Œå¦‚æœæ²¡æœ‰è¿™ä¸€æ­¥ï¼Œå…¶å®è¿˜æ˜¯ä½¿ç”¨çš„å›½å¤–çš„dockerå®˜æ–¹çš„æº:</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">sudo sed -i <span class="string">&#x27;s+download.docker.com+mirrors.tuna.tsinghua.edu.cn/docker-ce+&#x27;</span> <span class="regexp">/etc/yum</span>.repos.d/docker-ce.repo</span><br></pre></td></tr></table></figure>
<p>æœ€åå®‰è£…:</p>
<figure class="highlight cmake"><table><tr><td class="code"><pre><span class="line">sudo yum makecache</span><br><span class="line">sudo yum <span class="keyword">install</span> docker-ce</span><br></pre></td></tr></table></figure>
<h3 id="æ¢dockeré•œåƒæº"><a href="#æ¢dockeré•œåƒæº" class="headerlink" title="æ¢dockeré•œåƒæº"></a>æ¢dockeré•œåƒæº</h3><p>dockeré»˜è®¤æºåœ¨å›½å¤–ï¼ŒåŒæ ·å¾ˆæ…¢ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¿®æ”¹dockeré…ç½®æ›´æ”¹docker imageçš„æºã€‚</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> æŸ¥çœ‹docker daemon config</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ls /etc/docker/daemon.json</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨å°±åˆ›å»ºä¸€ä¸ª</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo touch /etc/docker/daemon.json</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> vi /etc/docker/daemon.json</span></span><br><span class="line">&#123;</span><br><span class="line">    &quot;registry-mirrors&quot; : [</span><br><span class="line">    &quot;https://registry.docker-cn.com&quot;,</span><br><span class="line">    &quot;https://docker.mirrors.ustc.edu.cn&quot;,</span><br><span class="line">    &quot;http://hub-mirror.c.163.com&quot;,</span><br><span class="line">    &quot;https://cr.console.aliyun.com/&quot;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo systemctl restart docker.service</span></span><br></pre></td></tr></table></figure>


<h3 id="docker-permission-denied"><a href="#docker-permission-denied" class="headerlink" title="docker permission denied"></a>docker permission denied</h3><p>è¿™ä¸ªé—®é¢˜ç‰¹åˆ«å¸¸è§ï¼Œå°±æ˜¯æˆ‘ä»¬åœ¨å®‰è£…å®Œdockerä¹‹åï¼Œå‘ç°dockeræŒ‡ä»¤å¿…é¡»åœ¨rootæƒé™ä¸‹è¿è¡Œï¼Œè¿™æ—¶å› ä¸ºæˆ‘ä»¬å½“å‰çš„ç”¨æˆ·æ²¡æœ‰è¢«åŠ å…¥åˆ°dockerç»„é‡Œã€‚</p>
<h4 id="è§£å†³åŠæ³•"><a href="#è§£å†³åŠæ³•" class="headerlink" title="è§£å†³åŠæ³•"></a>è§£å†³åŠæ³•</h4><p>2.1ã€æ·»åŠ dockerç”¨æˆ·ç»„</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">groupadd docker </span><br><span class="line"><span class="meta">#</span><span class="bash"> ä¸€èˆ¬éƒ½ä¼šæç¤ºdockerç”¨æˆ·ç»„å­˜åœ¨äº†ã€‚</span></span><br></pre></td></tr></table></figure>
<p>2.2ã€æŠŠå½“å‰ç”¨æˆ·åŠ å…¥dockerç”¨æˆ·ç»„</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">gpasswd -a $&#123;USER&#125; docker</span><br><span class="line"><span class="meta">#</span><span class="bash"> æˆ–è€… sudo usermod -aG docker <span class="variable">$&#123;USER&#125;</span> (æœªéªŒè¯)</span></span><br></pre></td></tr></table></figure>
<p>3ã€æŸ¥çœ‹æ˜¯å¦æ·»åŠ æˆåŠŸï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cat /etc/group | grep ^docker</span><br></pre></td></tr></table></figure>
<p>4ã€é‡å¯docker</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">serivce docker restart</span><br></pre></td></tr></table></figure>
<p>5ã€æ›´æ–°ç”¨æˆ·ç»„</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">newgrp docker </span><br></pre></td></tr></table></figure>
<p>6ã€æµ‹è¯•dockerå‘½ä»¤æ˜¯å¦å¯ä»¥ä½¿ç”¨sudoæ­£å¸¸ä½¿ç”¨</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker ps</span><br></pre></td></tr></table></figure>




<h1 id="docker-graphæ˜¯ä»€ä¹ˆä¸œè¥¿å•Š"><a href="#docker-graphæ˜¯ä»€ä¹ˆä¸œè¥¿å•Š" class="headerlink" title="docker graphæ˜¯ä»€ä¹ˆä¸œè¥¿å•Š"></a>docker graphæ˜¯ä»€ä¹ˆä¸œè¥¿å•Š</h1><p>The <code>-g</code> or <code>--graph</code> flag for the <code>dockerd</code> or <code>docker daemon</code> command was used to indicate the directory in which to store persistent data and resource configuration and has been replaced with the more descriptive <code>--data-root</code> flag.</p>
]]></content>
      <categories>
        <category>deploy</category>
      </categories>
      <tags>
        <tag>docker</tag>
        <tag>deploy</tag>
      </tags>
  </entry>
</search>
